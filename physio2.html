<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PhysioCare Management System</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Supabase JS Client -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <!-- Chart.js for Reports -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <!-- Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        .hidden-section { display: none !important; }
        .active-section { display: block; }
        
        /* Sidebar Styling */
        .sidebar-link {
            display: flex;
            align-items: center;
            padding: 0.75rem 1rem;
            color: #4b5563; /* gray-600 */
            border-radius: 0.5rem;
            transition: all 0.2s;
            margin-bottom: 0.25rem;
        }
        .sidebar-link:hover {
            background-color: #f3f4f6; /* gray-100 */
            color: #111827; /* gray-900 */
        }
        .sidebar-link.active {
            background-color: #0f766e; /* teal-700 */
            color: white;
        }
        .sidebar-link i {
            width: 1.5rem;
            margin-right: 0.75rem;
        }

        /* Custom Notification Animations */
        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        @keyframes fadeOut {
            from { opacity: 1; }
            to { opacity: 0; }
        }
        .toast-enter { animation: slideIn 0.3s ease-out forwards; }
        .toast-exit { animation: fadeOut 0.3s ease-out forwards; }
    </style>
</head>
<body class="bg-gray-100 font-sans text-gray-800 relative">

    <!-- NOTIFICATION CONTAINER -->
    <div id="notification-container" class="fixed top-5 right-5 z-[9999] flex flex-col gap-3 pointer-events-none"></div>

    <!-- LOGIN SCREEN -->
    <div id="login-screen" class="min-h-screen flex items-center justify-center bg-blue-50">
        <div class="bg-white p-8 rounded-lg shadow-lg w-full max-w-md">
            <div class="text-center mb-8">
                <i class="fa-solid fa-heart-pulse text-4xl text-teal-700 mb-2"></i>
                <h1 class="text-2xl font-bold text-gray-800">PhysioCare Login</h1>
                <span class="bg-yellow-100 text-yellow-800 text-xs font-semibold px-2.5 py-0.5 rounded">OFFLINE DEMO MODE</span>
            </div>
            
            <form id="login-form" class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700">Email</label>
                    <input type="email" id="email" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm border p-2 focus:border-teal-500 focus:ring-teal-500" value="sarah@physio.com" required>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700">Password</label>
                    <input type="password" id="password" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm border p-2 focus:border-teal-500 focus:ring-teal-500" value="pass123" required>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700">Role</label>
                    <select id="role-select" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm border p-2">
                        <option value="therapist">Therapist</option>
                        <option value="admin">Administrator</option>
                    </select>
                </div>
                <button type="submit" class="w-full bg-teal-700 text-white py-2 px-4 rounded hover:bg-teal-800 transition">Sign In</button>
            </form>
            <div class="mt-4 text-xs text-gray-500 bg-gray-50 p-3 rounded border">
                <p class="font-bold mb-1">Login Credentials:</p>
                <p>Admin: <strong>admin@physio.com</strong> / <strong>admin123</strong></p>
                <p>Therapist: <strong>sarah@physio.com</strong> / <strong>pass123</strong></p>
            </div>
        </div>
    </div>

    <!-- DASHBOARD LAYOUT (Hidden by default) -->
    <div id="dashboard-layout" class="hidden-section min-h-screen flex flex-col md:flex-row">
        
        <!-- Sidebar -->
        <aside class="w-full md:w-64 bg-white shadow-md flex-shrink-0 flex flex-col h-screen">
            <div class="p-6 border-b">
                <h2 class="text-xl font-bold text-teal-700 flex items-center gap-2">
                    <i class="fa-solid fa-user-doctor"></i> PhysioCare
                </h2>
                <p id="user-display" class="text-sm text-gray-500 mt-1">Welcome, User</p>
            </div>
            
            <!-- Scrollable Nav Area -->
            <nav class="p-4 flex-1 overflow-y-auto">
                
                <!-- ADMIN MENU LINKS -->
                <div id="admin-nav" class="hidden-section">
                    <button onclick="window.showSection('admin-dashboard')" class="sidebar-link w-full text-left active" id="nav-dashboard">
                        <i class="fa-solid fa-gauge-high"></i> Dashboard
                    </button>
                    <button onclick="window.showSection('manage-patients')" class="sidebar-link w-full text-left" id="nav-patients">
                        <i class="fa-solid fa-users"></i> Patients
                    </button>
                    <button onclick="window.showSection('manage-appointments')" class="sidebar-link w-full text-left" id="nav-appointments">
                        <i class="fa-solid fa-calendar-check"></i> Appointments
                    </button>
                    <button onclick="window.showSection('manage-therapists')" class="sidebar-link w-full text-left" id="nav-therapists">
                        <i class="fa-solid fa-user-nurse"></i> Physiotherapists
                    </button>
                    <button onclick="window.showSection('manage-users')" class="sidebar-link w-full text-left" id="nav-users">
                        <i class="fa-solid fa-users-gear"></i> Users & Admins
                    </button>
                    <button onclick="window.showSection('manage-exercises')" class="sidebar-link w-full text-left" id="nav-exercises">
                        <i class="fa-solid fa-dumbbell"></i> Exercises
                    </button>
                    <button onclick="window.showSection('manage-complaints')" class="sidebar-link w-full text-left" id="nav-complaints">
                        <i class="fa-solid fa-triangle-exclamation"></i> Complaints
                    </button>
                    <button onclick="window.showSection('manage-reports')" class="sidebar-link w-full text-left" id="nav-reports">
                        <i class="fa-solid fa-chart-pie"></i> Reports
                    </button>
                    <button onclick="window.showSection('settings-page')" class="sidebar-link w-full text-left" id="nav-settings">
                        <i class="fa-solid fa-gear"></i> Settings
                    </button>
                </div>

                <!-- THERAPIST MENU LINKS -->
                <div id="therapist-nav" class="hidden-section">
                    <button onclick="window.showSection('therapist-dashboard')" class="sidebar-link w-full text-left active" id="t-nav-dashboard">
                        <i class="fa-solid fa-gauge-high"></i> Dashboard
                    </button>
                    <button onclick="window.showSection('therapist-patients')" class="sidebar-link w-full text-left" id="t-nav-patients">
                        <i class="fa-solid fa-users"></i> All Patients
                    </button>
                    <button onclick="window.showSection('therapist-schedule')" class="sidebar-link w-full text-left" id="t-nav-schedule">
                        <i class="fa-solid fa-calendar-day"></i> Schedule
                    </button>
                    <button onclick="window.showSection('therapist-exercises')" class="sidebar-link w-full text-left" id="t-nav-exercises">
                        <i class="fa-solid fa-dumbbell"></i> Exercise Library
                    </button>
                    <button onclick="window.showSection('therapist-complaints')" class="sidebar-link w-full text-left" id="t-nav-complaints">
                        <i class="fa-solid fa-triangle-exclamation"></i> Complaints
                    </button>
                </div>
            </nav>

            <div class="p-4 border-t">
                <button onclick="window.logout()" class="w-full text-left px-4 py-2 rounded text-red-600 hover:bg-red-50 flex items-center">
                    <i class="fa-solid fa-sign-out-alt w-6 mr-2"></i> Logout
                </button>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="flex-1 p-6 overflow-y-auto h-screen bg-gray-50">
            
            <!-- ADMIN SECTIONS (Hidden) -->
            <section id="admin-dashboard" class="content-section hidden-section"><h2 class="text-2xl font-bold mb-6">Admin Dashboard</h2><div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8"><div class="bg-white p-6 rounded-lg shadow-sm border-l-4 border-teal-600"><h3 class="text-gray-500 text-sm font-medium">Total Patients</h3><p id="stat-total-patients" class="text-3xl font-bold text-gray-800">0</p></div><div class="bg-white p-6 rounded-lg shadow-sm border-l-4 border-blue-500"><h3 class="text-gray-500 text-sm font-medium">Appointments Today</h3><p id="stat-today-appts" class="text-3xl font-bold text-gray-800">0</p></div></div></section>
            <section id="manage-patients" class="content-section hidden-section"><h2 class="text-2xl font-bold mb-6">Patients</h2><div class="bg-white rounded-lg shadow-sm overflow-hidden border"><table class="min-w-full divide-y divide-gray-200"><tbody id="patients-table-body"></tbody></table></div></section>
            <section id="manage-appointments" class="content-section hidden-section"><h2 class="text-2xl font-bold mb-6">Appointments</h2><div class="bg-white rounded-lg shadow-sm overflow-hidden border"><table class="min-w-full divide-y divide-gray-200"><tbody id="appointments-table-body"></tbody></table></div></section>
            <section id="manage-therapists" class="content-section hidden-section"><h2 class="text-2xl font-bold mb-6">Therapists</h2><div class="bg-white rounded-lg shadow-sm overflow-hidden border"><table class="min-w-full divide-y divide-gray-200"><tbody id="therapists-table-body"></tbody></table></div></section>
            <section id="manage-users" class="content-section hidden-section"><h2 class="text-2xl font-bold mb-6">Users</h2></section>
            <section id="manage-exercises" class="content-section hidden-section"><h2 class="text-2xl font-bold mb-6">Exercises</h2></section>
            <section id="manage-complaints" class="content-section hidden-section"><h2 class="text-2xl font-bold mb-6">Complaints</h2></section>
            <section id="manage-reports" class="content-section hidden-section"><h2 class="text-2xl font-bold mb-6">Reports</h2></section>
            <section id="settings-page" class="content-section hidden-section"><h2 class="text-2xl font-bold mb-6">Settings</h2></section>

            <!-- --- THERAPIST SECTIONS --- -->
            
            <!-- 1. Therapist Dashboard -->
            <section id="therapist-dashboard" class="content-section hidden-section">
                <h2 class="text-2xl font-bold mb-6 text-gray-800">My Dashboard</h2>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                    <div class="bg-white p-6 rounded-lg shadow-sm border-l-4 border-teal-600">
                        <h3 class="text-gray-500 text-sm font-medium">My Patients</h3>
                        <p id="t-stat-patients" class="text-3xl font-bold text-gray-800">0</p>
                    </div>
                    <div class="bg-white p-6 rounded-lg shadow-sm border-l-4 border-blue-500">
                        <h3 class="text-gray-500 text-sm font-medium">Appointments Today</h3>
                        <p id="t-stat-today" class="text-3xl font-bold text-gray-800">0</p>
                    </div>
                    <div class="bg-white p-6 rounded-lg shadow-sm border-l-4 border-orange-500">
                        <h3 class="text-gray-500 text-sm font-medium">Pending Notes</h3>
                        <p class="text-3xl font-bold text-gray-800">1</p>
                    </div>
                </div>
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <div class="bg-white rounded-lg shadow-sm border overflow-hidden">
                        <div class="p-4 border-b bg-gray-50 flex justify-between items-center"><h3 class="font-bold text-gray-800 flex items-center gap-2"><i class="fa-regular fa-calendar text-teal-600"></i> Today's Schedule</h3><button onclick="window.showSection('therapist-schedule')" class="text-xs text-teal-600 hover:underline">View All</button></div>
                        <div id="t-dash-schedule" class="p-4 space-y-3 max-h-80 overflow-y-auto"></div>
                    </div>
                    <div class="bg-white rounded-lg shadow-sm border overflow-hidden">
                        <div class="p-4 border-b bg-gray-50 flex justify-between items-center"><h3 class="font-bold text-gray-800 flex items-center gap-2"><i class="fa-solid fa-users text-blue-600"></i> My Patients</h3><button onclick="window.showSection('therapist-patients')" class="text-xs text-blue-600 hover:underline">View All</button></div>
                        <ul id="t-dash-patients" class="divide-y divide-gray-100 max-h-80 overflow-y-auto"></ul>
                    </div>
                </div>
            </section>

            <!-- 2. Therapist All Patients -->
            <section id="therapist-patients" class="content-section hidden-section">
                <h2 class="text-2xl font-bold mb-6 text-gray-800">My Assigned Patients</h2>
                <div class="bg-white rounded-lg shadow-sm overflow-hidden border">
                    <div class="p-4 border-b bg-gray-50 flex justify-between items-center">
                        <span class="font-medium text-gray-600">Patient List</span>
                        <input type="text" placeholder="Search..." class="border rounded px-3 py-1 text-sm">
                    </div>
                    <ul id="therapist-patient-list" class="divide-y divide-gray-200">
                        <!-- Populated by JS -->
                    </ul>
                </div>
            </section>

            <!-- 3. Therapist Schedule -->
            <section id="therapist-schedule" class="content-section hidden-section">
                <h2 class="text-2xl font-bold mb-6 text-gray-800">My Schedule</h2>
                <div class="bg-white rounded-lg shadow-sm overflow-hidden border">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Time</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Patient</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Notes</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Action</th>
                            </tr>
                        </thead>
                        <tbody id="therapist-schedule-body" class="bg-white divide-y divide-gray-200"></tbody>
                    </table>
                </div>
            </section>

            <!-- 4. Therapist Exercise Library -->
            <section id="therapist-exercises" class="content-section hidden-section">
                <h2 class="text-2xl font-bold mb-6 text-gray-800">Exercise Library</h2>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <div class="bg-white p-4 rounded-lg shadow-sm border hover:shadow-md transition">
                        <div class="h-40 bg-gray-100 rounded mb-3 flex items-center justify-center"><i class="fa-solid fa-person-walking text-gray-400 text-5xl"></i></div>
                        <h3 class="font-bold text-gray-800">Knee Extension</h3>
                        <p class="text-sm text-gray-500 mb-3">Quadriceps strengthening exercise.</p>
                        <button class="text-teal-600 text-sm font-bold hover:underline">View Details</button>
                    </div>
                </div>
            </section>

            <!-- 5. Therapist Complaints -->
            <section id="therapist-complaints" class="content-section hidden-section">
                <h2 class="text-2xl font-bold mb-6 text-gray-800">Complaints & Issues</h2>
                <div class="bg-white p-6 rounded-lg shadow-sm border mb-6">
                    <h3 class="text-lg font-bold mb-4">File a Complaint</h3>
                    <form class="space-y-4">
                        <textarea class="w-full border p-3 rounded-lg focus:ring-2 focus:ring-teal-500" rows="3" placeholder="Describe the issue..."></textarea>
                        <button type="button" class="bg-red-600 text-white px-4 py-2 rounded hover:bg-red-700">Submit Complaint</button>
                    </form>
                </div>
            </section>

        </main>
    </div>

    <!-- MODALS -->

    <!-- Patient File Modal with UPLOAD & PREVIEW -->
    <div id="patient-file-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 hidden-section flex items-center justify-center z-50">
        <div class="bg-white rounded-lg shadow-lg w-full max-w-4xl h-[85vh] flex flex-col">
            <div class="px-6 py-4 border-b flex justify-between items-center bg-gray-50">
                <h3 class="text-xl font-bold text-teal-800">Patient File</h3>
                <button onclick="window.closeModal('patient-file-modal')" class="text-gray-500 hover:text-gray-700 text-2xl">&times;</button>
            </div>
            <div class="p-8 overflow-y-auto flex-1 bg-white">
                
                <!-- Patient Header -->
                <div class="flex items-start gap-6 mb-8 pb-6 border-b">
                    <div class="w-20 h-20 bg-teal-100 rounded-full flex items-center justify-center text-teal-600 text-3xl">
                        <i class="fa-solid fa-user"></i>
                    </div>
                    <div>
                        <h2 class="text-2xl font-bold text-gray-800" id="pf-name">Patient Name</h2>
                        <div class="flex gap-4 mt-2 text-sm text-gray-600">
                            <p><i class="fa-solid fa-cake-candles mr-1"></i> <span id="pf-age">00</span> Years</p>
                            <p><i class="fa-solid fa-phone mr-1"></i> <span id="pf-phone">555-0000</span></p>
                        </div>
                        <p class="mt-2 text-sm"><span class="font-bold text-teal-700">Condition:</span> <span id="pf-condition">N/A</span></p>
                    </div>
                </div>

                <!-- Documents Section -->
                <div class="mb-8">
                    <h3 class="text-lg font-bold text-gray-800 mb-4 flex items-center gap-2">
                        <i class="fa-solid fa-folder-open text-teal-600"></i> Uploaded Documents & X-Rays
                    </h3>
                    
                    <!-- Hidden File Input -->
                    <input type="file" id="therapist-file-upload" class="hidden" onchange="window.handleTherapistUpload(this)">

                    <!-- File Grid -->
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4" id="pf-files-grid">
                        <!-- Files and Upload Button injected here by JS -->
                    </div>
                </div>

                <!-- History Section -->
                <div>
                    <h3 class="text-lg font-bold text-gray-800 mb-4 flex items-center gap-2">
                        <i class="fa-solid fa-file-medical text-teal-600"></i> Medical History
                    </h3>
                    <div class="bg-gray-50 p-4 rounded border text-sm text-gray-700 leading-relaxed">
                        <p>Patient has a history of chronic pain in the specified region. Previous treatments included basic physiotherapy sessions in 2023. No known allergies to medication. Surgical history indicates a minor procedure in 2020.</p>
                    </div>
                </div>

            </div>
            <div class="px-6 py-4 border-t bg-gray-50 flex justify-end">
                <button onclick="window.closeModal('patient-file-modal')" class="bg-teal-700 text-white px-6 py-2 rounded hover:bg-teal-800">Close File</button>
            </div>
        </div>
    </div>

    <!-- NEW: Document Preview Modal -->
    <div id="file-preview-modal" class="fixed inset-0 bg-gray-900 bg-opacity-90 hidden-section flex items-center justify-center z-[60]">
        <div class="bg-white rounded-lg shadow-2xl w-full max-w-3xl h-[80vh] flex flex-col relative">
            <button onclick="window.closeModal('file-preview-modal')" class="absolute top-4 right-4 text-gray-500 hover:text-gray-800 text-3xl z-10">&times;</button>
            
            <div class="p-4 border-b">
                <h3 class="text-lg font-bold text-gray-800" id="preview-filename">Document Preview</h3>
            </div>
            
            <div class="flex-1 bg-gray-100 flex items-center justify-center overflow-hidden p-4">
                <!-- Placeholder for the actual file content -->
                <div class="text-center">
                    <i class="fa-solid fa-file-medical text-6xl text-gray-400 mb-4 block"></i>
                    <p class="text-gray-500 text-lg">Preview Mode</p>
                    <p class="text-xs text-gray-400 mt-2">(In a real app, the image/PDF would render here)</p>
                </div>
            </div>
        </div>
    </div>

    <!-- (Other Modals Hidden) -->
    <div id="add-appointment-modal" class="hidden-section"></div>

    <script>
        // ==========================================
        // UTILS
        // ==========================================
        window.notify = function(message, type = 'info') {
            const container = document.getElementById('notification-container');
            const notif = document.createElement('div');
            let bgClass = 'bg-blue-600';
            if(type === 'error') bgClass = 'bg-red-500';
            if(type === 'success') bgClass = 'bg-green-500';
            notif.className = `${bgClass} text-white px-6 py-3 rounded shadow-lg toast-enter pointer-events-auto flex items-center gap-2`;
            notif.innerHTML = `<span>${message}</span>`;
            container.appendChild(notif);
            setTimeout(() => { notif.classList.remove('toast-enter'); notif.classList.add('toast-exit'); setTimeout(() => notif.remove(), 300); }, 3000);
        };

        window.openModal = function(id) { document.getElementById(id).classList.remove('hidden-section'); };
        window.closeModal = function(id) { document.getElementById(id).classList.add('hidden-section'); };

        window.showSection = function(sectionId) {
            document.querySelectorAll('.content-section').forEach(el => el.classList.add('hidden-section'));
            document.getElementById(sectionId).classList.remove('hidden-section');
            document.querySelectorAll('.sidebar-link').forEach(el => el.classList.remove('active'));
            const btnMap = {
                'admin-dashboard': 'nav-dashboard', 'manage-patients': 'nav-patients', 'manage-appointments': 'nav-appointments', 'manage-therapists': 'nav-therapists', 'manage-users': 'nav-users', 'manage-exercises': 'nav-exercises', 'manage-complaints': 'nav-complaints', 'manage-reports': 'nav-reports', 'settings-page': 'nav-settings',
                'therapist-dashboard': 't-nav-dashboard', 'therapist-patients': 't-nav-patients', 'therapist-schedule': 't-nav-schedule', 'therapist-exercises': 't-nav-exercises', 'therapist-complaints': 't-nav-complaints'
            };
            const btnId = btnMap[sectionId];
            if(btnId) { const btn = document.getElementById(btnId); if(btn) btn.classList.add('active'); }
        };

        window.logout = function() {
            currentUser = null;
            document.getElementById('dashboard-layout').classList.add('hidden-section');
            document.getElementById('login-screen').classList.remove('hidden-section');
            document.getElementById('login-form').reset();
        };

        // ==========================================
        // DATA
        // ==========================================
        let mockPatients = [
            { id: '1', full_name: 'John Doe', age: 45, condition: 'Back Pain', phone: '555-0101', files: ['xray-spine.jpg', 'referral-letter.pdf'] },
            { id: '2', full_name: 'Jane Roe', age: 29, condition: 'ACL Recovery', phone: '555-0102', files: ['mri-knee.png'] },
            { id: '3', full_name: 'Robert Smith', age: 62, condition: 'Arthritis', phone: '555-0103', files: [] }
        ];
        let mockTherapists = [
            { id: '101', full_name: 'Sarah Connor', specialization: 'Sports Rehab', email: 'sarah@physio.com', password: 'pass123', license: 'NHRA-2023-001', shift: 'Morning', work_days: ['Mon','Tue','Wed','Thu','Fri'], work_start: '08:00', work_end: '16:00' },
            { id: '102', full_name: 'Dr. Mike Ross', specialization: 'Neurology', email: 'mike@physio.com', password: 'pass123', license: 'NHRA-2023-055', shift: 'Evening', work_days: ['Sun','Mon','Tue','Wed','Thu'], work_start: '14:00', work_end: '22:00' }
        ];
        let mockAppointments = [
            { id: 'a1', patient_id: '1', therapist_id: '101', date_time: new Date().toISOString(), status: 'Scheduled', notes: 'Initial assessment' },
            { id: 'a2', patient_id: '2', therapist_id: '101', date_time: new Date(Date.now() - 86400000).toISOString(), status: 'Completed', notes: 'Leg exercises' }
        ];

        let currentUser = null; 
        let currentOpenedPatientId = null;

        // ==========================================
        // AUTH
        // ==========================================
        const loginForm = document.getElementById('login-form');
        loginForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            const role = document.getElementById('role-select').value;

            if (role === 'admin' && email === 'admin@physio.com' && password === 'admin123') {
                currentUser = { role: 'admin', name: 'Administrator', id: 'admin-id' };
                window.notify('Welcome Administrator', 'success');
                initDashboard();
            } else if (role === 'therapist') {
                const user = mockTherapists.find(t => t.email === email && t.password === password);
                if (user) {
                    currentUser = { role: 'therapist', name: user.full_name, id: user.id };
                    window.notify(`Welcome ${user.full_name}`, 'success');
                    initDashboard();
                } else { window.notify('Invalid Therapist Credentials', 'error'); }
            } else { window.notify('Invalid Credentials', 'error'); }
        });

        function initDashboard() {
            document.getElementById('login-screen').classList.add('hidden-section');
            document.getElementById('dashboard-layout').classList.remove('hidden-section');
            document.getElementById('user-display').textContent = `Welcome, ${currentUser.name}`;

            if (currentUser.role === 'admin') {
                document.getElementById('admin-nav').classList.remove('hidden-section');
                document.getElementById('therapist-nav').classList.add('hidden-section');
                window.showSection('admin-dashboard');
            } else {
                document.getElementById('admin-nav').classList.add('hidden-section');
                document.getElementById('therapist-nav').classList.remove('hidden-section');
                window.showSection('therapist-dashboard');
                loadTherapistData();
            }
        }

        // ==========================================
        // THERAPIST LOGIC
        // ==========================================
        function loadTherapistData() {
            const myAppts = mockAppointments
                .filter(a => a.therapist_id === currentUser.id)
                .sort((a,b) => new Date(a.date_time) - new Date(b.date_time));

            // Schedule
            const tbody = document.getElementById('therapist-schedule-body');
            tbody.innerHTML = '';
            myAppts.forEach(a => {
                const dateObj = new Date(a.date_time);
                const patient = mockPatients.find(p => p.id === a.patient_id);
                const pName = patient?.full_name || 'Unknown';
                const actionHtml = a.status !== 'Completed' ? `<button onclick="window.completeAppointment('${a.id}')" class="text-green-600 hover:text-green-900 font-bold text-sm">Mark Complete</button>` : '<span class="text-gray-400 text-sm">Completed</span>';
                const tr = `<tr class="border-b hover:bg-gray-50"><td class="px-6 py-4 whitespace-nowrap text-sm text-gray-600">${dateObj.toLocaleString()}</td><td class="px-6 py-4 whitespace-nowrap font-bold text-gray-800">${pName}</td><td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${a.notes || 'No notes'}</td><td class="px-6 py-4 whitespace-nowrap">${actionHtml}</td></tr>`;
                tbody.innerHTML += tr;
            });

            // Patients List
            const pList = document.getElementById('therapist-patient-list');
            const dashPList = document.getElementById('t-dash-patients');
            pList.innerHTML = ''; dashPList.innerHTML = '';
            const uniquePatients = new Set();
            let patientCount = 0;

            myAppts.forEach(a => {
                const patient = mockPatients.find(p => p.id === a.patient_id);
                if(patient && !uniquePatients.has(patient.id)) {
                    uniquePatients.add(patient.id);
                    patientCount++;
                    
                    const liContent = `
                        <div class="flex justify-between items-center w-full">
                            <div>
                                <div class="font-bold text-teal-800">${patient.full_name}</div>
                                <div class="text-sm text-gray-600">Condition: ${patient.condition || 'N/A'}</div>
                            </div>
                            <button onclick="window.openPatientFile('${patient.id}')" class="text-teal-600 text-xs border border-teal-600 px-3 py-1 rounded hover:bg-teal-50 flex items-center gap-1">
                                <i class="fa-solid fa-folder-open"></i> View File
                            </button>
                        </div>
                    `;

                    const li = document.createElement('li'); li.className = 'p-4 hover:bg-gray-50'; li.innerHTML = liContent; pList.appendChild(li);
                    if(patientCount <= 5) { const dashLi = document.createElement('li'); dashLi.className = 'p-3 hover:bg-gray-50'; dashLi.innerHTML = liContent; dashPList.appendChild(dashLi); }
                }
            });

            // Dashboard Schedule Widget
            const dashSchedule = document.getElementById('t-dash-schedule');
            dashSchedule.innerHTML = '';
            const todayStr = new Date().toISOString().split('T')[0];
            const todayAppts = myAppts.filter(a => a.date_time.startsWith(todayStr));

            if(todayAppts.length === 0) {
                dashSchedule.innerHTML = '<p class="text-gray-400 text-sm text-center italic py-4">No appointments scheduled for today.</p>';
            } else {
                todayAppts.forEach(a => {
                    const dateObj = new Date(a.date_time);
                    const patient = mockPatients.find(p => p.id === a.patient_id);
                    const pName = patient?.full_name || 'Unknown';
                    const actionBtn = a.status !== 'Completed' ? `<button onclick="window.completeAppointment('${a.id}')" class="text-xs bg-green-100 text-green-700 px-2 py-1 rounded hover:bg-green-200">Complete</button>` : '<span class="text-xs text-gray-400"><i class="fa-solid fa-check"></i> Done</span>';
                    const item = `<div class="flex items-center justify-between p-3 bg-gray-50 rounded border border-gray-100"><div><p class="text-sm font-bold text-gray-800">${dateObj.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}</p><p class="text-xs text-gray-600">${pName}</p></div>${actionBtn}</div>`;
                    dashSchedule.innerHTML += item;
                });
            }

            document.getElementById('t-stat-patients').innerText = patientCount;
            document.getElementById('t-stat-today').innerText = todayAppts.length;
        }

        // ==========================================
        // PATIENT FILE & UPLOAD LOGIC
        // ==========================================
        window.openPatientFile = function(pid) {
            currentOpenedPatientId = pid;
            const p = mockPatients.find(pat => pat.id === pid);
            if(!p) return;

            document.getElementById('pf-name').innerText = p.full_name;
            document.getElementById('pf-age').innerText = p.age;
            document.getElementById('pf-phone').innerText = p.phone || 'N/A';
            document.getElementById('pf-condition').innerText = p.condition || 'N/A';

            const grid = document.getElementById('pf-files-grid');
            grid.innerHTML = '';

            // 1. Add Upload Card
            const uploadCard = `
                <div onclick="document.getElementById('therapist-file-upload').click()"
                     class="border-2 border-dashed border-teal-300 bg-teal-50 rounded-lg p-4 flex flex-col items-center justify-center cursor-pointer hover:bg-teal-100 transition h-32">
                    <i class="fa-solid fa-cloud-arrow-up text-3xl text-teal-600 mb-2"></i>
                    <span class="text-xs font-bold text-teal-700">Upload New</span>
                </div>
            `;
            grid.innerHTML += uploadCard;

            // 2. Add Existing Files with PREVIEW Click
            if(p.files && p.files.length > 0) {
                p.files.forEach(f => {
                    // Simple icon logic based on extension
                    let iconClass = 'fa-file-image';
                    if(f.endsWith('.pdf')) iconClass = 'fa-file-pdf';
                    
                    const fileCard = `
                        <div onclick="window.previewFile('${f}')" class="border rounded-lg p-3 text-center hover:bg-gray-50 cursor-pointer h-32 flex flex-col items-center justify-center relative group">
                            <i class="fa-solid ${iconClass} text-4xl text-gray-400 mb-2"></i>
                            <p class="text-xs text-gray-600 truncate w-full px-2">${f}</p>
                        </div>
                    `;
                    grid.innerHTML += fileCard;
                });
            }

            window.openModal('patient-file-modal');
        };

        // NEW: Preview File Function
        window.previewFile = function(filename) {
            document.getElementById('preview-filename').innerText = filename;
            window.openModal('file-preview-modal');
        };

        window.handleTherapistUpload = function(input) {
            if(input.files && input.files[0]) {
                const p = mockPatients.find(x => x.id === currentOpenedPatientId);
                if(p) {
                    p.files.push(input.files[0].name);
                    window.notify("Document uploaded successfully", "success");
                    window.openPatientFile(currentOpenedPatientId);
                    input.value = '';
                }
            }
        };

        window.completeAppointment = function(id) {
            const appt = mockAppointments.find(a => a.id === id);
            if(appt) {
                appt.status = 'Completed';
                window.notify('Appointment marked as complete', 'success');
                loadTherapistData();
            }
        };

    </script>
</body>
</html>
