<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PhysioTech - Physiotherapy Management</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://unpkg.com/docx@7.8.2/build/index.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        primary: '#0F766E',
                        secondary: '#0D9488',
                        medical: '#2C7A7B',
                        sage: '#10B981',
                    }
                }
            }
        }
    </script>
    <style>
        .fade-in {
            animation: fadeIn 0.3s ease-in;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .loading {
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-white dark:bg-gray-900 text-gray-900 dark:text-white min-h-screen">
    <!-- User Type Selection -->
    <div id="userTypeSelection" class="min-h-screen flex items-center justify-center relative overflow-hidden bg-gradient-to-br from-slate-50 to-cyan-50">
        <!-- Background Pattern -->
        <div class="absolute inset-0 opacity-8">
            <div class="absolute top-20 left-20 w-96 h-96 bg-primary rounded-full blur-3xl"></div>
            <div class="absolute bottom-20 right-20 w-96 h-96 bg-sage rounded-full blur-3xl"></div>
            <div class="absolute top-1/2 left-1/2 w-64 h-64 bg-medical rounded-full blur-2xl transform -translate-x-1/2 -translate-y-1/2"></div>
        </div>

        <div class="max-w-4xl mx-4 bg-white rounded-3xl shadow-2xl overflow-hidden relative z-10">
            <div class="p-8 lg:p-12 text-center">
                <!-- Logo and Title -->
                <div class="mb-8">
                    <div class="inline-flex items-center justify-center w-24 h-24 bg-white rounded-2xl mb-6 shadow-lg border-2 border-gray-100">
                        <img src="https://pfst.cf2.poecdn.net/base/image/8b6401e48101612f660ccec8b51614f103f2770892e0de9e4ad8f101949526a1?w=225&h=225" 
                             alt="Bahrain Mobility International" 
                             class="w-20 h-20 object-contain rounded-xl">
                    </div>
                    <h1 class="text-4xl font-bold text-gray-900 mb-2">Welcome to PhysioTech</h1>
                    <p class="text-gray-600">Choose your login type</p>
                </div>

                <!-- Login Type Cards -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 max-w-2xl mx-auto">
                    <!-- Admin Login -->
                    <button id="adminLoginBtn" class="group p-8 border-2 border-gray-200 rounded-2xl hover:border-primary hover:shadow-lg transition-all duration-200">
                        <div class="w-16 h-16 bg-primary bg-opacity-10 rounded-xl flex items-center justify-center mx-auto mb-4 group-hover:bg-opacity-20 transition-colors">
                            <i class="fas fa-user-shield text-3xl text-primary"></i>
                        </div>
                        <h3 class="text-xl font-semibold text-gray-900 mb-2">Administrator</h3>
                        <p class="text-gray-600">Access admin dashboard and manage the system</p>
                    </button>

                    <!-- Physiotherapist Login -->
                    <button id="physioLoginBtn" class="group p-8 border-2 border-gray-200 rounded-2xl hover:border-secondary hover:shadow-lg transition-all duration-200">
                        <div class="w-16 h-16 bg-secondary bg-opacity-10 rounded-xl flex items-center justify-center mx-auto mb-4 group-hover:bg-opacity-20 transition-colors">
                            <i class="fas fa-user-md text-3xl text-secondary"></i>
                        </div>
                        <h3 class="text-xl font-semibold text-gray-900 mb-2">Physiotherapist</h3>
                        <p class="text-gray-600">Access your schedule and patient information</p>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Admin Login Page -->
    <div id="adminLoginPage" class="hidden min-h-screen flex items-center justify-center relative overflow-hidden bg-gradient-to-br from-slate-50 to-cyan-50">
        <div class="flex w-full max-w-6xl mx-4 bg-white rounded-3xl shadow-2xl overflow-hidden relative z-10">
            <!-- Left Side - Login Form -->
            <div class="w-full lg:w-1/2 p-8 lg:p-12">
                <div class="max-w-md mx-auto">
                    <!-- Logo and Title -->
                    <div class="text-center mb-8">
                        <div class="inline-flex items-center justify-center w-24 h-24 bg-white rounded-2xl mb-6 shadow-lg border-2 border-gray-100">
                            <img src="https://pfst.cf2.poecdn.net/base/image/8b6401e48101612f660ccec8b51614f103f2770892e0de9e4ad8f101949526a1?w=225&h=225" 
                                 alt="Bahrain Mobility International" 
                                 class="w-20 h-20 object-contain rounded-xl">
                        </div>
                        <h1 class="text-4xl font-bold text-gray-900 mb-2">Admin Login</h1>
                        <p class="text-gray-600">Welcome back to Bahrain Mobility International</p>
                    </div>

                    <form id="loginForm" class="space-y-6">
                        <div>
                            <label for="loginEmail" class="block text-sm font-semibold text-gray-700 mb-3">Email</label>
                            <div class="relative">
                                <input type="email" 
                                       id="loginEmail" 
                                       name="email"
                                       required 
                                       autocomplete="email"
                                       placeholder="Enter your email address"
                                       class="w-full px-4 py-4 pl-12 border-2 border-gray-200 rounded-xl bg-white text-gray-900 text-base focus:ring-2 focus:ring-primary focus:border-primary focus:outline-none transition-colors z-10 relative">
                                <i class="fas fa-envelope absolute left-4 top-5 text-gray-400 pointer-events-none z-0"></i>
                            </div>
                        </div>

                        <div>
                            <label for="loginPassword" class="block text-sm font-semibold text-gray-700 mb-3">Password</label>
                            <div class="relative">
                                <input type="password" 
                                       id="loginPassword" 
                                       name="password"
                                       required 
                                       autocomplete="current-password"
                                       placeholder="Enter your password"
                                       class="w-full px-4 py-4 pl-12 pr-12 border-2 border-gray-200 rounded-xl bg-white text-gray-900 text-base focus:ring-2 focus:ring-primary focus:border-primary focus:outline-none transition-colors z-10 relative">
                                <i class="fas fa-lock absolute left-4 top-5 text-gray-400 pointer-events-none z-0"></i>
                                <button type="button" id="togglePassword" class="absolute right-4 top-5 text-gray-400 hover:text-gray-600 focus:outline-none z-20">
                                    <i class="fas fa-eye"></i>
                                </button>
                            </div>
                        </div>

                        <button type="submit" class="w-full bg-gradient-to-r from-primary to-secondary text-white py-4 px-4 rounded-xl hover:from-secondary hover:to-medical transition-all duration-200 font-semibold text-lg shadow-lg">
                            Log In
                        </button>

                        <div id="loginError" class="hidden bg-red-50 border border-red-200 text-red-700 px-4 py-3 rounded-xl text-sm">
                        </div>
                    </form>

                    <div class="mt-8 text-center">
                        <button id="backToSelectionFromAdmin" class="text-primary hover:text-secondary font-medium">‚Üê Back to login selection</button>
                    </div>
                </div>
            </div>

            <!-- Right Side - Visual -->
            <div class="hidden lg:flex lg:w-1/2 bg-gradient-to-br from-primary via-secondary to-sage items-center justify-center p-12 relative">
                <div class="text-center text-white z-10">
                    <h2 class="text-4xl font-bold mb-6">Welcome to PhysioTech</h2>
                    <p class="text-xl text-white text-opacity-90 mb-8 leading-relaxed">
                        Professional physiotherapy management system for modern healthcare providers
                    </p>
                </div>
            </div>
        </div>
    </div>

    <!-- Physiotherapist Login Page -->
    <div id="physioLoginPage" class="hidden min-h-screen flex items-center justify-center relative overflow-hidden bg-gradient-to-br from-teal-50 to-emerald-50">
        <div class="flex w-full max-w-5xl mx-4 bg-white rounded-3xl shadow-2xl overflow-hidden relative z-10">
            <!-- Left Side - Visual -->
            <div class="hidden lg:flex lg:w-1/2 bg-gradient-to-br from-secondary via-sage to-primary items-center justify-center p-12 relative">
                <div class="text-center text-white z-10">
                    <div class="w-24 h-24 bg-white bg-opacity-20 rounded-2xl flex items-center justify-center mx-auto mb-6">
                        <i class="fas fa-user-md text-4xl"></i>
                    </div>
                    <h2 class="text-4xl font-bold mb-6">Physiotherapist Portal</h2>
                    <p class="text-xl text-white text-opacity-90 mb-8 leading-relaxed">
                        Access your schedule, patient information, and treatment tools
                    </p>
                </div>
            </div>

            <!-- Right Side - Login Form -->
            <div class="w-full lg:w-1/2 p-8 lg:p-12">
                <div class="max-w-md mx-auto">
                    <!-- Back Button -->
                    <button id="backToSelection" class="mb-6 text-gray-600 hover:text-gray-800 flex items-center">
                        <i class="fas fa-arrow-left mr-2"></i>
                        <span>Back to login selection</span>
                    </button>

                    <!-- Logo and Title -->
                    <div class="text-center mb-8">
                        <div class="inline-flex items-center justify-center w-20 h-20 bg-secondary bg-opacity-10 rounded-2xl mb-6">
                            <i class="fas fa-user-md text-3xl text-secondary"></i>
                        </div>
                        <h1 class="text-4xl font-bold text-gray-900 mb-2">Physiotherapist Login</h1>
                        <p class="text-gray-600">Enter your credentials to access your dashboard</p>
                    </div>

                    <form id="physioLoginForm" class="space-y-6">
                        <div>
                            <label for="physioLoginEmail" class="block text-sm font-semibold text-gray-700 mb-3">Email</label>
                            <div class="relative">
                                <input type="email" 
                                       id="physioLoginEmail" 
                                       name="email"
                                       required 
                                       autocomplete="email"
                                       placeholder="Enter your email address"
                                       class="w-full px-4 py-4 pl-12 border-2 border-gray-200 rounded-xl bg-white text-gray-900 text-base focus:ring-2 focus:ring-secondary focus:border-secondary focus:outline-none transition-colors z-10 relative">
                                <i class="fas fa-envelope absolute left-4 top-5 text-gray-400 pointer-events-none z-0"></i>
                            </div>
                        </div>

                        <div>
                            <label for="physioLoginPassword" class="block text-sm font-semibold text-gray-700 mb-3">Password</label>
                            <div class="relative">
                                <input type="password" 
                                       id="physioLoginPassword" 
                                       name="password"
                                       required 
                                       autocomplete="current-password"
                                       placeholder="Enter your password"
                                       class="w-full px-4 py-4 pl-12 pr-12 border-2 border-gray-200 rounded-xl bg-white text-gray-900 text-base focus:ring-2 focus:ring-secondary focus:border-secondary focus:outline-none transition-colors z-10 relative">
                                <i class="fas fa-lock absolute left-4 top-5 text-gray-400 pointer-events-none z-0"></i>
                                <button type="button" id="togglePhysioPassword" class="absolute right-4 top-5 text-gray-400 hover:text-gray-600 focus:outline-none z-20">
                                    <i class="fas fa-eye"></i>
                                </button>
                            </div>
                        </div>

                        <button type="submit" class="w-full bg-gradient-to-r from-secondary to-sage text-white py-4 px-4 rounded-xl hover:from-sage hover:to-primary transition-all duration-200 font-semibold text-lg shadow-lg">
                            <i class="fas fa-sign-in-alt mr-2"></i>Log In
                        </button>

                        <div id="physioLoginError" class="hidden bg-red-50 border border-red-200 text-red-700 px-4 py-3 rounded-xl text-sm">
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Admin Dashboard -->
    <div id="mainApp" class="hidden">
        <!-- Navigation -->
        <nav class="bg-primary shadow-lg fixed top-0 left-0 right-0 z-50">
            <div class="max-w-7xl mx-auto px-2 sm:px-4 lg:px-6">
                <div class="flex justify-between h-16">
                    <div class="flex items-center">
                        <i class="fas fa-heartbeat text-white text-2xl mr-3"></i>
                        <span class="text-white text-xl font-bold">PhysioTech - Admin</span>
                    </div>
                    <div class="flex items-center space-x-4">
                        <div class="flex items-center space-x-3 text-white">
                            <div class="w-8 h-8 bg-white bg-opacity-20 rounded-full flex items-center justify-center">
                                <i class="fas fa-user text-sm"></i>
                            </div>
                            <div class="hidden md:block">
                                <p class="text-sm font-medium" id="userEmail">Admin User</p>
                                <p class="text-xs text-gray-200">Administrator</p>
                            </div>
                        </div>
                        
                        <button id="connectSupabase" class="bg-white text-primary px-4 py-3 rounded-lg hover:bg-gray-100 transition-colors">
                            <i class="fas fa-database mr-2"></i>Connect Supabase
                        </button>
                        <div id="connectionStatus" class="text-white">
                            <i class="fas fa-circle text-red-400 mr-1"></i>Disconnected
                        </div>
                        
                        <button id="logoutBtn" class="bg-red-500 text-white px-4 py-3 rounded-lg hover:bg-red-600 transition-colors">
                            <i class="fas fa-sign-out-alt mr-2"></i>Logout
                        </button>
                    </div>
                </div>
            </div>
        </nav>

        <div class="flex">
            <!-- Sidebar -->
            <div class="w-64 bg-gray-50 dark:bg-gray-800 min-h-screen p-4 fixed left-0 top-16 bottom-0 overflow-y-auto z-40">
                <nav class="space-y-2">
                    <button class="nav-btn w-full text-left p-3 rounded-lg hover:bg-gray-200 dark:hover:bg-gray-700 transition-colors bg-primary text-white" data-view="dashboard">
                        <i class="fas fa-tachometer-alt mr-3"></i>Dashboard
                    </button>
                    <button class="nav-btn w-full text-left p-3 rounded-lg hover:bg-gray-200 dark:hover:bg-gray-700 transition-colors" data-view="patients">
                        <i class="fas fa-users mr-3"></i>Patients
                    </button>
                    <button class="nav-btn w-full text-left p-3 rounded-lg hover:bg-gray-200 dark:hover:bg-gray-700 transition-colors" data-view="appointments">
                        <i class="fas fa-calendar mr-3"></i>Appointments
                    </button>
                    <button class="nav-btn w-full text-left p-3 rounded-lg hover:bg-gray-200 dark:hover:bg-gray-700 transition-colors" data-view="physiotherapists">
                        <i class="fas fa-user-md mr-3"></i>Physiotherapists
                    </button>
                    <button class="nav-btn w-full text-left p-3 rounded-lg hover:bg-gray-200 dark:hover:bg-gray-700 transition-colors" data-view="users">
                        <i class="fas fa-users-cog mr-3"></i>Users & Admins
                    </button>
                    <button class="nav-btn w-full text-left p-3 rounded-lg hover:bg-gray-200 dark:hover:bg-gray-700 transition-colors" data-view="exercises">
                        <i class="fas fa-dumbbell mr-3"></i>Exercises
                    </button>
                    <button class="nav-btn w-full text-left p-3 rounded-lg hover:bg-gray-200 dark:hover:bg-gray-700 transition-colors" data-view="reports">
                        <i class="fas fa-chart-bar mr-3"></i>Reports
                    </button>
                    <button class="nav-btn w-full text-left p-3 rounded-lg hover:bg-gray-200 dark:hover:bg-gray-700 transition-colors" data-view="settings">
                        <i class="fas fa-cog mr-3"></i>System Settings
                    </button>
                </nav>
            </div>

            <!-- Main Content -->
            <div class="flex-1 ml-64 p-6 min-h-screen">
                <!-- Dashboard View -->
                <div id="dashboard" class="view">
                    <h1 class="text-3xl font-bold mb-6">Admin Dashboard</h1>
                    
                    <!-- Stats Cards -->
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                        <div class="bg-gradient-to-r from-blue-500 to-blue-600 text-white p-6 rounded-lg shadow-lg">
                            <div class="flex items-center justify-between">
                                <div>
                                    <p class="text-blue-100">Total Patients</p>
                                    <p class="text-3xl font-bold" id="totalPatients">15</p>
                                </div>
                                <i class="fas fa-users text-4xl text-blue-200"></i>
                            </div>
                        </div>
                        <div class="bg-gradient-to-r from-green-500 to-green-600 text-white p-6 rounded-lg shadow-lg">
                            <div class="flex items-center justify-between">
                                <div>
                                    <p class="text-green-100">Appointments Today</p>
                                    <p class="text-3xl font-bold" id="appointmentsToday">8</p>
                                </div>
                                <i class="fas fa-calendar-day text-4xl text-green-200"></i>
                            </div>
                        </div>
                        <div class="bg-gradient-to-r from-purple-500 to-purple-600 text-white p-6 rounded-lg shadow-lg">
                            <div class="flex items-center justify-between">
                                <div>
                                    <p class="text-purple-100">Active Treatments</p>
                                    <p class="text-3xl font-bold" id="activeTreatments">25</p>
                                </div>
                                <i class="fas fa-stethoscope text-4xl text-purple-200"></i>
                            </div>
                        </div>
                        <div class="bg-gradient-to-r from-orange-500 to-orange-600 text-white p-6 rounded-lg shadow-lg">
                            <div class="flex items-center justify-between">
                                <div>
                                    <p class="text-orange-100">Revenue (Month)</p>
                                    <p class="text-3xl font-bold" id="monthlyRevenue">$12,450</p>
                                </div>
                                <i class="fas fa-dollar-sign text-4xl text-orange-200"></i>
                            </div>
                        </div>
                    </div>

                    <!-- Quick Actions -->
                    <div class="bg-white dark:bg-gray-800 rounded-lg shadow-lg p-6">
                        <h3 class="text-xl font-semibold mb-4">Quick Actions</h3>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                            <button id="quickAddPatient" class="flex items-center p-4 bg-blue-50 dark:bg-blue-900/20 rounded-lg hover:bg-blue-100 dark:hover:bg-blue-900/30 transition-colors">
                                <i class="fas fa-user-plus text-blue-600 text-2xl mr-4"></i>
                                <div class="text-left">
                                    <p class="font-semibold text-blue-900 dark:text-blue-100">Add Patient</p>
                                    <p class="text-sm text-blue-600 dark:text-blue-300">Register new patient</p>
                                </div>
                            </button>
                            <button id="quickScheduleAppointment" class="flex items-center p-4 bg-green-50 dark:bg-green-900/20 rounded-lg hover:bg-green-100 dark:hover:bg-green-900/30 transition-colors">
                                <i class="fas fa-calendar-plus text-green-600 text-2xl mr-4"></i>
                                <div class="text-left">
                                    <p class="font-semibold text-green-900 dark:text-green-100">Schedule Appointment</p>
                                    <p class="text-sm text-green-600 dark:text-green-300">Book new appointment</p>
                                </div>
                            </button>
                            <button id="quickAddPhysiotherapist" class="flex items-center p-4 bg-purple-50 dark:bg-purple-900/20 rounded-lg hover:bg-purple-100 dark:hover:bg-purple-900/30 transition-colors">
                                <i class="fas fa-user-md text-purple-600 text-2xl mr-4"></i>
                                <div class="text-left">
                                    <p class="font-semibold text-purple-900 dark:text-purple-100">Add Physiotherapist</p>
                                    <p class="text-sm text-purple-600 dark:text-purple-300">Add new staff member</p>
                                </div>
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Patients View -->
                <div id="patients" class="view hidden">
                    <!-- Page Header -->
                    <div class="flex justify-between items-center mb-6">
                        <h1 class="text-3xl font-bold text-gray-900 dark:text-white">Patient Management</h1>
                        <div class="flex items-center text-sm text-gray-600 dark:text-gray-400">
                            <i class="fas fa-users mr-2"></i>
                            <span id="patientCount">Total: 1 patient</span>
                        </div>
                    </div>

                    <!-- Action Bar with Search and Buttons -->
                    <div class="bg-white dark:bg-gray-800 rounded-lg shadow-lg p-6 mb-6">
                        <div class="flex flex-col lg:flex-row gap-4 items-start lg:items-center">
                            <!-- Search Section -->
                            <div class="flex-1 w-full lg:w-auto">
                                <div class="relative">
                                    <input type="text" id="patientSearchInput" placeholder="Search patients by name, email, phone, or CPR number..." 
                                           class="w-full px-4 py-3 pl-12 pr-4 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-base focus:ring-2 focus:ring-primary focus:border-primary">
                                    <i class="fas fa-search absolute left-4 top-4 text-gray-400"></i>
                                </div>
                            </div>
                            
                            <!-- Filters and Actions -->
                            <div class="flex flex-col sm:flex-row gap-3 w-full lg:w-auto">
                                <!-- Status Filter -->
                                <select id="patientStatusFilter" class="px-4 py-3 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-base focus:ring-2 focus:ring-primary focus:border-primary">
                                    <option value="">All Status</option>
                                    <option value="active">Active Patients</option>
                                    <option value="inactive">Inactive Patients</option>
                                    <option value="new">New Patients</option>
                                </select>
                                
                                <!-- Clear Filters -->
                                <button id="clearFiltersBtn" class="px-4 py-3 text-gray-600 dark:text-gray-400 hover:text-gray-800 dark:hover:text-gray-200 border border-gray-300 dark:border-gray-600 rounded-lg hover:bg-gray-50 dark:hover:bg-gray-700 transition-colors">
                                    <i class="fas fa-times mr-2"></i>Clear Filters
                                </button>
                                
                                <!-- Action Buttons -->
                                <div class="flex gap-2">
                                    <button id="importPatientsBtn" class="bg-gray-600 text-white px-4 py-3 rounded-lg hover:bg-gray-700 transition-colors flex items-center">
                                        <i class="fas fa-upload mr-2"></i>Import
                                    </button>
                                    <button id="addPatientBtn" class="bg-primary text-white px-6 py-3 rounded-lg hover:bg-secondary transition-colors font-semibold flex items-center shadow-lg">
                                        <i class="fas fa-user-plus mr-2"></i>Add New Patient
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Patients Grid -->
                    <div id="patientsGrid">
                        <!-- No Database Connection State -->
                        <div id="noDatabaseConnection" class="hidden text-center py-12">
                            <div class="max-w-md mx-auto">
                                <i class="fas fa-database text-gray-300 dark:text-gray-600 text-6xl mb-4"></i>
                                <h3 class="text-xl font-semibold text-gray-600 dark:text-gray-400 mb-2">No Database Connection</h3>
                                <p class="text-gray-500 dark:text-gray-500 mb-6">Connect to Supabase to view and manage patients from your database.</p>
                                <button onclick="showSupabaseConnectionModal()" class="bg-primary text-white px-6 py-3 rounded-lg hover:bg-secondary transition-colors font-semibold">
                                    <i class="fas fa-plug mr-2"></i>Connect Database
                                </button>
                            </div>
                        </div>
                        
                        <!-- Connected but Empty Database State -->
                        <div id="connectedEmptyDatabase" class="hidden text-center py-12">
                            <div class="max-w-md mx-auto">
                                <i class="fas fa-database text-green-500 text-6xl mb-4"></i>
                                <h3 class="text-xl font-semibold text-green-600 dark:text-green-400 mb-2">‚úÖ Database Connected Successfully!</h3>
                                <p class="text-gray-600 dark:text-gray-400 mb-6">Your Supabase database is connected and ready. Add your first patient to get started or import existing patient data.</p>
                                
                                <div class="flex flex-col sm:flex-row gap-3 justify-center">
                                    <button onclick="showAddPatientModal()" class="bg-primary text-white px-6 py-3 rounded-lg hover:bg-secondary transition-colors font-semibold">
                                        <i class="fas fa-user-plus mr-2"></i>Add First Patient
                                    </button>
                                    <button onclick="importPatientsDemo()" class="bg-blue-600 text-white px-6 py-3 rounded-lg hover:bg-blue-700 transition-colors font-semibold">
                                        <i class="fas fa-download mr-2"></i>Import Sample Data
                                    </button>
                                </div>
                                
                                <div class="bg-blue-50 dark:bg-blue-900/20 border border-blue-200 dark:border-blue-800 rounded-lg p-4 mt-6">
                                    <div class="flex items-start">
                                        <i class="fas fa-info-circle text-blue-600 mr-3 mt-0.5"></i>
                                        <div class="text-left">
                                            <h4 class="font-semibold text-blue-900 dark:text-blue-100 mb-1">Database Status</h4>
                                            <p class="text-sm text-blue-800 dark:text-blue-200">
                                                Your database tables are ready. As you add patients, they will be automatically saved and synchronized with your Supabase database.
                                            </p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Clean Patient Grid - No Sample Data -->
                        <div id="demoPatientGrid" class="hidden">
                            <!-- No default data - completely clean -->
                        </div>
                        
                        <!-- Loading State -->
                        <div id="patientsLoading" class="hidden text-center py-12">
                            <div class="max-w-md mx-auto">
                                <i class="fas fa-spinner fa-spin text-primary text-4xl mb-4"></i>
                                <h3 class="text-lg font-semibold text-gray-700 dark:text-gray-300 mb-2">Loading Patients</h3>
                                <p class="text-gray-500 dark:text-gray-500">Fetching patient data from your database...</p>
                            </div>
                        </div>
                        
                        <!-- Empty Database State -->
                        <div id="noPatientsFound" class="hidden text-center py-12">
                            <div class="max-w-md mx-auto">
                                <i class="fas fa-users text-gray-300 dark:text-gray-600 text-6xl mb-4"></i>
                                <h3 class="text-xl font-semibold text-gray-600 dark:text-gray-400 mb-2">No Patients Yet</h3>
                                <p class="text-gray-500 dark:text-gray-500 mb-6">Your database is connected but contains no patients. Add your first patient to get started.</p>
                                <button onclick="showAddPatientModal()" class="bg-primary text-white px-6 py-3 rounded-lg hover:bg-secondary transition-colors font-semibold">
                                    <i class="fas fa-user-plus mr-2"></i>Add First Patient
                                </button>
                            </div>
                        </div>
                        
                        <!-- Real Patients Grid Container -->
                        <div id="patientsGridContainer" class="hidden grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                            <!-- Real patients from Supabase will be loaded here -->
                        </div>
                    </div>
                </div>

                <!-- Appointments View -->
                <div id="appointments" class="view hidden">
                    <!-- Page Header -->
                    <div class="flex justify-between items-center mb-6">
                        <h1 class="text-3xl font-bold text-gray-900 dark:text-white">Appointment Management</h1>
                        <div class="flex items-center text-sm text-gray-600 dark:text-gray-400">
                            <i class="fas fa-calendar-alt mr-2"></i>
                            <span id="appointmentCount">Today: 3 appointments</span>
                        </div>
                    </div>

                    <!-- Action Bar -->
                    <div class="bg-white dark:bg-gray-800 rounded-lg shadow-lg p-6 mb-6">
                        <div class="flex flex-col lg:flex-row gap-4 items-start lg:items-center">
                            <!-- Date and Filter Section -->
                            <div class="flex-1 w-full lg:w-auto">
                                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                    <div>
                                        <label class="block text-sm font-medium mb-2">Date</label>
                                        <input type="date" id="appointmentDateFilter" 
                                               class="w-full px-4 py-3 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-base focus:ring-2 focus:ring-primary focus:border-primary">
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium mb-2">Physiotherapist</label>
                                        <select id="appointmentPhysioFilter" 
                                                class="w-full px-4 py-3 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-base focus:ring-2 focus:ring-primary focus:border-primary">
                                            <option value="">All Physiotherapists</option>
                                            <option value="mariam-physio-001">Dr. Mariam Abdulatheem Ali</option>
                                            <option value="dhari-physio-001">Dr. Dhari Fakhroo</option>
                                        </select>
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium mb-2">Status</label>
                                        <select id="appointmentStatusFilter" 
                                                class="w-full px-4 py-3 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-base focus:ring-2 focus:ring-primary focus:border-primary">
                                            <option value="">All Status</option>
                                            <option value="scheduled">Scheduled</option>
                                            <option value="completed">Completed</option>
                                            <option value="cancelled">Cancelled</option>
                                            <option value="no-show">No Show</option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Action Buttons -->
                            <div class="flex flex-col sm:flex-row gap-3 w-full lg:w-auto">
                                <button id="refreshAppointmentsBtn" class="bg-gray-600 text-white px-4 py-3 rounded-lg hover:bg-gray-700 transition-colors flex items-center">
                                    <i class="fas fa-sync-alt mr-2"></i>Refresh
                                </button>
                                <button id="exportAppointmentsBtn" class="bg-blue-600 text-white px-4 py-3 rounded-lg hover:bg-blue-700 transition-colors flex items-center">
                                    <i class="fas fa-download mr-2"></i>Export
                                </button>
                                <button id="addAppointmentBtn" class="bg-primary text-white px-6 py-3 rounded-lg hover:bg-secondary transition-colors font-semibold flex items-center shadow-lg">
                                    <i class="fas fa-calendar-plus mr-2"></i>Schedule New Appointment
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Quick Stats -->
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-6">
                        <div class="bg-gradient-to-r from-blue-500 to-blue-600 text-white p-4 rounded-lg shadow-lg">
                            <div class="flex items-center justify-between">
                                <div>
                                    <p class="text-blue-100 text-sm">Today</p>
                                    <p class="text-2xl font-bold" id="appointmentsTodayTotal">3</p>
                                </div>
                                <i class="fas fa-calendar-day text-2xl text-blue-200"></i>
                            </div>
                        </div>
                        <div class="bg-gradient-to-r from-green-500 to-green-600 text-white p-4 rounded-lg shadow-lg">
                            <div class="flex items-center justify-between">
                                <div>
                                    <p class="text-green-100 text-sm">This Week</p>
                                    <p class="text-2xl font-bold" id="weekAppointmentsCount">18</p>
                                </div>
                                <i class="fas fa-calendar-week text-2xl text-green-200"></i>
                            </div>
                        </div>
                        <div class="bg-gradient-to-r from-purple-500 to-purple-600 text-white p-4 rounded-lg shadow-lg">
                            <div class="flex items-center justify-between">
                                <div>
                                    <p class="text-purple-100 text-sm">Completed</p>
                                    <p class="text-2xl font-bold" id="completedAppointmentsCount">145</p>
                                </div>
                                <i class="fas fa-check-circle text-2xl text-purple-200"></i>
                            </div>
                        </div>
                        <div class="bg-gradient-to-r from-orange-500 to-orange-600 text-white p-4 rounded-lg shadow-lg">
                            <div class="flex items-center justify-between">
                                <div>
                                    <p class="text-orange-100 text-sm">Pending</p>
                                    <p class="text-2xl font-bold" id="pendingAppointmentsCount">7</p>
                                </div>
                                <i class="fas fa-clock text-2xl text-orange-200"></i>
                            </div>
                        </div>
                    </div>

                    <!-- Appointments List -->
                    <div class="bg-white dark:bg-gray-800 rounded-lg shadow-lg">
                        <!-- Header -->
                        <div class="p-6 border-b border-gray-200 dark:border-gray-700">
                            <div class="flex items-center justify-between">
                                <h3 class="text-lg font-semibold">All Appointments</h3>
                                <div class="flex items-center space-x-2 text-sm text-gray-500">
                                    <span>View:</span>
                                    <button id="listViewBtn" class="px-3 py-1 bg-primary text-white rounded">List</button>
                                    <button id="calendarViewBtn" class="px-3 py-1 text-gray-600 hover:bg-gray-100 rounded">Calendar</button>
                                </div>
                            </div>
                        </div>

                        <!-- Appointments Container -->
                        <div id="appointmentsContainer" class="p-6">
                            <div class="appointments-list space-y-4">
                                <!-- Today's Appointment -->
                                <div class="flex items-center justify-between p-4 border border-gray-200 dark:border-gray-700 rounded-lg hover:shadow-md transition-shadow border-l-4 border-green-500" data-appointment-id="dharui-appointment-today">
                                    <div class="flex items-center space-x-4">
                                        <div class="w-12 h-12 bg-primary rounded-full flex items-center justify-center text-white font-bold">
                                            DF
                                        </div>
                                        <div>
                                            <h4 class="font-semibold text-lg">Dharui Fakhroo</h4>
                                            <p class="text-gray-600 dark:text-gray-400 text-sm">
                                                <i class="fas fa-user-md mr-1"></i>Dr. Mariam Abdulatheem Ali
                                            </p>
                                            <p class="text-gray-500 text-sm">
                                                <i class="fas fa-clock mr-1"></i>Today, 2:00 PM - 3:00 PM (60 min)
                                            </p>
                                            <p class="text-xs text-green-700 dark:text-green-300">Follow-up session for back pain treatment</p>
                                        </div>
                                    </div>
                                    <div class="flex items-center space-x-3">
                                        <span class="px-3 py-1 bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-200 rounded-full text-sm font-medium">
                                            <i class="fas fa-calendar-check mr-1"></i>Scheduled
                                        </span>
                                        <div class="flex space-x-2">
                                            <button onclick="editAppointment('dharui-appointment-today')" class="p-2 text-blue-600 hover:text-blue-800 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors" title="Edit Appointment">
                                                <i class="fas fa-edit"></i>
                                            </button>
                                            <button onclick="completeAppointment('dharui-appointment-today')" class="p-2 text-green-600 hover:text-green-800 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors" title="Mark Complete">
                                                <i class="fas fa-check"></i>
                                            </button>
                                            <button onclick="cancelAppointment('dharui-appointment-today')" class="p-2 text-orange-600 hover:text-orange-800 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors" title="Cancel Appointment">
                                                <i class="fas fa-calendar-times"></i>
                                            </button>
                                            <button onclick="deleteAppointment('dharui-appointment-today')" class="p-2 text-red-600 hover:text-red-800 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors" title="Delete Appointment">
                                                <i class="fas fa-trash"></i>
                                            </button>
                                        </div>
                                    </div>
                                </div>

                                <!-- Tomorrow's Appointment -->
                                <div class="flex items-center justify-between p-4 border border-gray-200 dark:border-gray-700 rounded-lg hover:shadow-md transition-shadow border-l-4 border-blue-500" data-appointment-id="ahmed-appointment-tomorrow">
                                    <div class="flex items-center space-x-4">
                                        <div class="w-12 h-12 bg-secondary rounded-full flex items-center justify-center text-white font-bold">
                                            AK
                                        </div>
                                        <div>
                                            <h4 class="font-semibold text-lg">Ahmed Al-Khalifa</h4>
                                            <p class="text-gray-600 dark:text-gray-400 text-sm">
                                                <i class="fas fa-user-md mr-1"></i>Dr. Mariam Abdulatheem Ali
                                            </p>
                                            <p class="text-gray-500 text-sm">
                                                <i class="fas fa-clock mr-1"></i>Tomorrow, 10:00 AM - 11:00 AM (60 min)
                                            </p>
                                            <p class="text-xs text-blue-700 dark:text-blue-300">Initial assessment for back pain</p>
                                        </div>
                                    </div>
                                    <div class="flex items-center space-x-3">
                                        <span class="px-3 py-1 bg-blue-100 text-blue-800 dark:bg-blue-900 dark:text-blue-200 rounded-full text-sm font-medium">
                                            <i class="fas fa-calendar-alt mr-1"></i>Upcoming
                                        </span>
                                        <div class="flex space-x-2">
                                            <button onclick="sendAppointmentToPhysiotherapist('ahmed-appointment-tomorrow', 'mariam-physio-001', 'Ahmed Al-Khalifa')" class="p-2 text-purple-600 hover:text-purple-800 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors" title="Send to Physiotherapist">
                                                <i class="fas fa-share"></i>
                                            </button>
                                            <button onclick="editAppointment('ahmed-appointment-tomorrow')" class="p-2 text-blue-600 hover:text-blue-800 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors" title="Edit Appointment">
                                                <i class="fas fa-edit"></i>
                                            </button>
                                            <button onclick="completeAppointment('ahmed-appointment-tomorrow')" class="p-2 text-green-600 hover:text-green-800 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors" title="Mark Complete">
                                                <i class="fas fa-check"></i>
                                            </button>
                                            <button onclick="cancelAppointment('ahmed-appointment-tomorrow')" class="p-2 text-orange-600 hover:text-orange-800 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors" title="Cancel Appointment">
                                                <i class="fas fa-calendar-times"></i>
                                            </button>
                                            <button onclick="deleteAppointment('ahmed-appointment-tomorrow')" class="p-2 text-red-600 hover:text-red-800 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors" title="Delete Appointment">
                                                <i class="fas fa-trash"></i>
                                            </button>
                                        </div>
                                    </div>
                                </div>

                                <!-- Completed Appointment -->
                                <div class="flex items-center justify-between p-4 border border-gray-200 dark:border-gray-700 rounded-lg hover:shadow-md transition-shadow opacity-75 border-l-4 border-gray-400" data-appointment-id="fatima-appointment-completed">
                                    <div class="flex items-center space-x-4">
                                        <div class="w-12 h-12 bg-gray-500 rounded-full flex items-center justify-center text-white font-bold">
                                            FZ
                                        </div>
                                        <div>
                                            <h4 class="font-semibold text-lg">Fatima Al-Zahra</h4>
                                            <p class="text-gray-600 dark:text-gray-400 text-sm">
                                                <i class="fas fa-user-md mr-1"></i>Dr. Dhari Fakhroo
                                            </p>
                                            <p class="text-gray-500 text-sm">
                                                <i class="fas fa-clock mr-1"></i>Yesterday, 3:00 PM - 4:00 PM (60 min)
                                            </p>
                                            <p class="text-xs text-gray-600 dark:text-gray-400">Knee rehabilitation session</p>
                                        </div>
                                    </div>
                                    <div class="flex items-center space-x-3">
                                        <span class="px-3 py-1 bg-gray-100 text-gray-800 dark:bg-gray-700 dark:text-gray-200 rounded-full text-sm font-medium">
                                            <i class="fas fa-check-circle mr-1"></i>Completed
                                        </span>
                                        <div class="flex space-x-2">
                                            <button onclick="viewAppointmentDetails('fatima-appointment-completed')" class="p-2 text-gray-600 hover:text-gray-800 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors" title="View Details">
                                                <i class="fas fa-eye"></i>
                                            </button>
                                            <button onclick="duplicateAppointment('fatima-appointment-completed')" class="p-2 text-blue-600 hover:text-blue-800 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors" title="Duplicate Appointment">
                                                <i class="fas fa-copy"></i>
                                            </button>
                                            <button onclick="cancelAppointment('fatima-appointment-completed')" class="p-2 text-orange-600 hover:text-orange-800 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors" title="Cancel Appointment">
                                                <i class="fas fa-calendar-times"></i>
                                            </button>
                                            <button onclick="deleteAppointment('fatima-appointment-completed')" class="p-2 text-red-600 hover:text-red-800 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors" title="Delete Appointment">
                                                <i class="fas fa-trash"></i>
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Physiotherapist Assignment Panel -->
                    <div class="bg-gradient-to-r from-purple-50 to-blue-50 dark:from-purple-900/20 dark:to-blue-900/20 rounded-lg shadow-lg p-6 mb-6 border border-purple-200 dark:border-purple-800">
                        <div class="flex items-center mb-4">
                            <i class="fas fa-users-medical text-purple-600 text-2xl mr-3"></i>
                            <h3 class="text-xl font-semibold text-purple-900 dark:text-purple-100">Quick Physiotherapist Actions</h3>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <button onclick="sendTodaysAppointmentsToPhysiotherapist('mariam-physio-001', 'Dr. Mariam Abdulatheem Ali')" 
                                    class="flex items-center p-4 bg-white dark:bg-gray-800 rounded-lg border border-purple-200 dark:border-purple-700 hover:shadow-md transition-shadow">
                                <div class="w-12 h-12 bg-purple-100 rounded-lg flex items-center justify-center mr-4">
                                    <i class="fas fa-calendar-check text-purple-600 text-xl"></i>
                                </div>
                                <div class="text-left">
                                    <p class="font-semibold text-gray-900 dark:text-gray-100">Send Today's Appointments</p>
                                    <p class="text-sm text-gray-600 dark:text-gray-400">To Dr. Mariam Abdulatheem Ali</p>
                                </div>
                            </button>
                            <button onclick="createBulkAppointments()" 
                                    class="flex items-center p-4 bg-white dark:bg-gray-800 rounded-lg border border-blue-200 dark:border-blue-700 hover:shadow-md transition-shadow">
                                <div class="w-12 h-12 bg-blue-100 rounded-lg flex items-center justify-center mr-4">
                                    <i class="fas fa-calendar-plus text-blue-600 text-xl"></i>
                                </div>
                                <div class="text-left">
                                    <p class="font-semibold text-gray-900 dark:text-gray-100">Create Weekly Schedule</p>
                                    <p class="text-sm text-gray-600 dark:text-gray-400">Auto-schedule appointments for all physiotherapists</p>
                                </div>
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Physiotherapists View -->
                <div id="physiotherapists" class="view hidden">
                    <!-- Page Header -->
                    <div class="flex flex-col lg:flex-row justify-between items-start lg:items-center mb-8 gap-6">
                        <div class="flex-1">
                            <h1 class="text-4xl font-bold text-gray-900 dark:text-white mb-2">Physiotherapist Management</h1>
                            <p class="text-gray-600 dark:text-gray-400 text-lg">Manage your physiotherapy staff and their specializations</p>
                            
                            <!-- Stats Row -->
                            <div class="flex items-center gap-4 mt-4">
                                <div class="flex items-center text-sm text-gray-600 dark:text-gray-400 bg-gray-100 dark:bg-gray-700 px-4 py-2 rounded-lg">
                                    <i class="fas fa-user-md mr-2 text-primary"></i>
                                    <span id="physiotherapistCount">Total: 1 physiotherapist</span>
                                </div>
                                <div class="flex items-center text-sm text-green-600 dark:text-green-400 bg-green-50 dark:bg-green-900/20 px-4 py-2 rounded-lg">
                                    <i class="fas fa-check-circle mr-2"></i>
                                    <span>1 Active</span>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Action Buttons Section -->
                        <div class="flex flex-col sm:flex-row gap-3 w-full lg:w-auto">
                            <button id="addPhysiotherapistBtn" class="bg-gradient-to-r from-primary to-secondary text-white px-8 py-4 rounded-xl hover:from-secondary hover:to-primary transition-all duration-300 font-bold flex items-center justify-center shadow-xl transform hover:scale-105 hover:shadow-2xl text-lg">
                                <i class="fas fa-user-plus mr-3 text-xl"></i>
                                <span>Add New Physiotherapist</span>
                            </button>
                            <button class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-4 rounded-xl transition-colors font-semibold flex items-center justify-center shadow-lg">
                                <i class="fas fa-users mr-2"></i>
                                <span>Manage Team</span>
                            </button>
                        </div>
                    </div>

                    <!-- Quick Actions Bar -->
                    <div class="bg-white dark:bg-gray-800 rounded-lg shadow-lg p-6 mb-6">
                        <div class="flex flex-col lg:flex-row gap-4 items-start lg:items-center">
                            <!-- Search Section -->
                            <div class="flex-1 w-full lg:w-auto">
                                <div class="relative">
                                    <input type="text" id="physiotherapistSearchInput" placeholder="Search physiotherapists by name, specialization, or license number..." 
                                           class="w-full px-4 py-3 pl-12 pr-4 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-base focus:ring-2 focus:ring-primary focus:border-primary">
                                    <i class="fas fa-search absolute left-4 top-4 text-gray-400"></i>
                                </div>
                            </div>
                            
                            <!-- Filter and Actions -->
                            <div class="flex flex-col sm:flex-row gap-3 w-full lg:w-auto">
                                <!-- Specialization Filter -->
                                <select id="physiotherapistSpecializationFilter" class="px-4 py-3 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-base focus:ring-2 focus:ring-primary focus:border-primary">
                                    <option value="">All Specializations</option>
                                    <option value="orthopedic">Orthopedic</option>
                                    <option value="sports-medicine">Sports Medicine</option>
                                    <option value="neurological">Neurological</option>
                                    <option value="pediatric">Pediatric</option>
                                    <option value="geriatric">Geriatric</option>
                                    <option value="manual-therapy">Manual Therapy</option>
                                </select>
                                
                                <!-- Status Filter -->
                                <select id="physiotherapistStatusFilter" class="px-4 py-3 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-base focus:ring-2 focus:ring-primary focus:border-primary">
                                    <option value="">All Status</option>
                                    <option value="active">Active Staff</option>
                                    <option value="inactive">Inactive Staff</option>
                                    <option value="full-time">Full-time</option>
                                    <option value="part-time">Part-time</option>
                                    <option value="contract">Contract</option>
                                </select>
                                
                                <!-- Action Buttons -->
                                <div class="flex gap-2">
                                    <button id="exportPhysiotherapistsBtn" class="bg-blue-600 text-white px-4 py-3 rounded-lg hover:bg-blue-700 transition-colors flex items-center">
                                        <i class="fas fa-download mr-2"></i>Export
                                    </button>
                                    <button id="bulkActionsBtn" class="bg-gray-600 text-white px-4 py-3 rounded-lg hover:bg-gray-700 transition-colors flex items-center">
                                        <i class="fas fa-tasks mr-2"></i>Bulk Actions
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Physiotherapists Grid -->
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6" id="physiotherapistsGrid">
                        <!-- Sample Physiotherapist Card -->
                        <div class="bg-white dark:bg-gray-800 rounded-lg shadow-lg p-6 hover:shadow-xl transition-shadow">
                            <div class="flex items-center mb-4">
                                <div class="w-16 h-16 bg-secondary rounded-full flex items-center justify-center text-white font-bold text-xl mr-4">
                                    MA
                                </div>
                                <div>
                                    <h3 class="text-lg font-semibold">Dr. Mariam Abdulatheem Ali</h3>
                                    <p class="text-gray-600 dark:text-gray-400 text-sm">Orthopedic, Sports Medicine</p>
                                    <p class="text-gray-500 text-sm">7 years experience</p>
                                </div>
                            </div>
                            
                            <div class="space-y-2 mb-4">
                                <div class="flex items-center text-sm">
                                    <i class="fas fa-envelope w-4 mr-2 text-gray-400"></i>
                                    <span>Mariambmi@gmail.com</span>
                                </div>
                                <div class="flex items-center text-sm">
                                    <i class="fas fa-phone w-4 mr-2 text-gray-400"></i>
                                    <span>97362123</span>
                                </div>
                                <div class="flex items-center text-sm">
                                    <i class="fas fa-id-card w-4 mr-2 text-gray-400"></i>
                                    <span>License: PT-2024-MA</span>
                                </div>
                            </div>

                            <div class="flex items-center justify-between pt-4 border-t border-gray-200 dark:border-gray-700">
                                <span class="px-2 py-1 bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-200 rounded text-sm">Active</span>
                                <div class="flex space-x-2">
                                    <button onclick="editPhysiotherapist('mariam-physio-001')" class="p-2 text-blue-600 hover:text-blue-800 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors">
                                        <i class="fas fa-edit"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Exercises View -->
                <div id="exercises" class="view hidden">
                    <div class="flex justify-between items-center mb-6">
                        <h1 class="text-3xl font-bold">Exercise Library</h1>
                        <button id="addExerciseBtn" class="bg-primary text-white px-4 py-3 rounded-lg hover:bg-secondary transition-colors">
                            <i class="fas fa-plus mr-2"></i>Add Exercise
                        </button>
                    </div>

                    <!-- Exercise Categories -->
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 mb-8">
                        <div class="bg-gradient-to-r from-blue-500 to-blue-600 text-white p-6 rounded-lg shadow-lg">
                            <div class="flex items-center justify-between">
                                <div>
                                    <h3 class="text-xl font-bold mb-2">Strength Training</h3>
                                    <p class="text-blue-100">45 exercises</p>
                                </div>
                                <i class="fas fa-dumbbell text-4xl text-blue-200"></i>
                            </div>
                        </div>
                        <div class="bg-gradient-to-r from-green-500 to-green-600 text-white p-6 rounded-lg shadow-lg">
                            <div class="flex items-center justify-between">
                                <div>
                                    <h3 class="text-xl font-bold mb-2">Flexibility</h3>
                                    <p class="text-green-100">32 exercises</p>
                                </div>
                                <i class="fas fa-running text-4xl text-green-200"></i>
                            </div>
                        </div>
                        <div class="bg-gradient-to-r from-purple-500 to-purple-600 text-white p-6 rounded-lg shadow-lg">
                            <div class="flex items-center justify-between">
                                <div>
                                    <h3 class="text-xl font-bold mb-2">Balance & Coordination</h3>
                                    <p class="text-purple-100">28 exercises</p>
                                </div>
                                <i class="fas fa-balance-scale text-4xl text-purple-200"></i>
                            </div>
                        </div>
                    </div>

                    <!-- Exercise Library -->
                    <div class="bg-white dark:bg-gray-800 rounded-lg shadow-lg p-6">
                        <h3 class="text-xl font-semibold mb-4">Popular Exercises</h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                            <!-- Sample Exercise Cards -->
                            <div class="border border-gray-200 dark:border-gray-700 rounded-lg p-4 hover:shadow-lg transition-shadow">
                                <div class="flex items-center mb-3">
                                    <div class="w-12 h-12 bg-blue-100 rounded-lg flex items-center justify-center mr-3">
                                        <i class="fas fa-dumbbell text-blue-600 text-xl"></i>
                                    </div>
                                    <div>
                                        <h4 class="font-semibold">Shoulder Rolls</h4>
                                        <p class="text-sm text-gray-600 dark:text-gray-400">Strength Training</p>
                                    </div>
                                </div>
                                <p class="text-sm text-gray-600 dark:text-gray-400 mb-3">Improve shoulder mobility and reduce tension</p>
                                <div class="flex items-center justify-between">
                                    <span class="text-xs bg-blue-100 text-blue-800 dark:bg-blue-900 dark:text-blue-200 px-2 py-1 rounded">Beginner</span>
                                    <button onclick="viewExercise('shoulder-rolls')" class="text-primary hover:text-secondary text-sm font-medium">
                                        <i class="fas fa-eye mr-1"></i>View
                                    </button>
                                </div>
                            </div>

                            <div class="border border-gray-200 dark:border-gray-700 rounded-lg p-4 hover:shadow-lg transition-shadow">
                                <div class="flex items-center mb-3">
                                    <div class="w-12 h-12 bg-green-100 rounded-lg flex items-center justify-center mr-3">
                                        <i class="fas fa-running text-green-600 text-xl"></i>
                                    </div>
                                    <div>
                                        <h4 class="font-semibold">Hamstring Stretch</h4>
                                        <p class="text-sm text-gray-600 dark:text-gray-400">Flexibility</p>
                                    </div>
                                </div>
                                <p class="text-sm text-gray-600 dark:text-gray-400 mb-3">Improve leg flexibility and prevent injury</p>
                                <div class="flex items-center justify-between">
                                    <span class="text-xs bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-200 px-2 py-1 rounded">Beginner</span>
                                    <button onclick="viewExercise('hamstring-stretch')" class="text-primary hover:text-secondary text-sm font-medium">
                                        <i class="fas fa-eye mr-1"></i>View
                                    </button>
                                </div>
                            </div>

                            <div class="border border-gray-200 dark:border-gray-700 rounded-lg p-4 hover:shadow-lg transition-shadow">
                                <div class="flex items-center mb-3">
                                    <div class="w-12 h-12 bg-purple-100 rounded-lg flex items-center justify-center mr-3">
                                        <i class="fas fa-balance-scale text-purple-600 text-xl"></i>
                                    </div>
                                    <div>
                                        <h4 class="font-semibold">Single Leg Stand</h4>
                                        <p class="text-sm text-gray-600 dark:text-gray-400">Balance</p>
                                    </div>
                                </div>
                                <p class="text-sm text-gray-600 dark:text-gray-400 mb-3">Improve balance and proprioception</p>
                                <div class="flex items-center justify-between">
                                    <span class="text-xs bg-purple-100 text-purple-800 dark:bg-purple-900 dark:text-purple-200 px-2 py-1 rounded">Intermediate</span>
                                    <button onclick="viewExercise('single-leg-stand')" class="text-primary hover:text-secondary text-sm font-medium">
                                        <i class="fas fa-eye mr-1"></i>View
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Reports View -->
                <div id="reports" class="view hidden">
                    <h1 class="text-3xl font-bold mb-6">Reports & Analytics</h1>
                    
                    <!-- Reports Overview -->
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 mb-8">
                        <div class="bg-white dark:bg-gray-800 rounded-lg shadow-lg p-6">
                            <div class="flex items-center justify-between mb-4">
                                <h3 class="text-lg font-semibold">Patient Progress</h3>
                                <i class="fas fa-chart-line text-primary text-2xl"></i>
                            </div>
                            <p class="text-gray-600 dark:text-gray-400 text-sm mb-4">Track patient improvement over time</p>
                            <button onclick="generateProgressReport()" class="w-full bg-primary text-white py-3 rounded-lg hover:bg-secondary transition-colors">
                                Generate Report
                            </button>
                        </div>
                        
                        <div class="bg-white dark:bg-gray-800 rounded-lg shadow-lg p-6">
                            <div class="flex items-center justify-between mb-4">
                                <h3 class="text-lg font-semibold">Financial Summary</h3>
                                <i class="fas fa-dollar-sign text-green-600 text-2xl"></i>
                            </div>
                            <p class="text-gray-600 dark:text-gray-400 text-sm mb-4">Monthly revenue and billing reports</p>
                            <button onclick="generateFinancialReport()" class="w-full bg-green-600 text-white py-3 rounded-lg hover:bg-green-700 transition-colors">
                                Generate Report
                            </button>
                        </div>
                        
                        <div class="bg-white dark:bg-gray-800 rounded-lg shadow-lg p-6">
                            <div class="flex items-center justify-between mb-4">
                                <h3 class="text-lg font-semibold">Staff Performance</h3>
                                <i class="fas fa-user-md text-purple-600 text-2xl"></i>
                            </div>
                            <p class="text-gray-600 dark:text-gray-400 text-sm mb-4">Physiotherapist performance metrics</p>
                            <button onclick="generateStaffReport()" class="w-full bg-purple-600 text-white py-3 rounded-lg hover:bg-purple-700 transition-colors">
                                Generate Report
                            </button>
                        </div>
                    </div>
                    
                    <div class="bg-white dark:bg-gray-800 rounded-lg shadow-lg p-6">
                        <h3 class="text-xl font-semibold mb-4">Recent Reports</h3>
                        <div class="space-y-3">
                            <div class="flex items-center justify-between p-3 bg-gray-50 dark:bg-gray-700 rounded-lg">
                                <div class="flex items-center">
                                    <i class="fas fa-file-pdf text-red-500 mr-3"></i>
                                    <div>
                                        <p class="font-medium">Monthly Patient Report - December 2024</p>
                                        <p class="text-sm text-gray-600 dark:text-gray-400">Generated 2 hours ago</p>
                                    </div>
                                </div>
                                <button class="text-primary hover:text-secondary">
                                    <i class="fas fa-download"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- System Settings View -->
                <div id="settings" class="view hidden">
                    <h1 class="text-3xl font-bold mb-6">System Settings</h1>
                    
                    <!-- Settings Categories -->
                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                        <!-- General Settings -->
                        <div class="lg:col-span-2 space-y-6">
                            <div class="bg-white dark:bg-gray-800 rounded-lg shadow-lg p-6">
                                <h3 class="text-xl font-semibold mb-4 flex items-center">
                                    <i class="fas fa-cog text-primary mr-3"></i>
                                    General Settings
                                </h3>
                                
                                <div class="space-y-4">
                                    <div>
                                        <label class="block text-sm font-medium mb-2">Clinic Name</label>
                                        <input type="text" value="Bahrain Mobility International" 
                                               class="w-full px-4 py-3 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-base focus:ring-2 focus:ring-primary focus:border-primary">
                                    </div>
                                    
                                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                        <div>
                                            <label class="block text-sm font-medium mb-2">Default Appointment Duration</label>
                                            <select class="w-full px-4 py-3 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-base focus:ring-2 focus:ring-primary focus:border-primary">
                                                <option value="30">30 minutes</option>
                                                <option value="45">45 minutes</option>
                                                <option value="60" selected>60 minutes</option>
                                                <option value="90">90 minutes</option>
                                            </select>
                                        </div>
                                        
                                        <div>
                                            <label class="block text-sm font-medium mb-2">Time Zone</label>
                                            <select class="w-full px-4 py-3 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-base focus:ring-2 focus:ring-primary focus:border-primary">
                                                <option value="Asia/Bahrain" selected>Asia/Bahrain (GMT+3)</option>
                                                <option value="Asia/Dubai">Asia/Dubai (GMT+4)</option>
                                                <option value="Asia/Riyadh">Asia/Riyadh (GMT+3)</option>
                                            </select>
                                        </div>
                                    </div>
                                    
                                    <div>
                                        <label class="flex items-center">
                                            <input type="checkbox" checked class="mr-3 w-4 h-4 text-primary focus:ring-primary border-gray-300 rounded">
                                            <span>Enable email notifications for appointments</span>
                                        </label>
                                    </div>
                                    
                                    <div>
                                        <label class="flex items-center">
                                            <input type="checkbox" class="mr-3 w-4 h-4 text-primary focus:ring-primary border-gray-300 rounded">
                                            <span>Enable SMS reminders for patients</span>
                                        </label>
                                    </div>
                                </div>
                                
                                <div class="flex justify-end mt-6 pt-4 border-t border-gray-200 dark:border-gray-700">
                                    <button onclick="saveGeneralSettings()" class="bg-primary text-white px-6 py-3 rounded-lg hover:bg-secondary transition-colors">
                                        <i class="fas fa-save mr-2"></i>Save Settings
                                    </button>
                                </div>
                            </div>

                            <!-- Database Settings -->
                            <div class="bg-white dark:bg-gray-800 rounded-lg shadow-lg p-6">
                                <h3 class="text-xl font-semibold mb-4 flex items-center">
                                    <i class="fas fa-database text-primary mr-3"></i>
                                    Database Settings
                                </h3>
                                
                                <div class="space-y-4">
                                    <div class="flex items-center justify-between p-4 bg-gray-50 dark:bg-gray-700 rounded-lg">
                                        <div>
                                            <h4 class="font-semibold">Connection Status</h4>
                                            <p class="text-sm text-gray-600 dark:text-gray-400" id="settingsConnectionStatus">
                                                <i class="fas fa-circle text-red-400 mr-1"></i>Not Connected
                                            </p>
                                        </div>
                                        <button id="settingsConnectSupabase" onclick="showSupabaseConnectionModal()" class="bg-primary text-white px-4 py-3 rounded-lg hover:bg-secondary transition-colors">
                                            Connect
                                        </button>
                                    </div>
                                    
                                    <div>
                                        <label class="flex items-center">
                                            <input type="checkbox" checked class="mr-3 w-4 h-4 text-primary focus:ring-primary border-gray-300 rounded">
                                            <span>Enable automatic backups</span>
                                        </label>
                                    </div>
                                    
                                    <div>
                                        <label class="flex items-center">
                                            <input type="checkbox" checked class="mr-3 w-4 h-4 text-primary focus:ring-primary border-gray-300 rounded">
                                            <span>Enable real-time synchronization</span>
                                        </label>
                                    </div>
                                </div>
                                
                                <div class="flex justify-end mt-6 pt-4 border-t border-gray-200 dark:border-gray-700">
                                    <button onclick="saveDatabaseSettings()" class="bg-primary text-white px-6 py-3 rounded-lg hover:bg-secondary transition-colors">
                                        <i class="fas fa-save mr-2"></i>Save Settings
                                    </button>
                                </div>
                            </div>
                        </div>

                        <!-- Quick Actions -->
                        <div class="space-y-6">
                            <div class="bg-white dark:bg-gray-800 rounded-lg shadow-lg p-6">
                                <h3 class="text-xl font-semibold mb-4 flex items-center">
                                    <i class="fas fa-tools text-primary mr-3"></i>
                                    Quick Actions
                                </h3>
                                
                                <div class="space-y-3">
                                    <button onclick="exportAllData()" class="w-full flex items-center p-3 bg-blue-50 dark:bg-blue-900/20 rounded-lg hover:bg-blue-100 dark:hover:bg-blue-900/30 transition-colors">
                                        <i class="fas fa-download text-blue-600 mr-3"></i>
                                        <div class="text-left">
                                            <p class="font-medium text-blue-900 dark:text-blue-100">Export Data</p>
                                            <p class="text-xs text-blue-600 dark:text-blue-300">Download all system data</p>
                                        </div>
                                    </button>
                                    
                                    <button onclick="importData()" class="w-full flex items-center p-3 bg-green-50 dark:bg-green-900/20 rounded-lg hover:bg-green-100 dark:hover:bg-green-900/30 transition-colors">
                                        <i class="fas fa-upload text-green-600 mr-3"></i>
                                        <div class="text-left">
                                            <p class="font-medium text-green-900 dark:text-green-100">Import Data</p>
                                            <p class="text-xs text-green-600 dark:text-green-300">Upload and import data</p>
                                        </div>
                                    </button>
                                    
                                    <button onclick="systemBackup()" class="w-full flex items-center p-3 bg-purple-50 dark:bg-purple-900/20 rounded-lg hover:bg-purple-100 dark:hover:bg-purple-900/30 transition-colors">
                                        <i class="fas fa-shield-alt text-purple-600 mr-3"></i>
                                        <div class="text-left">
                                            <p class="font-medium text-purple-900 dark:text-purple-100">System Backup</p>
                                            <p class="text-xs text-purple-600 dark:text-purple-300">Create system backup</p>
                                        </div>
                                    </button>
                                </div>
                            </div>

                            <!-- System Information -->
                            <div class="bg-white dark:bg-gray-800 rounded-lg shadow-lg p-6">
                                <h3 class="text-xl font-semibold mb-4 flex items-center">
                                    <i class="fas fa-info-circle text-primary mr-3"></i>
                                    System Information
                                </h3>
                                
                                <div class="space-y-3 text-sm">
                                    <div class="flex justify-between">
                                        <span class="text-gray-600 dark:text-gray-400">Version:</span>
                                        <span class="font-medium">PhysioTech v2.1.0</span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span class="text-gray-600 dark:text-gray-400">Last Updated:</span>
                                        <span class="font-medium">Dec 18, 2024</span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span class="text-gray-600 dark:text-gray-400">Database:</span>
                                        <span class="font-medium" id="databaseType">Supabase</span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span class="text-gray-600 dark:text-gray-400">License:</span>
                                        <span class="font-medium">Professional</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Users View (placeholder for now) -->
                <div id="users" class="view hidden">
                    <!-- Will be populated by showUsersView() function -->
                </div>
            </div>
        </div>
    </div>

    <!-- Physiotherapist Dashboard -->
    <div id="physioDashboard" class="hidden">
        <!-- Navigation -->
        <nav class="bg-secondary shadow-lg fixed top-0 left-0 right-0 z-50">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                <div class="flex justify-between h-16">
                    <div class="flex items-center">
                        <i class="fas fa-user-md text-white text-2xl mr-3"></i>
                        <span class="text-white text-xl font-bold">PhysioTech - Physiotherapist</span>
                    </div>
                    <div class="flex items-center space-x-4">
                        <div class="flex items-center space-x-3 text-white">
                            <div class="w-8 h-8 bg-white bg-opacity-20 rounded-full flex items-center justify-center">
                                <i class="fas fa-user-md text-sm"></i>
                            </div>
                            <div class="hidden md:block">
                                <p class="text-sm font-medium" id="physioUserName">Physiotherapist</p>
                                <p class="text-xs text-gray-200" id="physioUserEmail">physio@example.com</p>
                            </div>
                        </div>
                        
                        <button id="physioLogoutBtn" class="bg-red-500 text-white px-4 py-3 rounded-lg hover:bg-red-600 transition-colors">
                            <i class="fas fa-sign-out-alt mr-2"></i>Logout
                        </button>
                    </div>
                </div>
            </div>
        </nav>

        <div class="flex pt-16">
            <!-- Sidebar -->
            <div class="w-64 bg-gray-50 dark:bg-gray-800 min-h-screen p-4 fixed left-0 top-16 bottom-0 overflow-y-auto">
                <nav class="space-y-2">
                    <button class="physio-nav-btn w-full text-left p-3 rounded-lg hover:bg-gray-200 dark:hover:bg-gray-700 transition-colors bg-secondary text-white" data-view="physio-dashboard">
                        <i class="fas fa-tachometer-alt mr-3"></i>Dashboard
                    </button>
                    <button class="physio-nav-btn w-full text-left p-3 rounded-lg hover:bg-gray-200 dark:hover:bg-gray-700 transition-colors" data-view="physio-appointments">
                        <i class="fas fa-calendar mr-3"></i>My Appointments
                    </button>
                    <button class="physio-nav-btn w-full text-left p-3 rounded-lg hover:bg-gray-200 dark:hover:bg-gray-700 transition-colors" data-view="physio-patients">
                        <i class="fas fa-folder-open mr-3"></i>Patient Files
                    </button>
                </nav>
            </div>

            <!-- Main Content -->
            <div class="flex-1 ml-64 p-6">
                <!-- Physiotherapist Dashboard View -->
                <div id="physio-dashboard" class="physio-view">
                    <h1 class="text-3xl font-bold mb-6">Dashboard</h1>
                    
                    <!-- Welcome Card -->
                    <div class="bg-gradient-to-r from-secondary to-sage text-white p-6 rounded-lg shadow-lg mb-8">
                        <div class="flex items-center justify-between">
                            <div class="flex items-center">
                                <div class="w-16 h-16 bg-white bg-opacity-20 rounded-full flex items-center justify-center mr-4">
                                    <i class="fas fa-user-md text-2xl"></i>
                                </div>
                                <div>
                                    <h2 class="text-2xl font-bold">Welcome back!</h2>
                                    <p class="text-white text-opacity-90">You have <span id="todayAppointmentsCount">2</span> appointments today</p>
                                </div>
                            </div>
                            
                            <!-- Voice Announcement Button -->
                            <div class="bg-white bg-opacity-10 rounded-lg p-4 border border-white border-opacity-30">
                                <div class="flex items-center justify-between">
                                    <div>
                                        <h3 class="text-white font-semibold text-lg">üéµ Voice Assistant</h3>
                                        <p class="text-white text-opacity-90 text-sm">Personal appointment announcements</p>
                                    </div>
                                    <button id="playVoiceAnnouncementBtn" class="bg-gradient-to-r from-blue-500 to-purple-600 hover:from-blue-600 hover:to-purple-700 text-white px-6 py-3 rounded-lg transition-all duration-200 flex items-center space-x-2 shadow-lg transform hover:scale-105">
                                        <i class="fas fa-volume-up text-xl"></i>
                                        <span class="font-medium">Play Voice Announcements</span>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Stats Cards -->
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                        <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-lg">
                            <div class="flex items-center">
                                <div class="w-12 h-12 bg-blue-100 rounded-lg flex items-center justify-center mr-4">
                                    <i class="fas fa-calendar-day text-blue-600 text-xl"></i>
                                </div>
                                <div>
                                    <p class="text-gray-600 dark:text-gray-400 text-sm">Today's Appointments</p>
                                    <p class="text-2xl font-bold" id="physioTodayAppointments">2</p>
                                </div>
                            </div>
                        </div>
                        <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-lg">
                            <div class="flex items-center">
                                <div class="w-12 h-12 bg-green-100 rounded-lg flex items-center justify-center mr-4">
                                    <i class="fas fa-users text-green-600 text-xl"></i>
                                </div>
                                <div>
                                    <p class="text-gray-600 dark:text-gray-400 text-sm">Active Patients</p>
                                    <p class="text-2xl font-bold" id="physioActivePatients">12</p>
                                </div>
                            </div>
                        </div>
                        <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-lg">
                            <div class="flex items-center">
                                <div class="w-12 h-12 bg-purple-100 rounded-lg flex items-center justify-center mr-4">
                                    <i class="fas fa-clipboard-check text-purple-600 text-xl"></i>
                                </div>
                                <div>
                                    <p class="text-gray-600 dark:text-gray-400 text-sm">Treatments This Week</p>
                                    <p class="text-2xl font-bold" id="physioWeeklyTreatments">8</p>
                                </div>
                            </div>
                        </div>
                        <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-lg">
                            <div class="flex items-center">
                                <div class="w-12 h-12 bg-orange-100 rounded-lg flex items-center justify-center mr-4">
                                    <i class="fas fa-star text-orange-600 text-xl"></i>
                                </div>
                                <div>
                                    <p class="text-gray-600 dark:text-gray-400 text-sm">Patient Rating</p>
                                    <p class="text-2xl font-bold" id="physioRating">4.9</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Today's Schedule -->
                    <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-lg">
                        <h3 class="text-xl font-semibold mb-4">Today's Schedule</h3>
                        <div id="todaySchedule" class="space-y-3">
                            <div class="flex items-center justify-between p-3 bg-blue-50 dark:bg-blue-900/20 rounded-lg">
                                <div class="flex items-center">
                                    <div class="w-12 h-12 bg-secondary rounded-full flex items-center justify-center text-white font-bold mr-3">
                                        AK
                                    </div>
                                    <div>
                                        <p class="font-medium">10:00 AM - Ahmed Al-Khalifa</p>
                                        <p class="text-sm text-gray-600 dark:text-gray-400">60 minutes ‚Ä¢ Follow-up for back pain treatment</p>
                                    </div>
                                </div>
                                <span class="px-2 py-1 bg-blue-100 text-blue-800 dark:bg-blue-900 dark:text-blue-200 rounded text-xs">scheduled</span>
                            </div>
                            <div class="flex items-center justify-between p-3 bg-blue-50 dark:bg-blue-900/20 rounded-lg">
                                <div class="flex items-center">
                                    <div class="w-12 h-12 bg-secondary rounded-full flex items-center justify-center text-white font-bold mr-3">
                                        FZ
                                    </div>
                                    <div>
                                        <p class="font-medium">2:00 PM - Fatima Al-Zahra</p>
                                        <p class="text-sm text-gray-600 dark:text-gray-400">45 minutes ‚Ä¢ Initial assessment for knee injury</p>
                                    </div>
                                </div>
                                <span class="px-2 py-1 bg-blue-100 text-blue-800 dark:bg-blue-900 dark:text-blue-200 rounded text-xs">scheduled</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Physiotherapist Appointments View -->
                <div id="physio-appointments" class="physio-view hidden">
                    <!-- Page Header -->
                    <div class="flex justify-between items-center mb-6">
                        <h1 class="text-3xl font-bold text-gray-900 dark:text-white">My Appointments</h1>
                        <div class="flex items-center text-sm text-gray-600 dark:text-gray-400">
                            <i class="fas fa-calendar-alt mr-2"></i>
                            <span id="physioAppointmentCount">Today: 2 appointments</span>
                        </div>
                    </div>

                    <!-- Action Bar -->
                    <div class="bg-white dark:bg-gray-800 rounded-lg shadow-lg p-6 mb-6">
                        <div class="flex flex-col lg:flex-row gap-4 items-start lg:items-center">
                            <!-- Date Filter Section -->
                            <div class="flex-1 w-full lg:w-auto">
                                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                    <div>
                                        <label class="block text-sm font-medium mb-2">Date</label>
                                        <input type="date" id="physioAppointmentDateFilter" 
                                               class="w-full px-4 py-3 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-base focus:ring-2 focus:ring-secondary focus:border-secondary">
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium mb-2">Status</label>
                                        <select id="physioAppointmentStatusFilter" 
                                                class="w-full px-4 py-3 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-base focus:ring-2 focus:ring-secondary focus:border-secondary">
                                            <option value="">All Status</option>
                                            <option value="scheduled">Scheduled</option>
                                            <option value="in-progress">In Progress</option>
                                            <option value="completed">Completed</option>
                                            <option value="cancelled">Cancelled</option>
                                        </select>
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium mb-2">Search</label>
                                        <input type="text" id="physioAppointmentSearch" placeholder="Search patients..." 
                                               class="w-full px-4 py-3 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-base focus:ring-2 focus:ring-secondary focus:border-secondary">
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Action Buttons -->
                            <div class="flex flex-col sm:flex-row gap-3 w-full lg:w-auto">
                                <button id="refreshPhysioAppointments" class="bg-gray-600 text-white px-4 py-3 rounded-lg hover:bg-gray-700 transition-colors flex items-center">
                                    <i class="fas fa-sync-alt mr-2"></i>Refresh
                                </button>
                                <button id="exportMyAppointments" class="bg-blue-600 text-white px-4 py-3 rounded-lg hover:bg-blue-700 transition-colors flex items-center">
                                    <i class="fas fa-download mr-2"></i>Export
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Quick Stats -->
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-6">
                        <div class="bg-gradient-to-r from-blue-500 to-blue-600 text-white p-4 rounded-lg shadow-lg">
                            <div class="flex items-center justify-between">
                                <div>
                                    <p class="text-blue-100 text-sm">Today</p>
                                    <p class="text-2xl font-bold">2</p>
                                </div>
                                <i class="fas fa-calendar-day text-2xl text-blue-200"></i>
                            </div>
                        </div>
                        <div class="bg-gradient-to-r from-green-500 to-green-600 text-white p-4 rounded-lg shadow-lg">
                            <div class="flex items-center justify-between">
                                <div>
                                    <p class="text-green-100 text-sm">This Week</p>
                                    <p class="text-2xl font-bold">12</p>
                                </div>
                                <i class="fas fa-calendar-week text-2xl text-green-200"></i>
                            </div>
                        </div>
                        <div class="bg-gradient-to-r from-purple-500 to-purple-600 text-white p-4 rounded-lg shadow-lg">
                            <div class="flex items-center justify-between">
                                <div>
                                    <p class="text-purple-100 text-sm">Completed</p>
                                    <p class="text-2xl font-bold">89</p>
                                </div>
                                <i class="fas fa-check-circle text-2xl text-purple-200"></i>
                            </div>
                        </div>
                        <div class="bg-gradient-to-r from-orange-500 to-orange-600 text-white p-4 rounded-lg shadow-lg">
                            <div class="flex items-center justify-between">
                                <div>
                                    <p class="text-orange-100 text-sm">Avg Rating</p>
                                    <p class="text-2xl font-bold">4.9</p>
                                </div>
                                <i class="fas fa-star text-2xl text-orange-200"></i>
                            </div>
                        </div>
                    </div>

                    <!-- Appointments List -->
                    <div class="bg-white dark:bg-gray-800 rounded-lg shadow-lg">
                        <!-- Header -->
                        <div class="p-6 border-b border-gray-200 dark:border-gray-700">
                            <div class="flex items-center justify-between">
                                <h3 class="text-lg font-semibold">My Appointments</h3>
                                <div class="flex items-center space-x-2 text-sm text-gray-500">
                                    <span>View:</span>
                                    <button id="physioListViewBtn" class="px-3 py-1 bg-secondary text-white rounded">List</button>
                                    <button id="physioCalendarViewBtn" class="px-3 py-1 text-gray-600 hover:bg-gray-100 rounded">Calendar</button>
                                </div>
                            </div>
                        </div>

                        <!-- Appointments Container -->
                        <div id="physioAppointmentsContainer" class="p-6">
                            <div class="space-y-4">
                                <!-- Today's Appointment 1 -->
                                <div class="flex items-center justify-between p-6 border border-gray-200 dark:border-gray-700 rounded-lg hover:shadow-md transition-shadow border-l-4 border-green-500 bg-gradient-to-r from-green-50 to-transparent dark:from-green-900/20">
                                    <div class="flex items-center space-x-4 flex-1">
                                        <div class="w-14 h-14 bg-secondary rounded-full flex items-center justify-center text-white font-bold text-lg">
                                            AK
                                        </div>
                                        <div class="flex-1">
                                            <div class="flex items-center justify-between">
                                                <h4 class="font-semibold text-xl text-gray-900 dark:text-white">Ahmed Al-Khalifa</h4>
                                                <span class="px-3 py-1 bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-200 rounded-full text-sm font-medium">
                                                    <i class="fas fa-clock mr-1"></i>In 2 hours
                                                </span>
                                            </div>
                                            <p class="text-gray-600 dark:text-gray-400 text-sm mt-1">
                                                <i class="fas fa-envelope mr-1"></i>ahmed@email.com ‚Ä¢ <i class="fas fa-phone ml-2 mr-1"></i>97123456
                                            </p>
                                            <p class="text-gray-800 dark:text-gray-300 font-medium mt-1">
                                                <i class="fas fa-clock mr-2 text-blue-600"></i>Today, 10:00 AM - 11:00 AM (60 min)
                                            </p>
                                            <div class="mt-3 p-3 bg-blue-50 dark:bg-blue-900/20 rounded-lg">
                                                <p class="text-sm text-blue-800 dark:text-blue-200">
                                                    <i class="fas fa-sticky-note mr-2"></i><strong>Treatment Notes:</strong> Follow-up session for lower back pain. Continue with strengthening exercises. Patient reports 40% improvement.
                                                </p>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="flex flex-col space-y-2 ml-4">
                                        <button onclick="startTreatmentSession('ahmed-appointment-today')" class="px-4 py-2 bg-green-600 text-white hover:bg-green-700 rounded-lg transition-colors text-sm font-medium">
                                            <i class="fas fa-play mr-1"></i>Start Session
                                        </button>
                                        <button onclick="viewPatientHistory('ahmed-patient-001')" class="px-4 py-2 bg-blue-600 text-white hover:bg-blue-700 rounded-lg transition-colors text-sm font-medium">
                                            <i class="fas fa-history mr-1"></i>History
                                        </button>
                                        <button onclick="addTreatmentNotes('ahmed-appointment-today')" class="px-4 py-2 bg-purple-600 text-white hover:bg-purple-700 rounded-lg transition-colors text-sm font-medium">
                                            <i class="fas fa-notes-medical mr-1"></i>Notes
                                        </button>
                                    </div>
                                </div>

                                <!-- Today's Appointment 2 -->
                                <div class="flex items-center justify-between p-6 border border-gray-200 dark:border-gray-700 rounded-lg hover:shadow-md transition-shadow border-l-4 border-blue-500 bg-gradient-to-r from-blue-50 to-transparent dark:from-blue-900/20">
                                    <div class="flex items-center space-x-4 flex-1">
                                        <div class="w-14 h-14 bg-secondary rounded-full flex items-center justify-center text-white font-bold text-lg">
                                            FZ
                                        </div>
                                        <div class="flex-1">
                                            <div class="flex items-center justify-between">
                                                <h4 class="font-semibold text-xl text-gray-900 dark:text-white">Fatima Al-Zahra</h4>
                                                <span class="px-3 py-1 bg-blue-100 text-blue-800 dark:bg-blue-900 dark:text-blue-200 rounded-full text-sm font-medium">
                                                    <i class="fas fa-calendar-alt mr-1"></i>Scheduled
                                                </span>
                                            </div>
                                            <p class="text-gray-600 dark:text-gray-400 text-sm mt-1">
                                                <i class="fas fa-envelope mr-1"></i>fatima@email.com ‚Ä¢ <i class="fas fa-phone ml-2 mr-1"></i>97654321
                                            </p>
                                            <p class="text-gray-800 dark:text-gray-300 font-medium mt-1">
                                                <i class="fas fa-clock mr-2 text-blue-600"></i>Today, 2:00 PM - 2:45 PM (45 min)
                                            </p>
                                            <div class="mt-3 p-3 bg-yellow-50 dark:bg-yellow-900/20 rounded-lg">
                                                <p class="text-sm text-yellow-800 dark:text-yellow-200">
                                                    <i class="fas fa-exclamation-triangle mr-2"></i><strong>Initial Assessment:</strong> First-time patient with knee injury from sports. Requires comprehensive evaluation and treatment plan.
                                                </p>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="flex flex-col space-y-2 ml-4">
                                        <button onclick="prepareInitialAssessment('fatima-appointment-today')" class="px-4 py-2 bg-yellow-600 text-white hover:bg-yellow-700 rounded-lg transition-colors text-sm font-medium">
                                            <i class="fas fa-clipboard-check mr-1"></i>Assessment
                                        </button>
                                        <button onclick="createTreatmentPlan('fatima-patient-001')" class="px-4 py-2 bg-green-600 text-white hover:bg-green-700 rounded-lg transition-colors text-sm font-medium">
                                            <i class="fas fa-plus-circle mr-1"></i>Plan
                                        </button>
                                        <button onclick="prescribeExercises('fatima-patient-001')" class="px-4 py-2 bg-purple-600 text-white hover:bg-purple-700 rounded-lg transition-colors text-sm font-medium">
                                            <i class="fas fa-dumbbell mr-1"></i>Exercises
                                        </button>
                                    </div>
                                </div>

                                <!-- Previous Appointment -->
                                <div class="flex items-center justify-between p-6 border border-gray-200 dark:border-gray-700 rounded-lg hover:shadow-md transition-shadow opacity-75 border-l-4 border-gray-400">
                                    <div class="flex items-center space-x-4 flex-1">
                                        <div class="w-14 h-14 bg-gray-500 rounded-full flex items-center justify-center text-white font-bold text-lg">
                                            SA
                                        </div>
                                        <div class="flex-1">
                                            <div class="flex items-center justify-between">
                                                <h4 class="font-semibold text-xl text-gray-900 dark:text-white">Sara Al-Mansouri</h4>
                                                <span class="px-3 py-1 bg-gray-100 text-gray-800 dark:bg-gray-700 dark:text-gray-200 rounded-full text-sm font-medium">
                                                    <i class="fas fa-check-circle mr-1"></i>Completed
                                                </span>
                                            </div>
                                            <p class="text-gray-600 dark:text-gray-400 text-sm mt-1">
                                                <i class="fas fa-envelope mr-1"></i>sara@email.com ‚Ä¢ <i class="fas fa-phone ml-2 mr-1"></i>97555888
                                            </p>
                                            <p class="text-gray-600 dark:text-gray-400 font-medium mt-1">
                                                <i class="fas fa-clock mr-2"></i>Yesterday, 3:00 PM - 4:00 PM (60 min)
                                            </p>
                                            <div class="mt-3 p-3 bg-gray-50 dark:bg-gray-700 rounded-lg">
                                                <p class="text-sm text-gray-700 dark:text-gray-300">
                                                    <i class="fas fa-check mr-2 text-green-600"></i><strong>Session Completed:</strong> Shoulder rehabilitation session completed successfully. Patient showed excellent progress with range of motion exercises.
                                                </p>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="flex flex-col space-y-2 ml-4">
                                        <button onclick="viewTreatmentSummary('sara-appointment-completed')" class="px-4 py-2 bg-gray-600 text-white hover:bg-gray-700 rounded-lg transition-colors text-sm font-medium">
                                            <i class="fas fa-eye mr-1"></i>Summary
                                        </button>
                                        <button onclick="scheduleFollowUp('sara-patient-001')" class="px-4 py-2 bg-blue-600 text-white hover:bg-blue-700 rounded-lg transition-colors text-sm font-medium">
                                            <i class="fas fa-calendar-plus mr-1"></i>Follow-up
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Treatment Tools Panel -->
                    <div class="bg-gradient-to-r from-teal-50 to-blue-50 dark:from-teal-900/20 dark:to-blue-900/20 rounded-lg shadow-lg p-6 mt-6 border border-teal-200 dark:border-teal-800">
                        <div class="flex items-center mb-4">
                            <i class="fas fa-tools text-teal-600 text-2xl mr-3"></i>
                            <h3 class="text-xl font-semibold text-teal-900 dark:text-teal-100">Quick Treatment Tools</h3>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                            <button onclick="openExerciseLibrary()" 
                                    class="flex items-center p-4 bg-white dark:bg-gray-800 rounded-lg border border-teal-200 dark:border-teal-700 hover:shadow-md transition-shadow">
                                <div class="w-12 h-12 bg-teal-100 rounded-lg flex items-center justify-center mr-4">
                                    <i class="fas fa-dumbbell text-teal-600 text-xl"></i>
                                </div>
                                <div class="text-left">
                                    <p class="font-semibold text-gray-900 dark:text-gray-100">Exercise Library</p>
                                    <p class="text-sm text-gray-600 dark:text-gray-400">Browse and assign exercises</p>
                                </div>
                            </button>
                            <button onclick="createProgressReport()" 
                                    class="flex items-center p-4 bg-white dark:bg-gray-800 rounded-lg border border-blue-200 dark:border-blue-700 hover:shadow-md transition-shadow">
                                <div class="w-12 h-12 bg-blue-100 rounded-lg flex items-center justify-center mr-4">
                                    <i class="fas fa-chart-line text-blue-600 text-xl"></i>
                                </div>
                                <div class="text-left">
                                    <p class="font-semibold text-gray-900 dark:text-gray-100">Progress Reports</p>
                                    <p class="text-sm text-gray-600 dark:text-gray-400">Generate patient reports</p>
                                </div>
                            </button>
                            <button onclick="openTreatmentProtocols()" 
                                    class="flex items-center p-4 bg-white dark:bg-gray-800 rounded-lg border border-purple-200 dark:border-purple-700 hover:shadow-md transition-shadow">
                                <div class="w-12 h-12 bg-purple-100 rounded-lg flex items-center justify-center mr-4">
                                    <i class="fas fa-clipboard-list text-purple-600 text-xl"></i>
                                </div>
                                <div class="text-left">
                                    <p class="font-semibold text-gray-900 dark:text-gray-100">Treatment Protocols</p>
                                    <p class="text-sm text-gray-600 dark:text-gray-400">Standard treatment plans</p>
                                </div>
                            </button>
                        </div>
                    </div>
                </div>

                <div id="physio-patients" class="physio-view hidden">
                    <div class="flex justify-between items-center mb-6">
                        <h1 class="text-3xl font-bold">My Patient Files</h1>
                        <button id="refreshPatientFiles" class="bg-secondary text-white px-4 py-3 rounded-lg hover:bg-sage transition-colors">
                            <i class="fas fa-sync-alt mr-2"></i>Refresh Files
                        </button>
                    </div>

                    <!-- Loading State -->
                    <div id="patientFilesLoading" class="hidden bg-white dark:bg-gray-800 rounded-lg shadow-lg p-8 text-center">
                        <i class="fas fa-spinner fa-spin text-secondary text-3xl mb-4"></i>
                        <p class="text-gray-600 dark:text-gray-400">Loading your assigned patients...</p>
                    </div>

                    <!-- No Patients State -->
                    <div id="noPatientFiles" class="bg-white dark:bg-gray-800 rounded-lg shadow-lg p-8 text-center">
                        <i class="fas fa-folder-open text-gray-300 dark:text-gray-600 text-6xl mb-4"></i>
                        <h3 class="text-xl font-semibold text-gray-600 dark:text-gray-400 mb-2">No Patient Files Yet</h3>
                        <p class="text-gray-500 dark:text-gray-500 mb-4">You haven't been assigned any patients yet. Patient files will appear here once an administrator assigns patients to you.</p>
                        <div class="bg-blue-50 dark:bg-blue-900/20 border border-blue-200 dark:border-blue-800 rounded-lg p-4 max-w-md mx-auto">
                            <p class="text-sm text-blue-800 dark:text-blue-200">
                                <i class="fas fa-info-circle mr-2"></i>
                                Administrators can assign patients to you from the admin dashboard. Once assigned, you'll see their complete medical files here.
                            </p>
                        </div>
                    </div>

                    <!-- Patient Files Grid -->
                    <div id="patientFilesGrid" class="hidden grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Loading Spinner -->
    <div id="loadingSpinner" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-white dark:bg-gray-800 p-8 rounded-lg shadow-xl">
            <div class="flex items-center space-x-4">
                <i class="fas fa-spinner loading text-primary text-2xl"></i>
                <span class="text-lg">Loading...</span>
            </div>
        </div>
    </div>

    <script>
        // Dark mode setup
        if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
            document.documentElement.classList.add('dark');
        }
        window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', event => {
            if (event.matches) {
                document.documentElement.classList.add('dark');
            } else {
                document.documentElement.classList.remove('dark');
            }
        });

        // Global variables
        let supabase = null;
        let currentView = 'dashboard';
        let currentPatientId = null;
        let connectionDetails = null;
        let currentUser = null;
        let isLoggedIn = false;

        // Constants for persistent storage
        const STORAGE_KEYS = {
            SUPABASE_CONNECTION: 'physiotech_supabase_connection',
            USER_PREFERENCES: 'physiotech_user_preferences'
        };

        // üîß FIX: Dynamic Page Title Updates Function
        function updatePageTitle(viewName) {
            const titleMap = {
                'dashboard': 'Dashboard - PhysioTech',
                'patients': 'Patients - PhysioTech', 
                'appointments': 'Appointments - PhysioTech',
                'physiotherapists': 'Physiotherapists - PhysioTech',
                'users': 'Users & Admins - PhysioTech',
                'exercises': 'Exercise Library - PhysioTech',
                'reports': 'Reports - PhysioTech',
                'settings': 'Settings - PhysioTech'
            };
            
            document.title = titleMap[viewName] || 'PhysioTech - Physiotherapy Management';
        }

        // Predefined users
        const adminUser = {
            email: 'DhariBmi@gmail.com',
            password: 'Dharui1979',
            role: 'admin',
            name: 'Admin User'
        };

        const mariamUser = {
            email: 'Mariambmi@gmail.com',
            password: 'Mariam1979!',
            role: 'physiotherapist',
            name: 'Mariam Abdulatheem Ali',
            physioData: {
                id: 'mariam-physio-001',
                first_name: 'Mariam',
                last_name: 'Abdulatheem Ali',
                email: 'Mariambmi@gmail.com',
                phone: '97362123',
                license_number: 'PT-2024-MA',
                years_experience: 7,
                specializations: ['Orthopedic', 'Sports Medicine', 'Manual Therapy'],
                employment_status: 'full-time',
                is_active: true
            }
        };

        // FIXED: Storage Functions for Physiotherapists and Patients
        function savePhysiotherapistToSystem(physioData) {
            try {
                const existingData = safeGetStorage('physiotech_physiotherapists', '[]');
                let physiotherapists = [];
                
                if (existingData && existingData !== '[]') {
                    physiotherapists = JSON.parse(existingData);
                }
                
                if (!physioData.id) {
                    physioData.id = 'physio-' + Date.now();
                }
                physioData.createdAt = physioData.createdAt || new Date().toISOString();
                physioData.status = physioData.status || 'active';
                
                physiotherapists.push(physioData);
                const saved = safeSetStorage('physiotech_physiotherapists', JSON.stringify(physiotherapists));
                
                if (saved) {
                    console.log('üíæ Physiotherapist saved successfully');
                    // Add to UI immediately
                    const container = document.getElementById('physiotherapistsGrid');
                    if (container) {
                        const firstName = physioData.personal?.firstName || 'Unknown';
                        const lastName = physioData.personal?.lastName || '';
                        const email = physioData.contact?.primaryEmail || 'No email';
                        const phone = physioData.contact?.primaryPhone || 'No phone';
                        const license = physioData.professional?.licenseNumber || 'No license';
                        const experience = physioData.professional?.experience || 0;
                        const specializations = physioData.professional?.specializations || [];
                        
                        const initials = (firstName[0] + (lastName[0] || '')).toUpperCase();
                        const specializationsText = specializations.join(', ') || 'General Practice';
                        
                        const newCard = document.createElement('div');
                        newCard.className = 'bg-white dark:bg-gray-800 rounded-lg shadow-lg p-6 hover:shadow-xl transition-shadow border-2 border-green-500';
                        newCard.innerHTML = `
                            <div class="flex items-center mb-4">
                                <div class="w-16 h-16 bg-secondary rounded-full flex items-center justify-center text-white font-bold text-xl mr-4">
                                    ${initials}
                                </div>
                                <div>
                                    <h3 class="text-lg font-semibold">Dr. ${firstName} ${lastName}</h3>
                                    <p class="text-gray-600 dark:text-gray-400 text-sm">${specializationsText}</p>
                                    <p class="text-gray-500 text-sm">${experience} years experience</p>
                                </div>
                            </div>
                            
                            <div class="space-y-2 mb-4">
                                <div class="flex items-center text-sm">
                                    <i class="fas fa-envelope w-4 mr-2 text-gray-400"></i>
                                    <span>${email}</span>
                                </div>
                                <div class="flex items-center text-sm">
                                    <i class="fas fa-phone w-4 mr-2 text-gray-400"></i>
                                    <span>${phone}</span>
                                </div>
                                <div class="flex items-center text-sm">
                                    <i class="fas fa-id-card w-4 mr-2 text-gray-400"></i>
                                    <span>License: ${license}</span>
                                </div>
                            </div>

                            <div class="flex items-center justify-between pt-4 border-t border-gray-200 dark:border-gray-700">
                                <div class="flex space-x-2">
                                    <span class="px-2 py-1 bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-200 rounded text-sm">Active</span>
                                    <span class="px-2 py-1 bg-blue-100 text-blue-800 dark:bg-blue-900 dark:text-blue-200 rounded text-sm">‚ú® New</span>
                                </div>
                                <div class="flex space-x-2">
                                    <button onclick="editPhysiotherapist('${physioData.id}')" class="p-2 text-blue-600 hover:text-blue-800 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors">
                                        <i class="fas fa-edit"></i>
                                    </button>
                                </div>
                            </div>
                        `;
                        container.appendChild(newCard);
                    }
                    
                    // Update count
                    const physioCountElement = document.getElementById('physiotherapistCount');
                    if (physioCountElement) {
                        const currentCount = parseInt(physioCountElement.textContent.match(/\d+/)[0]) + 1;
                        physioCountElement.textContent = `Total: ${currentCount} physiotherapist${currentCount !== 1 ? 's' : ''}`;
                    }
                }
                
                return true;
            } catch (error) {
                console.error('‚ùå Failed to save physiotherapist:', error);
                return true;
            }
        }

        function savePatientToSystem(patientData) {
            try {
                const existingData = safeGetStorage('physiotech_patients', '[]');
                let patients = [];
                
                if (existingData && existingData !== '[]') {
                    patients = JSON.parse(existingData);
                }
                
                patients.push(patientData);
                const saved = safeSetStorage('physiotech_patients', JSON.stringify(patients));
                
                if (saved) {
                    console.log('üíæ Patient saved:', patientData.fullName);
                }
                
                return true;
            } catch (error) {
                console.error('‚ùå Failed to save patient:', error);
                return true;
            }
        }

        // Utility functions
        function showLoading() {
            document.getElementById('loadingSpinner').classList.remove('hidden');
        }

        function hideLoading() {
            document.getElementById('loadingSpinner').classList.add('hidden');
        }

        function showNotification(message, type = 'success') {
            const notification = document.createElement('div');
            notification.className = `fixed top-4 right-4 p-4 rounded-lg shadow-lg z-50 ${
                type === 'success' ? 'bg-green-500' : 'bg-red-500'
            } text-white`;
            notification.textContent = message;
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.remove();
            }, 3000);
        }

        function showLoginError(message) {
            const errorDiv = document.getElementById('loginError');
            if (errorDiv) {
                errorDiv.textContent = message;
                errorDiv.classList.remove('hidden');
                
                setTimeout(() => {
                    errorDiv.classList.add('hidden');
                }, 5000);
            }
        }

        function showPhysioLoginError(message) {
            const errorDiv = document.getElementById('physioLoginError');
            if (errorDiv) {
                errorDiv.textContent = message;
                errorDiv.classList.remove('hidden');
                
                setTimeout(() => {
                    errorDiv.classList.add('hidden');
                }, 5000);
            }
        }

        // Navigation functions
        function setupNavigation() {
            const navButtons = document.querySelectorAll('.nav-btn');
            navButtons.forEach(btn => {
                btn.addEventListener('click', () => {
                    const view = btn.dataset.view;
                    showView(view);
                    
                    // Update active state
                    document.querySelectorAll('.nav-btn').forEach(b => {
                        b.classList.remove('bg-primary', 'text-white');
                    });
                    btn.classList.add('bg-primary', 'text-white');
                });
            });
        }

        function showView(viewName) {
            try {
                console.log('Switching to view:', viewName);
                
                // Hide all views
                document.querySelectorAll('.view').forEach(view => {
                    view.classList.add('hidden');
                });
                
                // Show target view
                const targetView = document.getElementById(viewName);
                if (targetView) {
                    targetView.classList.remove('hidden');
                    currentView = viewName;
                    
                    // üîß FIX: Update page title dynamically
                    updatePageTitle(viewName);
                    
                    // Special handling for users view to initialize it
                    if (viewName === 'users') {
                        console.log('Initializing users view...');
                        showUsersView();
                    }
                    
                    console.log('Successfully switched to view:', viewName);
                } else {
                    console.error('Target view not found:', viewName);
                    // Fallback to dashboard if view not found
                    const dashboardView = document.getElementById('dashboard');
                    if (dashboardView) {
                        dashboardView.classList.remove('hidden');
                        currentView = 'dashboard';
                        updatePageTitle('dashboard');
                    }
                }
            } catch (error) {
                console.error('Error switching views:', error);
                // Ensure dashboard is visible as fallback
                const dashboardView = document.getElementById('dashboard');
                if (dashboardView) {
                    dashboardView.classList.remove('hidden');
                    currentView = 'dashboard';
                    updatePageTitle('dashboard');
                }
            }
        }

        function setupPhysioNavigation() {
            const physioNavButtons = document.querySelectorAll('.physio-nav-btn');
            physioNavButtons.forEach(btn => {
                btn.addEventListener('click', () => {
                    const view = btn.dataset.view;
                    showPhysioView(view);
                    
                    // Update active state
                    physioNavButtons.forEach(b => {
                        b.classList.remove('bg-secondary', 'text-white');
                    });
                    btn.classList.add('bg-secondary', 'text-white');
                });
            });
        }

        function showPhysioView(viewName) {
            // Hide all physio views
            document.querySelectorAll('.physio-view').forEach(view => {
                view.classList.add('hidden');
            });
            
            // Show target view
            const targetView = document.getElementById(viewName);
            if (targetView) {
                targetView.classList.remove('hidden');
            }
        }

        function logout() {
            currentUser = null;
            isLoggedIn = false;
            
            // Hide all app views
            document.getElementById('mainApp').classList.add('hidden');
            document.getElementById('physioDashboard').classList.add('hidden');
            document.getElementById('adminLoginPage').classList.add('hidden');
            document.getElementById('physioLoginPage').classList.add('hidden');
            
            // Show user selection
            document.getElementById('userTypeSelection').classList.remove('hidden');
            
            // Clear forms
            document.getElementById('loginForm').reset();
            document.getElementById('physioLoginForm').reset();
            
            // üîß FIX: Reset page title on logout
            document.title = 'PhysioTech - Physiotherapy Management';
            
            showNotification('You have been logged out successfully.');
        }

        // Global error handler to prevent white screen crashes
        window.addEventListener('error', function(event) {
            console.error('Global error caught:', event.error);
            console.error('Error details:', {
                message: event.message,
                filename: event.filename,
                lineno: event.lineno,
                colno: event.colno
            });
            
            // Hide loading spinner if visible
            const spinner = document.getElementById('loadingSpinner');
            if (spinner && !spinner.classList.contains('hidden')) {
                spinner.classList.add('hidden');
            }
            
            // Show error notification
            showNotification('‚ö†Ô∏è An error occurred. The system will continue to work. Please refresh if needed.', 'error');
            
            return false; // Allow default error handling
        });

        window.addEventListener('unhandledrejection', function(event) {
            console.error('Unhandled promise rejection:', event.reason);
            
            // Hide loading spinner if visible
            const spinner = document.getElementById('loadingSpinner');
            if (spinner && !spinner.classList.contains('hidden')) {
                spinner.classList.add('hidden');
            }
            
            showNotification('‚ö†Ô∏è A background operation failed. The system will continue to work.', 'error');
        });

        // Initialize when DOM is ready - SAFE VERSION
        function safeInitialize() {
            try {
                console.log('Starting safe initialization...');
                initializeApp();
                console.log('Safe initialization completed successfully');
            } catch (error) {
                console.error('Critical initialization error:', error);
                
                // Try to show basic error UI
                try {
                    showNotification('‚ö†Ô∏è Application failed to initialize properly. Please refresh the page.', 'error');
                } catch (notificationError) {
                    console.error('Could not show notification:', notificationError);
                }
                
                setTimeout(() => {
                    console.log('Retrying initialization...');
                    safeInitialize();
                }, 1000); // Retry after 1 second
            }
        }

        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', safeInitialize);
        } else {
            setTimeout(safeInitialize, 50); // Small delay to ensure DOM is ready
        }

        function initializeApp() {
            console.log('Initializing PhysioTech Application...');
            
            // Load saved Supabase connection on startup
            try {
                const connectionRestored = loadSupabaseConnection();
                if (connectionRestored) {
                    console.log('üîÑ Saved connection restoration initiated');
                } else {
                    console.log('‚ÑπÔ∏è No saved connection found - fresh start');
                }
            } catch (connectionError) {
                console.error('Connection restoration error:', connectionError);
            }
            
            setupNavigation();
            setupPhysioNavigation();

            // Login type selection functionality
            document.getElementById('adminLoginBtn').addEventListener('click', () => {
                document.getElementById('userTypeSelection').classList.add('hidden');
                document.getElementById('adminLoginPage').classList.remove('hidden');
            });

            document.getElementById('physioLoginBtn').addEventListener('click', () => {
                document.getElementById('userTypeSelection').classList.add('hidden');
                document.getElementById('physioLoginPage').classList.remove('hidden');
            });

            // Back buttons
            document.getElementById('backToSelection').addEventListener('click', () => {
                document.getElementById('physioLoginPage').classList.add('hidden');
                document.getElementById('userTypeSelection').classList.remove('hidden');
            });

            const backFromAdmin = document.getElementById('backToSelectionFromAdmin');
            if (backFromAdmin) {
                backFromAdmin.addEventListener('click', () => {
                    document.getElementById('adminLoginPage').classList.add('hidden');
                    document.getElementById('userTypeSelection').classList.remove('hidden');
                });
            }

            // Password toggles
            document.getElementById('togglePassword').addEventListener('click', () => {
                const passwordInput = document.getElementById('loginPassword');
                const toggleIcon = document.querySelector('#togglePassword i');
                
                if (passwordInput.type === 'password') {
                    passwordInput.type = 'text';
                    toggleIcon.classList.remove('fa-eye');
                    toggleIcon.classList.add('fa-eye-slash');
                } else {
                    passwordInput.type = 'password';
                    toggleIcon.classList.remove('fa-eye-slash');
                    toggleIcon.classList.add('fa-eye');
                }
            });

            document.getElementById('togglePhysioPassword').addEventListener('click', () => {
                const passwordInput = document.getElementById('physioLoginPassword');
                const toggleIcon = document.querySelector('#togglePhysioPassword i');
                
                if (passwordInput.type === 'password') {
                    passwordInput.type = 'text';
                    toggleIcon.classList.remove('fa-eye');
                    toggleIcon.classList.add('fa-eye-slash');
                } else {
                    passwordInput.type = 'password';
                    toggleIcon.classList.remove('fa-eye-slash');
                    toggleIcon.classList.add('fa-eye');
                }
            });

            // FIXED: Admin login form with better error handling
            document.getElementById('loginForm').addEventListener('submit', async (e) => {
                e.preventDefault();
                
                const email = document.getElementById('loginEmail').value.trim();
                const password = document.getElementById('loginPassword').value;
                
                console.log('üîê Admin login attempt:', { email: email, passwordLength: password.length });
                
                if (!email || !password) {
                    showLoginError('‚ùå Please fill in both email and password fields');
                    return;
                }

                try {
                    showLoading();
                    
                    // Debug: Log the comparison
                    console.log('üîç Login comparison:', {
                        inputEmail: email,
                        expectedEmail: adminUser.email,
                        emailMatch: email === adminUser.email,
                        inputPassword: password,
                        expectedPassword: adminUser.password,
                        passwordMatch: password === adminUser.password
                    });
                    
                    if (email === adminUser.email && password === adminUser.password) {
                        console.log('‚úÖ Admin login successful');
                        currentUser = adminUser;
                        isLoggedIn = true;
                        
                        document.getElementById('adminLoginPage').classList.add('hidden');
                        document.getElementById('mainApp').classList.remove('hidden');
                        
                        document.getElementById('userEmail').textContent = currentUser.email;
                        
                        // üîß FIX: Set initial page title for dashboard
                        updatePageTitle('dashboard');
                        
                        showNotification('‚úÖ Welcome to PhysioTech! You are logged in as Administrator.');
                        
                        // Load appointment data when admin logs in
                        setTimeout(() => {
                            const appointments = loadAllAppointments();
                            showNotification(`üìä ${appointments.length} appointments loaded from storage`, 'success');
                        }, 500);
                        
                    } else {
                        console.log('‚ùå Admin login failed - credential mismatch');
                        showLoginError('‚ùå Invalid credentials. Admin login:\nüìß Email: DhariBmi@gmail.com\nüîë Password: Dharui1979');
                        
                        // Show helpful debug info
                        if (email !== adminUser.email) {
                            console.log('Email mismatch - Expected:', adminUser.email, 'Got:', email);
                        }
                        if (password !== adminUser.password) {
                            console.log('Password mismatch - Expected length:', adminUser.password.length, 'Got length:', password.length);
                        }
                    }
                    
                } catch (error) {
                    console.error('‚ùå Login error:', error);
                    showLoginError('‚ö†Ô∏è Login system error. Please refresh and try again.');
                } finally {
                    hideLoading();
                }
            });

            // Physiotherapist login form
            document.getElementById('physioLoginForm').addEventListener('submit', async (e) => {
                e.preventDefault();
                
                const email = document.getElementById('physioLoginEmail').value.trim();
                const password = document.getElementById('physioLoginPassword').value;
                
                if (!email || !password) {
                    showPhysioLoginError('Please fill in all fields');
                    return;
                }

                try {
                    showLoading();
                    
                    if (email === mariamUser.email && password === mariamUser.password) {
                        currentUser = mariamUser;
                        isLoggedIn = true;
                        
                        document.getElementById('physioLoginPage').classList.add('hidden');
                        document.getElementById('physioDashboard').classList.remove('hidden');
                        
                        document.getElementById('physioUserName').textContent = mariamUser.name;
                        document.getElementById('physioUserEmail').textContent = mariamUser.email;
                        
                        // üîß FIX: Set physiotherapist page title
                        document.title = 'Physiotherapist Dashboard - PhysioTech';
                        
                        // Load assigned appointments and patients when physiotherapist logs in
                        loadAssignedAppointments();
                        loadAssignedPatients();
                        
                        showNotification('Welcome back, ' + mariamUser.name + '! üéµ Voice announcements are ready for you.');
                    } else {
                        showPhysioLoginError('Invalid email or password. Use: Mariambmi@gmail.com / Mariam1979!');
                    }
                    
                } catch (error) {
                    console.error('Physiotherapist login error:', error);
                    showPhysioLoginError('Login failed. Please try again.');
                } finally {
                    hideLoading();
                }
            });

            // Logout buttons
            document.getElementById('logoutBtn').addEventListener('click', logout);
            document.getElementById('physioLogoutBtn').addEventListener('click', logout);

            // üéµ ENHANCED Voice Announcement Functionality - REAL-TIME VERSION
            document.getElementById('playVoiceAnnouncementBtn').addEventListener('click', async () => {
                const button = document.getElementById('playVoiceAnnouncementBtn');
                const originalContent = button.innerHTML;
                
                try {
                    // Update button to show generating state
                    button.innerHTML = '<i class="fas fa-spinner fa-spin text-xl"></i><span class="font-medium">Generating Voice...</span>';
                    button.disabled = true;
                    
                    // Get current time and personalized data
                    const currentTime = new Date().toLocaleTimeString('en-US', { 
                        hour: '2-digit', 
                        minute: '2-digit',
                        hour12: true 
                    });
                    const todaysDate = new Date().toLocaleDateString('en-US', { 
                        weekday: 'long',
                        month: 'long', 
                        day: 'numeric' 
                    });
                    
                    // Count actual appointments
                    const appointmentCount = window.assignedAppointments ? window.assignedAppointments.length + 2 : 2;
                    
                    // Create dynamic, personalized announcement
                    const announcement = `Good morning, Dr. Mariam Abdulatheem Ali! Welcome back to PhysioTech on this beautiful ${todaysDate}. 
                    The current time is ${currentTime}. You have ${appointmentCount} appointments scheduled for today at Bahrain Mobility International. 
                    Your first patient, Ahmed Al-Khalifa, has a follow-up session at 10 AM for back pain treatment. 
                    Your second patient, Fatima Al-Zahra, has an initial assessment at 2 PM for knee injury. 
                    Have an excellent and productive day helping your patients achieve their recovery goals!`;
                    
                    console.log('üéµ Attempting to generate voice announcement...');
                    console.log('Announcement text:', announcement);
                    
                    // Check if Poe API is available and try voice generation
                    if (typeof window !== 'undefined' && window.Poe && window.Poe.sendUserMessage) {
                        console.log('‚úÖ Poe API detected, attempting voice generation...');
                        
                        // Try to send voice request with error handling
                        try {
                            await window.Poe.sendUserMessage(
                                `@ElevenLabs-v2.5-Turbo ${announcement} --voice Sarah`,
                                {
                                    handler: 'voice-announcement-handler',
                                    stream: false,
                                    openChat: false,
                                    handlerContext: { 
                                        timestamp: Date.now(),
                                        doctorName: 'Dr. Mariam Abdulatheem Ali',
                                        appointments: appointmentCount
                                    }
                                }
                            );
                            
                            console.log('üéµ Voice request sent successfully to ElevenLabs');
                            showNotification('üéµ Generating your personalized voice announcement...', 'success');
                            
                        } catch (poeError) {
                            console.error('Poe API error:', poeError);
                            
                            // Handle specific Poe errors
                            if (poeError.errorType === 'USER_REJECTED_CONFIRMATION') {
                                showNotification('üîí Voice generation requires confirmation. Please accept the prompt to enable voice announcements.', 'error');
                            } else if (poeError.errorType === 'INVALID_INPUT') {
                                showNotification('‚ùå Voice input validation failed. Please try again.', 'error');
                            } else {
                                showNotification('‚ö†Ô∏è Voice generation failed. Trying alternative method...', 'error');
                                
                                // Try alternative voice bot
                                try {
                                    await window.Poe.sendUserMessage(
                                        `@PlayAI-Dialog Speaker 1: ${announcement} --speaker_1 Jennifer_(English_(US)/American)`,
                                        {
                                            handler: 'voice-announcement-handler',
                                            stream: false,
                                            openChat: false
                                        }
                                    );
                                    console.log('üéµ Fallback voice request sent to PlayAI');
                                    showNotification('üéµ Generating voice with alternative system...', 'success');
                                } catch (fallbackError) {
                                    console.error('Fallback voice error:', fallbackError);
                                    throw fallbackError;
                                }
                            }
                        }
                        
                    } else {
                        console.warn('‚ö†Ô∏è Poe API not available, using browser speech synthesis');
                        
                        // Fallback to Web Speech API if available
                        if ('speechSynthesis' in window && 'SpeechSynthesisUtterance' in window) {
                            const utterance = new SpeechSynthesisUtterance(announcement);
                            utterance.rate = 0.9;
                            utterance.pitch = 1.0;
                            utterance.volume = 0.8;
                            
                            // Try to use a female voice
                            const voices = speechSynthesis.getVoices();
                            const femaleVoice = voices.find(voice => 
                                voice.name.toLowerCase().includes('female') || 
                                voice.name.toLowerCase().includes('sarah') ||
                                voice.name.toLowerCase().includes('samantha') ||
                                voice.gender === 'female'
                            );
                            if (femaleVoice) {
                                utterance.voice = femaleVoice;
                            }
                            
                            utterance.onstart = () => {
                                console.log('üéµ Browser speech synthesis started');
                                showNotification('üéµ Playing voice announcement using browser speech...', 'success');
                            };
                            
                            utterance.onend = () => {
                                console.log('üéµ Browser speech synthesis completed');
                                showNotification('‚úÖ Voice announcement completed!', 'success');
                            };
                            
                            utterance.onerror = (error) => {
                                console.error('Browser speech error:', error);
                                showNotification('‚ùå Browser speech failed. Voice announcements require a compatible browser.', 'error');
                            };
                            
                            // Play the announcement
                            speechSynthesis.speak(utterance);
                            
                        } else {
                            // Final fallback - just show the text
                            console.log('‚ÑπÔ∏è No voice synthesis available, showing text announcement');
                            
                            // Create a nice text-based announcement modal
                            const textModal = document.createElement('div');
                            textModal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
                            textModal.innerHTML = `
                                <div class="bg-gradient-to-r from-blue-500 to-purple-600 text-white p-8 rounded-lg shadow-xl max-w-2xl w-full mx-4">
                                    <div class="text-center">
                                        <div class="w-20 h-20 bg-white bg-opacity-20 rounded-full flex items-center justify-center mx-auto mb-6">
                                            <i class="fas fa-volume-up text-3xl"></i>
                                        </div>
                                        <h2 class="text-2xl font-bold mb-4">üéµ Voice Announcement</h2>
                                        <div class="bg-white bg-opacity-10 rounded-lg p-6 mb-6">
                                            <p class="text-lg leading-relaxed">${announcement}</p>
                                        </div>
                                        <button onclick="this.closest('.fixed').remove()" class="bg-white text-blue-600 px-8 py-3 rounded-lg font-semibold hover:bg-gray-100 transition-colors">
                                            <i class="fas fa-check mr-2"></i>Got It!
                                        </button>
                                    </div>
                                </div>
                            `;
                            document.body.appendChild(textModal);
                            
                            showNotification('üì¢ Voice announcement displayed as text (voice not available in this environment)', 'success');
                        }
                    }
                    
                } catch (error) {
                    console.error('üö® Voice announcement error:', error);
                    
                    // User-friendly error handling
                    let errorMessage = '‚ùå Voice announcement failed: ';
                    
                    if (error.message && error.message.includes('network')) {
                        errorMessage += 'Network connection issue. Please check your internet connection.';
                    } else if (error.message && error.message.includes('permission')) {
                        errorMessage += 'Microphone or audio permissions required.';
                    } else {
                        errorMessage += 'Please try again or check your browser settings.';
                    }
                    
                    showNotification(errorMessage, 'error');
                    
                } finally {
                    // Always restore button state
                    setTimeout(() => {
                        button.innerHTML = originalContent;
                        button.disabled = false;
                    }, 1000);
                }
            });

            // üéµ ENHANCED Voice Handler - REAL-TIME PROCESSING
            if (typeof window !== 'undefined' && window.Poe && window.Poe.registerHandler) {
                window.Poe.registerHandler('voice-announcement-handler', (result, context) => {
                    console.log('üéµ Voice handler called with status:', result.status);
                    console.log('Voice handler result:', result);
                    
                    try {
                        if (result.status === 'incomplete') {
                            // Show progress for streaming
                            const message = result.responses[0];
                            if (message && message.content) {
                                console.log('üéµ Voice generation progress:', message.content);
                                showNotification(`üéµ Voice generation: ${message.content}`, 'success');
                            }
                        } else if (result.status === 'complete') {
                            // Voice generation completed successfully
                            const message = result.responses[0];
                            console.log('üéµ Voice generation completed!', message);
                            
                            // Check if there's an audio attachment
                            if (message.attachments && message.attachments.length > 0) {
                                const audioAttachment = message.attachments.find(att => att.mimeType.includes('audio'));
                                if (audioAttachment) {
                                    console.log('üéµ Audio file generated:', audioAttachment.url);
                                    
                                    // Play the generated audio
                                    const audio = new Audio(audioAttachment.url);
                                    audio.play().then(() => {
                                        console.log('üéµ Audio playback started successfully');
                                        showNotification('üéµ Playing your personalized voice announcement!', 'success');
                                    }).catch(audioError => {
                                        console.error('Audio playback error:', audioError);
                                        showNotification('üéµ Voice generated but playback failed. Check audio permissions.', 'error');
                                    });
                                } else {
                                    console.log('üéµ Voice request completed but no audio attachment found');
                                    showNotification('üéµ Voice announcement generated successfully!', 'success');
                                }
                            } else {
                                console.log('üéµ Voice generation completed, but no attachments received');
                                showNotification('üéµ Voice announcement processed successfully!', 'success');
                            }
                            
                        } else if (result.status === 'error') {
                            // Handle voice generation errors
                            const message = result.responses[0];
                            const errorText = message?.statusText || 'Unknown error';
                            console.error('üö® Voice generation error:', errorText);
                            
                            if (errorText.toLowerCase().includes('quota') || errorText.toLowerCase().includes('limit')) {
                                showNotification('‚ö†Ô∏è Voice generation quota exceeded. Please try again later.', 'error');
                            } else if (errorText.toLowerCase().includes('invalid')) {
                                showNotification('‚ùå Invalid voice request. Please contact support.', 'error');
                            } else {
                                showNotification(`‚ùå Voice generation failed: ${errorText}`, 'error');
                            }
                        }
                        
                    } catch (handlerError) {
                        console.error('Voice handler processing error:', handlerError);
                        showNotification('‚ö†Ô∏è Voice processing error occurred', 'error');
                    }
                });
                
                console.log('‚úÖ Voice announcement handler registered successfully');
            } else {
                console.warn('‚ö†Ô∏è Poe API not available - voice handler not registered');
            }

            // Connect Supabase button
            document.getElementById('connectSupabase').addEventListener('click', () => {
                showSupabaseConnectionModal();
            });

            // Quick action buttons
            const quickAddPatient = document.getElementById('quickAddPatient');
            if (quickAddPatient) {
                quickAddPatient.addEventListener('click', () => {
                    showView('patients');
                    showNotification('Navigate to Patients section');
                });
            }

            const quickScheduleAppointment = document.getElementById('quickScheduleAppointment');
            if (quickScheduleAppointment) {
                quickScheduleAppointment.addEventListener('click', () => {
                    showView('appointments');
                    showNotification('Navigate to Appointments section');
                });
            }

            const quickAddPhysiotherapist = document.getElementById('quickAddPhysiotherapist');
            if (quickAddPhysiotherapist) {
                quickAddPhysiotherapist.addEventListener('click', () => {
                    showView('physiotherapists');
                    showNotification('Navigate to Physiotherapists section');
                });
            }

            // Add buttons
            const addPatientBtn = document.getElementById('addPatientBtn');
            if (addPatientBtn) {
                addPatientBtn.addEventListener('click', () => {
                    showAddPatientModal();
                });
            }

            const addAppointmentBtn = document.getElementById('addAppointmentBtn');
            if (addAppointmentBtn) {
                addAppointmentBtn.addEventListener('click', () => {
                    showAddAppointmentModal();
                });
            }

            const addPhysiotherapistBtn = document.getElementById('addPhysiotherapistBtn');
            if (addPhysiotherapistBtn) {
                addPhysiotherapistBtn.addEventListener('click', () => {
                    showAddPhysiotherapistModal();
                });
            }

            // Refresh patient files button
            const refreshPatientFiles = document.getElementById('refreshPatientFiles');
            if (refreshPatientFiles) {
                refreshPatientFiles.addEventListener('click', () => {
                    loadAssignedPatients();
                });
            }

            console.log('PhysioTech Application initialized successfully!');
        }

        // FIXED: Safe Storage Access (sandbox-compatible)
        function loadSupabaseConnection() {
            try {
                // Test localStorage availability safely
                if (typeof window !== 'undefined' && window.localStorage && testLocalStorage()) {
                    const saved = localStorage.getItem(STORAGE_KEYS.SUPABASE_CONNECTION);
                    if (saved) {
                        try {
                            connectionDetails = JSON.parse(saved);
                            if (connectionDetails && connectionDetails.url && connectionDetails.anonKey) {
                                console.log('üîÑ Restoring saved Supabase connection...');
                                return connectToSupabase(connectionDetails.url, connectionDetails.anonKey, false);
                            } else {
                                console.warn('‚ö†Ô∏è Invalid connection details found in storage');
                                safeRemoveFromStorage(STORAGE_KEYS.SUPABASE_CONNECTION);
                                return false;
                            }
                        } catch (parseError) {
                            console.error('‚ùå Failed to parse saved connection details:', parseError);
                            safeRemoveFromStorage(STORAGE_KEYS.SUPABASE_CONNECTION);
                            return false;
                        }
                    }
                } else {
                    console.log('‚ÑπÔ∏è localStorage not available - using session memory storage');
                    return false;
                }
                return false;
            } catch (error) {
                console.log('‚ÑπÔ∏è Storage access blocked in sandboxed environment - using memory storage');
                return false;
            }
        }

        // Simplified localStorage test function
        function testLocalStorage() {
            try {
                const test = '__localStorage_test__';
                localStorage.setItem(test, 'test');
                localStorage.removeItem(test);
                return true;
            } catch (e) {
                return false;
            }
        }

        // Direct storage access with fallback
        function safeRemoveFromStorage(key) {
            try {
                localStorage.removeItem(key);
                console.log(`üóëÔ∏è Removed ${key} from localStorage`);
            } catch (error) {
                console.log(`‚ÑπÔ∏è Could not remove ${key} from storage:`, error.message);
            }
        }

        // Direct storage setter with fallback
        function safeSetStorage(key, value) {
            try {
                localStorage.setItem(key, value);
                console.log(`üíæ Saved ${key} to localStorage successfully`);
                return true;
            } catch (error) {
                console.log(`‚ÑπÔ∏è Could not save ${key} to storage:`, error.message);
                // Fallback to session storage in memory
                if (!window.memoryStorage) window.memoryStorage = {};
                window.memoryStorage[key] = value;
                console.log(`üíæ Saved ${key} to memory storage as fallback`);
                return false; // Return false to indicate localStorage failed but data was saved
            }
        }

        // Direct storage getter with fallback
        function safeGetStorage(key, defaultValue = null) {
            try {
                const value = localStorage.getItem(key);
                if (value !== null) {
                    console.log(`üìñ Retrieved ${key} from localStorage`);
                    return value;
                }
            } catch (error) {
                console.log(`‚ÑπÔ∏è Could not read ${key} from localStorage:`, error.message);
            }
            
            // Check memory storage fallback
            if (window.memoryStorage && window.memoryStorage[key]) {
                console.log(`üìñ Retrieved ${key} from memory storage`);
                return window.memoryStorage[key];
            }
            
            return defaultValue;
        }

        // FIXED: Connect to Supabase (sandbox-safe error handling)
        function connectToSupabase(url, anonKey, saveConnection = true) {
            try {
                // Validate input parameters
                if (!url || !anonKey) {
                    console.error('‚ùå Missing Supabase connection parameters');
                    showNotification('Missing connection URL or key', 'error');
                    updateConnectionStatus(false);
                    return false;
                }

                // Validate URL format
                try {
                    new URL(url);
                } catch (urlError) {
                    console.error('‚ùå Invalid Supabase URL format:', url);
                    showNotification('Invalid Supabase URL format', 'error');
                    updateConnectionStatus(false);
                    return false;
                }

                // Check if Supabase library is available
                if (!window.supabase) {
                    console.error('‚ùå Supabase library not loaded');
                    showNotification('Supabase library not available - please refresh the page', 'error');
                    updateConnectionStatus(false);
                    return false;
                }

                console.log('üîÑ Attempting to connect to Supabase...');
                console.log('URL:', url.substring(0, 30) + '...');
                
                // Create Supabase client with error handling
                try {
                    supabase = window.supabase.createClient(url, anonKey);
                    console.log('‚úÖ Supabase client created successfully');
                } catch (clientError) {
                    console.error('‚ùå Failed to create Supabase client:', clientError);
                    showNotification('Failed to create database connection', 'error');
                    updateConnectionStatus(false);
                    return false;
                }
                
                // Test the connection with a simple query
                testSupabaseConnection().then(connectionValid => {
                    if (connectionValid) {
                        console.log('‚úÖ Supabase connection test successful');
                        
                        if (saveConnection) {
                            connectionDetails = { url, anonKey };
                            const saved = safeSetStorage(STORAGE_KEYS.SUPABASE_CONNECTION, JSON.stringify(connectionDetails));
                            if (saved) {
                                console.log('üíæ Connection details saved to storage');
                            } else {
                                console.log('‚ÑπÔ∏è Connection will not persist after refresh (storage not available)');
                            }
                        }

                        // Update connection status and show success
                        updateConnectionStatus(true);
                        showNotification('‚úÖ Successfully connected to Supabase database!', 'success');
                        
                        // Load data if connected
                        loadDatabaseData();
                        
                    } else {
                        console.error('‚ùå Supabase connection test failed');
                        updateConnectionStatus(false);
                        showNotification('Database connection test failed - please check credentials', 'error');
                        return false;
                    }
                }).catch(testError => {
                    console.error('‚ùå Connection test error:', testError);
                    updateConnectionStatus(false);
                    showNotification('Connection test failed: ' + testError.message, 'error');
                });
                
                return true;
                
            } catch (error) {
                console.error('‚ùå Supabase connection error:', error);
                showNotification('Failed to connect to Supabase: ' + error.message, 'error');
                updateConnectionStatus(false);
                return false;
            }
        }

        // ===== APPOINTMENT STORAGE FUNCTIONS - SANDBOX-SAFE SYSTEM =====

        // Save Appointment to Storage (sandbox-safe)
        function saveAppointment(appointmentData) {
            try {
                const existingData = safeGetStorage('physiotech_appointments', '[]');
                let appointments = [];
                
                if (existingData && existingData !== '[]') {
                    appointments = JSON.parse(existingData);
                }
                
                appointments.push(appointmentData);
                const saved = safeSetStorage('physiotech_appointments', JSON.stringify(appointments));
                
                if (saved) {
                    console.log('üíæ Appointment saved:', appointmentData);
                } else {
                    console.log('‚ÑπÔ∏è Appointment stored in session (storage not available)');
                    // Store in global variable as fallback
                    if (!window.sessionAppointments) window.sessionAppointments = [];
                    window.sessionAppointments.push(appointmentData);
                }
                
                return true;
            } catch (error) {
                console.error('‚ùå Failed to save appointment:', error);
                // Fallback to session storage
                if (!window.sessionAppointments) window.sessionAppointments = [];
                window.sessionAppointments.push(appointmentData);
                return true;
            }
        }

        // Load All Appointments from Storage (sandbox-safe)
        function loadAllAppointments() {
            try {
                const existingData = safeGetStorage('physiotech_appointments', '[]');
                let appointments = [];
                
                if (existingData && existingData !== '[]') {
                    appointments = JSON.parse(existingData);
                } else if (window.sessionAppointments) {
                    appointments = window.sessionAppointments;
                }
                
                console.log('üìÖ Loaded appointments:', appointments.length);
                return appointments;
            } catch (error) {
                console.error('‚ùå Failed to load appointments:', error);
                // Return session appointments as fallback
                return window.sessionAppointments || [];
            }
        }

        // Missing Function: Update Connection Status
        function updateConnectionStatus(isConnected) {
            const statusElement = document.getElementById('connectionStatus');
            const settingsStatusElement = document.getElementById('settingsConnectionStatus');
            
            if (statusElement) {
                if (isConnected) {
                    statusElement.innerHTML = '<i class="fas fa-circle text-green-400 mr-1"></i>Connected';
                } else {
                    statusElement.innerHTML = '<i class="fas fa-circle text-red-400 mr-1"></i>Disconnected';
                }
            }
            
            if (settingsStatusElement) {
                if (isConnected) {
                    settingsStatusElement.innerHTML = '<i class="fas fa-circle text-green-400 mr-1"></i>Connected to Supabase';
                } else {
                    settingsStatusElement.innerHTML = '<i class="fas fa-circle text-red-400 mr-1"></i>Not Connected';
                }
            }
        }

        // Missing Function: Show Supabase Connection Modal
        function showSupabaseConnectionModal() {
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
            modal.innerHTML = `
                <div class="bg-white dark:bg-gray-800 p-8 rounded-lg shadow-xl max-w-md w-full mx-4">
                    <h2 class="text-2xl font-bold mb-6 text-gray-900 dark:text-white">Connect to Supabase</h2>
                    <form id="supabaseForm">
                        <div class="mb-4">
                            <label class="block text-sm font-medium mb-2">Supabase URL</label>
                            <input type="url" id="supabaseUrl" placeholder="https://your-project.supabase.co" 
                                   class="w-full px-4 py-3 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-base focus:ring-2 focus:ring-primary focus:border-primary">
                        </div>
                        <div class="mb-6">
                            <label class="block text-sm font-medium mb-2">Anonymous Key</label>
                            <textarea id="supabaseKey" placeholder="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9..." 
                                      class="w-full px-4 py-3 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-base focus:ring-2 focus:ring-primary focus:border-primary h-24"></textarea>
                        </div>
                        <div class="flex justify-end space-x-3">
                            <button type="button" onclick="this.closest('.fixed').remove()" 
                                    class="px-4 py-2 text-gray-600 dark:text-gray-400 hover:bg-gray-100 dark:hover:bg-gray-700 rounded">Cancel</button>
                            <button type="submit" class="px-6 py-2 bg-primary text-white hover:bg-secondary rounded">Connect</button>
                        </div>
                    </form>
                </div>
            `;
            
            modal.querySelector('#supabaseForm').addEventListener('submit', (e) => {
                e.preventDefault();
                const url = modal.querySelector('#supabaseUrl').value.trim();
                const key = modal.querySelector('#supabaseKey').value.trim();
                
                if (!url || !key) {
                    showNotification('Please fill in all fields', 'error');
                    return;
                }
                
                const success = connectToSupabase(url, key);
                if (success) {
                    modal.remove();
                }
            });
            
            document.body.appendChild(modal);
        }

        // FIXED: Show Add Appointment Modal with REAL DATA STORAGE
        function showAddAppointmentModal() {
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
            modal.innerHTML = `
                <div class="bg-white dark:bg-gray-800 p-8 rounded-lg shadow-xl max-w-md w-full mx-4">
                    <h2 class="text-2xl font-bold mb-6 text-gray-900 dark:text-white">Schedule New Appointment</h2>
                    <form id="appointmentForm">
                        <div class="mb-4">
                            <label class="block text-sm font-medium mb-2">Patient Name *</label>
                            <input type="text" id="patientName" placeholder="Enter patient name" required
                                   class="w-full px-4 py-3 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-base focus:ring-2 focus:ring-primary focus:border-primary">
                        </div>
                        <div class="mb-4">
                            <label class="block text-sm font-medium mb-2">Patient Email</label>
                            <input type="email" id="patientEmail" placeholder="patient@email.com" 
                                   class="w-full px-4 py-3 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-base focus:ring-2 focus:ring-primary focus:border-primary">
                        </div>
                        <div class="mb-4">
                            <label class="block text-sm font-medium mb-2">Date *</label>
                            <input type="date" id="appointmentDate" required
                                   class="w-full px-4 py-3 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-base focus:ring-2 focus:ring-primary focus:border-primary">
                        </div>
                        <div class="mb-4">
                            <label class="block text-sm font-medium mb-2">Time *</label>
                            <input type="time" id="appointmentTime" required
                                   class="w-full px-4 py-3 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-base focus:ring-2 focus:ring-primary focus:border-primary">
                        </div>
                        <div class="mb-4">
                            <label class="block text-sm font-medium mb-2">Duration</label>
                            <select id="appointmentDuration" 
                                    class="w-full px-4 py-3 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-base focus:ring-2 focus:ring-primary focus:border-primary">
                                <option value="30">30 minutes</option>
                                <option value="45">45 minutes</option>
                                <option value="60" selected>60 minutes</option>
                                <option value="90">90 minutes</option>
                            </select>
                        </div>
                        <div class="mb-4">
                            <label class="block text-sm font-medium mb-2">Assign to Physiotherapist *</label>
                            <select id="appointmentPhysio" required
                                    class="w-full px-4 py-3 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-base focus:ring-2 focus:ring-primary focus:border-primary">
                                <option value="">Select physiotherapist...</option>
                                <option value="mariam-physio-001">Dr. Mariam Abdulatheem Ali</option>
                                <option value="dhari-physio-001">Dr. Dhari Fakhroo</option>
                            </select>
                        </div>
                        <div class="mb-6">
                            <label class="block text-sm font-medium mb-2">Treatment Notes</label>
                            <textarea id="appointmentNotes" placeholder="Treatment plan, special instructions, or patient condition notes..." 
                                      class="w-full px-4 py-3 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-base focus:ring-2 focus:ring-primary focus:border-primary h-20"></textarea>
                        </div>
                        <div class="flex justify-end space-x-3">
                            <button type="button" onclick="this.closest('.fixed').remove()" 
                                    class="px-4 py-2 text-gray-600 dark:text-gray-400 hover:bg-gray-100 dark:hover:bg-gray-700 rounded">Cancel</button>
                            <button type="submit" class="px-6 py-2 bg-primary text-white hover:bg-secondary rounded font-semibold">
                                <i class="fas fa-calendar-plus mr-2"></i>Schedule Appointment
                            </button>
                        </div>
                    </form>
                </div>
            `;
            
            // Set default date to today
            const dateInput = modal.querySelector('#appointmentDate');
            dateInput.value = new Date().toISOString().split('T')[0];
            
            // Handle form submission with REAL DATA STORAGE
            modal.querySelector('#appointmentForm').addEventListener('submit', (e) => {
                e.preventDefault();
                
                const patientName = modal.querySelector('#patientName').value.trim();
                const patientEmail = modal.querySelector('#patientEmail').value.trim();
                const date = modal.querySelector('#appointmentDate').value;
                const time = modal.querySelector('#appointmentTime').value;
                const duration = modal.querySelector('#appointmentDuration').value;
                const physioId = modal.querySelector('#appointmentPhysio').value;
                const notes = modal.querySelector('#appointmentNotes').value.trim();
                
                if (!patientName || !date || !time || !physioId) {
                    showNotification('‚ùå Please fill in all required fields', 'error');
                    return;
                }
                
                // CREATE AND STORE THE APPOINTMENT
                const appointmentData = {
                    id: 'appt-' + Date.now(), // Unique ID
                    patientName: patientName,
                    patientEmail: patientEmail,
                    date: date,
                    time: time,
                    duration: parseInt(duration),
                    physioId: physioId,
                    physioName: physioId === 'mariam-physio-001' ? 'Dr. Mariam Abdulatheem Ali' : 'Dr. Dhari Fakhroo',
                    notes: notes,
                    status: 'scheduled',
                    createdBy: currentUser?.email || 'admin',
                    createdAt: new Date().toISOString()
                };
                
                // Store appointment in localStorage
                saveAppointment(appointmentData);
                
                // Show success notification
                const physioName = appointmentData.physioName;
                showNotification(`‚úÖ Appointment for ${patientName} scheduled with ${physioName}!`, 'success');
                
                // Additional confirmation
                setTimeout(() => {
                    showNotification(`üìß Appointment details will be sent to ${physioName}`, 'success');
                }, 1000);
                
                modal.remove();
                
                // Refresh appointments view if currently showing
                if (currentView === 'appointments') {
                    loadAllAppointments();
                }
            });
            
            document.body.appendChild(modal);
        }

        // Missing Function: Show Add Patient Modal - COMPREHENSIVE VERSION
        function showAddPatientModal() {
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 overflow-y-auto';
            modal.innerHTML = `
                <div class="bg-slate-800 text-white p-8 rounded-xl shadow-2xl max-w-4xl w-full mx-4 my-8 max-h-[95vh] overflow-y-auto">
                    <!-- Header -->
                    <div class="flex items-center justify-between mb-8">
                        <h2 class="text-3xl font-bold flex items-center">
                            <i class="fas fa-user-plus text-primary mr-3"></i>Add New Patient
                        </h2>
                        <button onclick="this.closest('.fixed').remove()" class="text-gray-400 hover:text-white text-2xl">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>

                    <form id="patientForm" class="space-y-8">
                        <!-- Personal Information Section -->
                        <div class="bg-slate-700 rounded-lg p-6">
                            <h3 class="text-xl font-semibold mb-6 flex items-center text-primary">
                                <i class="fas fa-user mr-3"></i>Personal Information
                            </h3>
                            
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                                <div>
                                    <label class="block text-sm font-medium mb-2 text-white">First Name *</label>
                                    <input type="text" id="firstName" placeholder="Enter first name" required
                                           class="w-full px-4 py-3 bg-slate-600 border border-slate-500 rounded-lg text-white text-base placeholder-gray-400 focus:ring-2 focus:ring-primary focus:border-primary">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium mb-2 text-white">Last Name *</label>
                                    <input type="text" id="lastName" placeholder="Enter last name" required
                                           class="w-full px-4 py-3 bg-slate-600 border border-slate-500 rounded-lg text-white text-base placeholder-gray-400 focus:ring-2 focus:ring-primary focus:border-primary">
                                </div>
                            </div>
                            
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                                <div>
                                    <label class="block text-sm font-medium mb-2 text-white">Email</label>
                                    <input type="email" id="patientEmail" placeholder="patient@email.com" 
                                           class="w-full px-4 py-3 bg-slate-600 border border-slate-500 rounded-lg text-white text-base placeholder-gray-400 focus:ring-2 focus:ring-primary focus:border-primary">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium mb-2 text-white">Phone Number</label>
                                    <input type="tel" id="patientPhone" placeholder="97123456" 
                                           class="w-full px-4 py-3 bg-slate-600 border border-slate-500 rounded-lg text-white text-base placeholder-gray-400 focus:ring-2 focus:ring-primary focus:border-primary">
                                </div>
                            </div>
                            
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                                <div>
                                    <label class="block text-sm font-medium mb-2 text-white">CPR Number</label>
                                    <input type="text" id="cprNumber" placeholder="001000853" 
                                           class="w-full px-4 py-3 bg-slate-600 border border-slate-500 rounded-lg text-white text-base placeholder-gray-400 focus:ring-2 focus:ring-primary focus:border-primary">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium mb-2 text-white">Date of Birth</label>
                                    <input type="date" id="dateOfBirth" 
                                           class="w-full px-4 py-3 bg-slate-600 border border-slate-500 rounded-lg text-white text-base placeholder-gray-400 focus:ring-2 focus:ring-primary focus:border-primary">
                                </div>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium mb-2 text-white">Address</label>
                                <textarea id="patientAddress" placeholder="Patient address" rows="2"
                                          class="w-full px-4 py-3 bg-slate-600 border border-slate-500 rounded-lg text-white text-base placeholder-gray-400 focus:ring-2 focus:ring-primary focus:border-primary"></textarea>
                            </div>
                        </div>

                        <!-- Medical Information Section -->
                        <div class="bg-slate-700 rounded-lg p-6">
                            <h3 class="text-xl font-semibold mb-6 flex items-center text-primary">
                                <i class="fas fa-heartbeat mr-3"></i>Medical Information
                            </h3>
                            
                            <div class="mb-4">
                                <label class="block text-sm font-medium mb-2 text-white">Medical History</label>
                                <textarea id="medicalHistory" placeholder="Enter any relevant medical history, conditions, allergies, or previous treatments..." rows="4"
                                          class="w-full px-4 py-3 bg-slate-600 border border-slate-500 rounded-lg text-white text-base placeholder-gray-400 focus:ring-2 focus:ring-primary focus:border-primary"></textarea>
                            </div>
                            
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-medium mb-2 text-white">Emergency Contact Name</label>
                                    <input type="text" id="emergencyName" placeholder="Emergency contact name" 
                                           class="w-full px-4 py-3 bg-slate-600 border border-slate-500 rounded-lg text-white text-base placeholder-gray-400 focus:ring-2 focus:ring-primary focus:border-primary">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium mb-2 text-white">Emergency Contact Phone</label>
                                    <input type="tel" id="emergencyPhone" placeholder="97123456" 
                                           class="w-full px-4 py-3 bg-slate-600 border border-slate-500 rounded-lg text-white text-base placeholder-gray-400 focus:ring-2 focus:ring-primary focus:border-primary">
                                </div>
                            </div>
                        </div>

                        <!-- Physiotherapist Assignment Section -->
                        <div class="bg-slate-700 rounded-lg p-6">
                            <h3 class="text-xl font-semibold mb-6 flex items-center text-primary">
                                <i class="fas fa-user-md mr-3"></i>Physiotherapist Assignment
                            </h3>
                            
                            <div class="mb-4">
                                <label class="block text-sm font-medium mb-2 text-white">Assign to Physiotherapist (Optional)</label>
                                <select id="assignPhysiotherapist" 
                                        class="w-full px-4 py-3 bg-slate-600 border border-slate-500 rounded-lg text-white text-base focus:ring-2 focus:ring-primary focus:border-primary">
                                    <option value="">Select a physiotherapist (optional)...</option>
                                    <option value="mariam-physio-001">Dr. Mariam Abdulatheem Ali</option>
                                    <option value="dhari-physio-001">Dr. Dhari Fakhroo</option>
                                </select>
                                <p class="text-sm text-gray-400 mt-2">
                                    <i class="fas fa-info-circle mr-1"></i>If selected, this physiotherapist will immediately have access to this patient's file in their dashboard.
                                </p>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium mb-2 text-white">Assignment Notes</label>
                                <textarea id="assignmentNotes" placeholder="Special instructions or notes for the assigned physiotherapist..." rows="3"
                                          class="w-full px-4 py-3 bg-slate-600 border border-slate-500 rounded-lg text-white text-base placeholder-gray-400 focus:ring-2 focus:ring-primary focus:border-primary"></textarea>
                            </div>
                        </div>

                        <!-- Treatment Tracking Section -->
                        <div class="bg-slate-700 rounded-lg p-6">
                            <h3 class="text-xl font-semibold mb-6 flex items-center text-primary">
                                <i class="fas fa-clipboard-check mr-3"></i>Treatment Tracking
                            </h3>
                            
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div class="flex items-center p-4 bg-slate-600 rounded-lg">
                                    <i class="fas fa-calculator text-2xl text-gray-400 mr-4"></i>
                                    <div>
                                        <p class="text-sm text-gray-400">Total Sessions</p>
                                        <p class="text-2xl font-bold">0</p>
                                        <p class="text-xs text-gray-500">Automatically calculated from treatments</p>
                                    </div>
                                </div>
                                <div class="flex items-center p-4 bg-slate-600 rounded-lg">
                                    <i class="fas fa-clock text-2xl text-gray-400 mr-4"></i>
                                    <div>
                                        <p class="text-sm text-gray-400">Last Session Date</p>
                                        <p class="text-lg font-semibold">No sessions yet</p>
                                        <p class="text-xs text-gray-500">Date of most recent treatment</p>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Generate Treatment Document Section -->
                        <div class="bg-gradient-to-r from-blue-900 to-blue-800 rounded-lg p-6 border border-blue-700">
                            <div class="flex items-center justify-between">
                                <div>
                                    <h3 class="text-xl font-semibold mb-2 text-white">Generate Treatment Document</h3>
                                    <p class="text-blue-200">Create a professional treatment form template</p>
                                </div>
                                <button type="button" onclick="generateTreatmentTemplate()" 
                                        class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-3 rounded-lg font-semibold flex items-center transition-colors shadow-lg">
                                    <i class="fas fa-file-medical mr-2"></i>Generate Template
                                </button>
                            </div>
                        </div>

                        <!-- Upload Treatment Documents Section -->
                        <div class="bg-slate-700 rounded-lg p-6">
                            <h3 class="text-xl font-semibold mb-4 text-white">Upload Treatment Documents</h3>
                            
                            <div class="border-2 border-dashed border-slate-500 rounded-lg p-8 text-center hover:border-primary transition-colors">
                                <i class="fas fa-cloud-upload-alt text-4xl text-gray-400 mb-4"></i>
                                <p class="text-gray-300 mb-2">Upload completed treatment documents</p>
                                <button type="button" onclick="document.getElementById('treatmentDocuments').click()" 
                                        class="bg-primary hover:bg-secondary text-white px-6 py-3 rounded-lg font-semibold flex items-center mx-auto transition-colors">
                                    <i class="fas fa-folder mr-2"></i>Choose Documents
                                </button>
                                <p class="text-sm text-gray-500 mt-3">DOC, DOCX, PDF up to 10MB each</p>
                                <input type="file" id="treatmentDocuments" multiple accept=".doc,.docx,.pdf" class="hidden">
                            </div>
                        </div>

                        <!-- Patient Media Section -->
                        <div class="bg-slate-700 rounded-lg p-6">
                            <h3 class="text-xl font-semibold mb-6 flex items-center text-primary">
                                <i class="fas fa-camera mr-3"></i>Patient Media
                            </h3>
                            
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                <!-- Profile Photo -->
                                <div>
                                    <h4 class="font-semibold mb-4 text-white">Profile Photo</h4>
                                    <div class="border-2 border-dashed border-slate-500 rounded-lg p-6 text-center hover:border-primary transition-colors">
                                        <div class="w-24 h-24 bg-slate-600 rounded-full mx-auto mb-4 flex items-center justify-center">
                                            <i class="fas fa-camera text-3xl text-gray-400"></i>
                                        </div>
                                        <button type="button" onclick="document.getElementById('profilePhoto').click()" 
                                                class="bg-primary hover:bg-secondary text-white px-4 py-2 rounded-lg font-semibold flex items-center mx-auto transition-colors">
                                            <i class="fas fa-upload mr-2"></i>Upload Photo
                                        </button>
                                        <p class="text-xs text-gray-500 mt-2">JPG, PNG, GIF up to 5MB</p>
                                        <input type="file" id="profilePhoto" accept="image/*" class="hidden">
                                    </div>
                                </div>
                                
                                <!-- Patient Video -->
                                <div>
                                    <h4 class="font-semibold mb-4 text-white">Patient Video</h4>
                                    <div class="border-2 border-dashed border-primary rounded-lg p-6 text-center hover:border-secondary transition-colors">
                                        <i class="fas fa-video text-4xl text-primary mb-4"></i>
                                        <button type="button" onclick="document.getElementById('patientVideo').click()" 
                                                class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg font-semibold flex items-center mx-auto transition-colors">
                                            <i class="fas fa-upload mr-2"></i>Upload Video
                                        </button>
                                        <p class="text-xs text-gray-500 mt-2">MP4, AVI, MOV up to 50MB</p>
                                        <input type="file" id="patientVideo" accept="video/*" class="hidden">
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Form Actions -->
                        <div class="flex justify-end space-x-4 pt-6 border-t border-slate-600">
                            <button type="button" onclick="this.closest('.fixed').remove()" 
                                    class="px-8 py-3 text-gray-400 hover:text-white hover:bg-slate-600 rounded-lg transition-colors font-semibold">
                                Cancel
                            </button>
                            <button type="submit" 
                                    class="px-8 py-3 bg-gradient-to-r from-primary to-secondary text-white hover:from-secondary hover:to-primary rounded-lg font-semibold transition-all duration-200 shadow-lg">
                                <i class="fas fa-user-plus mr-2"></i>Add Patient
                            </button>
                        </div>
                    </form>
                </div>
            `;
            
            // Handle file uploads
            const treatmentDocsInput = modal.querySelector('#treatmentDocuments');
            const profilePhotoInput = modal.querySelector('#profilePhoto');
            const patientVideoInput = modal.querySelector('#patientVideo');
            
            treatmentDocsInput.addEventListener('change', (e) => {
                const files = Array.from(e.target.files);
                if (files.length > 0) {
                    showNotification(`${files.length} treatment document(s) selected`, 'success');
                }
            });
            
            profilePhotoInput.addEventListener('change', (e) => {
                const file = e.target.files[0];
                if (file) {
                    showNotification('Profile photo selected: ' + file.name, 'success');
                }
            });
            
            patientVideoInput.addEventListener('change', (e) => {
                const file = e.target.files[0];
                if (file) {
                    showNotification('Patient video selected: ' + file.name, 'success');
                }
            });
            
            // Handle form submission
            modal.querySelector('#patientForm').addEventListener('submit', (e) => {
                e.preventDefault();
                
                const firstName = modal.querySelector('#firstName').value;
                const lastName = modal.querySelector('#lastName').value;
                
                if (!firstName || !lastName) {
                    showNotification('Please fill in the required fields (First Name and Last Name)', 'error');
                    return;
                }
                
                // Collect all form data
                const assignedPhysio = modal.querySelector('#assignPhysiotherapist').value;
                const patientData = {
                    id: 'patient-' + Date.now(), // Unique patient ID
                    firstName: firstName,
                    lastName: lastName,
                    fullName: `${firstName} ${lastName}`,
                    email: modal.querySelector('#patientEmail').value,
                    phone: modal.querySelector('#patientPhone').value,
                    cpr: modal.querySelector('#cprNumber').value,
                    dateOfBirth: modal.querySelector('#dateOfBirth').value,
                    address: modal.querySelector('#patientAddress').value,
                    medicalHistory: modal.querySelector('#medicalHistory').value,
                    emergencyName: modal.querySelector('#emergencyName').value,
                    emergencyPhone: modal.querySelector('#emergencyPhone').value,
                    assignedPhysio: assignedPhysio,
                    assignmentNotes: modal.querySelector('#assignmentNotes').value,
                    createdBy: currentUser?.email || 'admin',
                    createdAt: new Date().toISOString(),
                    lastModified: new Date().toISOString(),
                    status: 'active',
                    treatmentSessions: 0,
                    lastSessionDate: null
                };
                
                // Save patient to shared storage system
                const saved = savePatientToSystem(patientData);
                
                if (saved) {
                    console.log('üíæ New patient data saved:', patientData);
                    showNotification(`‚úÖ Patient ${firstName} ${lastName} added successfully!`, 'success');
                    
                    // If assigned to a physiotherapist, show assignment confirmation
                    if (assignedPhysio) {
                        const physioName = assignedPhysio === 'mariam-physio-001' ? 'Dr. Mariam Abdulatheem Ali' : 'Dr. Dhari Fakhroo';
                        setTimeout(() => {
                            showNotification(`üë©‚Äç‚öïÔ∏è Patient assigned to ${physioName} - Available in their dashboard now!`, 'success');
                        }, 1000);
                    }
                } else {
                    showNotification('‚ö†Ô∏è Patient saved to session storage (storage limitations)', 'success');
                }
                
                modal.remove();
            });
            
            document.body.appendChild(modal);
        }

        // ===== COMPREHENSIVE ADD PHYSIOTHERAPIST MODAL - PROFESSIONAL SYSTEM =====
        function showAddPhysiotherapistModal() {
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 overflow-y-auto';
            modal.innerHTML = `
                <div class="bg-slate-800 text-white p-8 rounded-xl shadow-2xl max-w-6xl w-full mx-4 my-8 max-h-[95vh] overflow-y-auto">
                    <!-- Header -->
                    <div class="flex items-center justify-between mb-8">
                        <h2 class="text-3xl font-bold flex items-center">
                            <i class="fas fa-user-md text-secondary mr-3"></i>Add New Physiotherapist
                        </h2>
                        <button onclick="this.closest('.fixed').remove()" class="text-gray-400 hover:text-white text-2xl">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>

                    <form id="comprehensivePhysioForm" class="space-y-8">
                        <!-- Personal Information Section -->
                        <div class="bg-slate-700 rounded-lg p-6">
                            <h3 class="text-xl font-semibold mb-6 flex items-center text-secondary">
                                <i class="fas fa-user mr-3"></i>Personal Information
                            </h3>
                            
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                                <div>
                                    <label class="block text-sm font-medium mb-2 text-white">Title *</label>
                                    <select id="physioTitle" required
                                            class="w-full px-4 py-3 bg-slate-600 border border-slate-500 rounded-lg text-white text-base focus:ring-2 focus:ring-secondary focus:border-secondary">
                                        <option value="">Select title...</option>
                                        <option value="Dr">Dr.</option>
                                        <option value="Mr">Mr.</option>
                                        <option value="Mrs">Mrs.</option>
                                        <option value="Ms">Ms.</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium mb-2 text-white">First Name *</label>
                                    <input type="text" id="physioFirstName" placeholder="Enter first name" required
                                           class="w-full px-4 py-3 bg-slate-600 border border-slate-500 rounded-lg text-white text-base placeholder-gray-400 focus:ring-2 focus:ring-secondary focus:border-secondary">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium mb-2 text-white">Last Name *</label>
                                    <input type="text" id="physioLastName" placeholder="Enter last name" required
                                           class="w-full px-4 py-3 bg-slate-600 border border-slate-500 rounded-lg text-white text-base placeholder-gray-400 focus:ring-2 focus:ring-secondary focus:border-secondary">
                                </div>
                            </div>
                            
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                                <div>
                                    <label class="block text-sm font-medium mb-2 text-white">Date of Birth</label>
                                    <input type="date" id="physioBirthDate" 
                                           class="w-full px-4 py-3 bg-slate-600 border border-slate-500 rounded-lg text-white text-base focus:ring-2 focus:ring-secondary focus:border-secondary">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium mb-2 text-white">Gender</label>
                                    <select id="physioGender"
                                            class="w-full px-4 py-3 bg-slate-600 border border-slate-500 rounded-lg text-white text-base focus:ring-2 focus:ring-secondary focus:border-secondary">
                                        <option value="">Select gender...</option>
                                        <option value="male">Male</option>
                                        <option value="female">Female</option>
                                        <option value="other">Other</option>
                                        <option value="prefer-not-to-say">Prefer not to say</option>
                                    </select>
                                </div>
                            </div>
                            
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-medium mb-2 text-white">Nationality</label>
                                    <input type="text" id="physioNationality" placeholder="e.g., Bahraini, Indian, Filipino" 
                                           class="w-full px-4 py-3 bg-slate-600 border border-slate-500 rounded-lg text-white text-base placeholder-gray-400 focus:ring-2 focus:ring-secondary focus:border-secondary">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium mb-2 text-white">CPR/ID Number</label>
                                    <input type="text" id="physioCpr" placeholder="Enter CPR/ID number" 
                                           class="w-full px-4 py-3 bg-slate-600 border border-slate-500 rounded-lg text-white text-base placeholder-gray-400 focus:ring-2 focus:ring-secondary focus:border-secondary">
                                </div>
                            </div>
                        </div>

                        <!-- Contact Information Section -->
                        <div class="bg-slate-700 rounded-lg p-6">
                            <h3 class="text-xl font-semibold mb-6 flex items-center text-secondary">
                                <i class="fas fa-address-book mr-3"></i>Contact Information
                            </h3>
                            
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                                <div>
                                    <label class="block text-sm font-medium mb-2 text-white">Primary Email *</label>
                                    <input type="email" id="physioEmail" placeholder="physiotherapist@email.com" required
                                           class="w-full px-4 py-3 bg-slate-600 border border-slate-500 rounded-lg text-white text-base placeholder-gray-400 focus:ring-2 focus:ring-secondary focus:border-secondary">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium mb-2 text-white">Secondary Email</label>
                                    <input type="email" id="physioSecondaryEmail" placeholder="personal@email.com" 
                                           class="w-full px-4 py-3 bg-slate-600 border border-slate-500 rounded-lg text-white text-base placeholder-gray-400 focus:ring-2 focus:ring-secondary focus:border-secondary">
                                </div>
                            </div>
                            
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                                <div>
                                    <label class="block text-sm font-medium mb-2 text-white">Primary Phone *</label>
                                    <input type="tel" id="physioPhone" placeholder="97123456" required
                                           class="w-full px-4 py-3 bg-slate-600 border border-slate-500 rounded-lg text-white text-base placeholder-gray-400 focus:ring-2 focus:ring-secondary focus:border-secondary">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium mb-2 text-white">WhatsApp Number</label>
                                    <input type="tel" id="physioWhatsapp" placeholder="97123456" 
                                           class="w-full px-4 py-3 bg-slate-600 border border-slate-500 rounded-lg text-white text-base placeholder-gray-400 focus:ring-2 focus:ring-secondary focus:border-secondary">
                                </div>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium mb-2 text-white">Address</label>
                                <textarea id="physioAddress" placeholder="Full residential address" rows="3"
                                          class="w-full px-4 py-3 bg-slate-600 border border-slate-500 rounded-lg text-white text-base placeholder-gray-400 focus:ring-2 focus:ring-secondary focus:border-secondary"></textarea>
                            </div>
                        </div>

                        <!-- Professional Credentials Section -->
                        <div class="bg-slate-700 rounded-lg p-6">
                            <h3 class="text-xl font-semibold mb-6 flex items-center text-secondary">
                                <i class="fas fa-certificate mr-3"></i>Professional Credentials
                            </h3>
                            
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                                <div>
                                    <label class="block text-sm font-medium mb-2 text-white">License Number *</label>
                                    <input type="text" id="physioLicense" placeholder="PT-2024-XXX" required
                                           class="w-full px-4 py-3 bg-slate-600 border border-slate-500 rounded-lg text-white text-base placeholder-gray-400 focus:ring-2 focus:ring-secondary focus:border-secondary">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium mb-2 text-white">License Expiry Date</label>
                                    <input type="date" id="physioLicenseExpiry" 
                                           class="w-full px-4 py-3 bg-slate-600 border border-slate-500 rounded-lg text-white text-base focus:ring-2 focus:ring-secondary focus:border-secondary">
                                </div>
                            </div>
                            
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                                <div>
                                    <label class="block text-sm font-medium mb-2 text-white">Years of Experience *</label>
                                    <input type="number" id="physioExperience" placeholder="5" min="0" max="50" required
                                           class="w-full px-4 py-3 bg-slate-600 border border-slate-500 rounded-lg text-white text-base placeholder-gray-400 focus:ring-2 focus:ring-secondary focus:border-secondary">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium mb-2 text-white">Registration Body</label>
                                    <input type="text" id="physioRegistrationBody" placeholder="e.g., National Health Regulatory Authority" 
                                           class="w-full px-4 py-3 bg-slate-600 border border-slate-500 rounded-lg text-white text-base placeholder-gray-400 focus:ring-2 focus:ring-secondary focus:border-secondary">
                                </div>
                            </div>
                            
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-medium mb-2 text-white">Degree/Qualification</label>
                                    <input type="text" id="physioDegree" placeholder="e.g., Bachelor of Physiotherapy" 
                                           class="w-full px-4 py-3 bg-slate-600 border border-slate-500 rounded-lg text-white text-base placeholder-gray-400 focus:ring-2 focus:ring-secondary focus:border-secondary">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium mb-2 text-white">University/Institution</label>
                                    <input type="text" id="physioUniversity" placeholder="e.g., University of Bahrain" 
                                           class="w-full px-4 py-3 bg-slate-600 border border-slate-500 rounded-lg text-white text-base placeholder-gray-400 focus:ring-2 focus:ring-secondary focus:border-secondary">
                                </div>
                            </div>
                        </div>

                        <!-- Specializations & Skills Section -->
                        <div class="bg-slate-700 rounded-lg p-6">
                            <h3 class="text-xl font-semibold mb-6 flex items-center text-secondary">
                                <i class="fas fa-stethoscope mr-3"></i>Specializations & Skills
                            </h3>
                            
                            <div class="mb-4">
                                <label class="block text-sm font-medium mb-3 text-white">Primary Specializations *</label>
                                <div class="grid grid-cols-2 md:grid-cols-3 gap-3">
                                    <label class="flex items-center p-3 bg-slate-600 rounded-lg hover:bg-slate-500 cursor-pointer">
                                        <input type="checkbox" name="specializations" value="orthopedic" class="mr-3">
                                        <span>Orthopedic</span>
                                    </label>
                                    <label class="flex items-center p-3 bg-slate-600 rounded-lg hover:bg-slate-500 cursor-pointer">
                                        <input type="checkbox" name="specializations" value="sports-medicine" class="mr-3">
                                        <span>Sports Medicine</span>
                                    </label>
                                    <label class="flex items-center p-3 bg-slate-600 rounded-lg hover:bg-slate-500 cursor-pointer">
                                        <input type="checkbox" name="specializations" value="neurological" class="mr-3">
                                        <span>Neurological</span>
                                    </label>
                                    <label class="flex items-center p-3 bg-slate-600 rounded-lg hover:bg-slate-500 cursor-pointer">
                                        <input type="checkbox" name="specializations" value="pediatric" class="mr-3">
                                        <span>Pediatric</span>
                                    </label>
                                    <label class="flex items-center p-3 bg-slate-600 rounded-lg hover:bg-slate-500 cursor-pointer">
                                        <input type="checkbox" name="specializations" value="geriatric" class="mr-3">
                                        <span>Geriatric</span>
                                    </label>
                                    <label class="flex items-center p-3 bg-slate-600 rounded-lg hover:bg-slate-500 cursor-pointer">
                                        <input type="checkbox" name="specializations" value="manual-therapy" class="mr-3">
                                        <span>Manual Therapy</span>
                                    </label>
                                    <label class="flex items-center p-3 bg-slate-600 rounded-lg hover:bg-slate-500 cursor-pointer">
                                        <input type="checkbox" name="specializations" value="cardiopulmonary" class="mr-3">
                                        <span>Cardiopulmonary</span>
                                    </label>
                                    <label class="flex items-center p-3 bg-slate-600 rounded-lg hover:bg-slate-500 cursor-pointer">
                                        <input type="checkbox" name="specializations" value="women-health" class="mr-3">
                                        <span>Women's Health</span>
                                    </label>
                                    <label class="flex items-center p-3 bg-slate-600 rounded-lg hover:bg-slate-500 cursor-pointer">
                                        <input type="checkbox" name="specializations" value="aquatic" class="mr-3">
                                        <span>Aquatic Therapy</span>
                                    </label>
                                </div>
                            </div>
                            
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-medium mb-2 text-white">Languages Spoken</label>
                                    <input type="text" id="physioLanguages" placeholder="e.g., English, Arabic, Hindi" 
                                           class="w-full px-4 py-3 bg-slate-600 border border-slate-500 rounded-lg text-white text-base placeholder-gray-400 focus:ring-2 focus:ring-secondary focus:border-secondary">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium mb-2 text-white">Additional Certifications</label>
                                    <input type="text" id="physioAdditionalCerts" placeholder="e.g., Dry Needling, McKenzie Method" 
                                           class="w-full px-4 py-3 bg-slate-600 border border-slate-500 rounded-lg text-white text-base placeholder-gray-400 focus:ring-2 focus:ring-secondary focus:border-secondary">
                                </div>
                            </div>
                        </div>

                        <!-- Employment Details Section -->
                        <div class="bg-slate-700 rounded-lg p-6">
                            <h3 class="text-xl font-semibold mb-6 flex items-center text-secondary">
                                <i class="fas fa-briefcase mr-3"></i>Employment Details
                            </h3>
                            
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                                <div>
                                    <label class="block text-sm font-medium mb-2 text-white">Employment Type *</label>
                                    <select id="physioEmploymentType" required
                                            class="w-full px-4 py-3 bg-slate-600 border border-slate-500 rounded-lg text-white text-base focus:ring-2 focus:ring-secondary focus:border-secondary">
                                        <option value="">Select employment type...</option>
                                        <option value="full-time">Full-time</option>
                                        <option value="part-time">Part-time</option>
                                        <option value="contract">Contract</option>
                                        <option value="consultant">Consultant</option>
                                        <option value="locum">Locum</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium mb-2 text-white">Start Date *</label>
                                    <input type="date" id="physioStartDate" required
                                           class="w-full px-4 py-3 bg-slate-600 border border-slate-500 rounded-lg text-white text-base focus:ring-2 focus:ring-secondary focus:border-secondary">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium mb-2 text-white">Department</label>
                                    <select id="physioDepartment"
                                            class="w-full px-4 py-3 bg-slate-600 border border-slate-500 rounded-lg text-white text-base focus:ring-2 focus:ring-secondary focus:border-secondary">
                                        <option value="">Select department...</option>
                                        <option value="outpatient">Outpatient Physiotherapy</option>
                                        <option value="inpatient">Inpatient Physiotherapy</option>
                                        <option value="sports-medicine">Sports Medicine</option>
                                        <option value="pediatric-rehab">Pediatric Rehabilitation</option>
                                        <option value="neuro-rehab">Neurological Rehabilitation</option>
                                    </select>
                                </div>
                            </div>
                            
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-medium mb-2 text-white">Reporting Manager</label>
                                    <input type="text" id="physioManager" placeholder="Name of direct supervisor" 
                                           class="w-full px-4 py-3 bg-slate-600 border border-slate-500 rounded-lg text-white text-base placeholder-gray-400 focus:ring-2 focus:ring-secondary focus:border-secondary">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium mb-2 text-white">Employee ID</label>
                                    <input type="text" id="physioEmployeeId" placeholder="Auto-generated or custom ID" 
                                           class="w-full px-4 py-3 bg-slate-600 border border-slate-500 rounded-lg text-white text-base placeholder-gray-400 focus:ring-2 focus:ring-secondary focus:border-secondary">
                                </div>
                            </div>
                        </div>

                        <!-- System Access & Permissions Section -->
                        <div class="bg-slate-700 rounded-lg p-6">
                            <h3 class="text-xl font-semibold mb-6 flex items-center text-secondary">
                                <i class="fas fa-key mr-3"></i>System Access & Permissions
                            </h3>
                            
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                                <div>
                                    <label class="block text-sm font-medium mb-2 text-white">Username *</label>
                                    <input type="text" id="physioUsername" placeholder="Create unique username" required
                                           class="w-full px-4 py-3 bg-slate-600 border border-slate-500 rounded-lg text-white text-base placeholder-gray-400 focus:ring-2 focus:ring-secondary focus:border-secondary">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium mb-2 text-white">Login Email *</label>
                                    <input type="email" id="physioLoginEmail" placeholder="Login email address" required
                                           class="w-full px-4 py-3 bg-slate-600 border border-slate-500 rounded-lg text-white text-base placeholder-gray-400 focus:ring-2 focus:ring-secondary focus:border-secondary">
                                </div>
                            </div>
                            
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                                <div>
                                    <label class="block text-sm font-medium mb-2 text-white">Password *</label>
                                    <input type="password" id="physioPassword" placeholder="Create secure password" required
                                           class="w-full px-4 py-3 bg-slate-600 border border-slate-500 rounded-lg text-white text-base placeholder-gray-400 focus:ring-2 focus:ring-secondary focus:border-secondary">
                                    <p class="text-xs text-gray-400 mt-1">Minimum 8 characters with letters and numbers</p>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium mb-2 text-white">Confirm Password *</label>
                                    <input type="password" id="physioConfirmPassword" placeholder="Confirm password" required
                                           class="w-full px-4 py-3 bg-slate-600 border border-slate-500 rounded-lg text-white text-base placeholder-gray-400 focus:ring-2 focus:ring-secondary focus:border-secondary">
                                </div>
                            </div>
                            
                            <div class="mb-4">
                                <label class="block text-sm font-medium mb-3 text-white">System Permissions</label>
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                                    <label class="flex items-center p-3 bg-slate-600 rounded-lg cursor-pointer">
                                        <input type="checkbox" name="permissions" value="view-patients" class="mr-3" checked>
                                        <span>View Assigned Patients</span>
                                    </label>
                                    <label class="flex items-center p-3 bg-slate-600 rounded-lg cursor-pointer">
                                        <input type="checkbox" name="permissions" value="update-treatments" class="mr-3" checked>
                                        <span>Update Treatment Records</span>
                                    </label>
                                    <label class="flex items-center p-3 bg-slate-600 rounded-lg cursor-pointer">
                                        <input type="checkbox" name="permissions" value="schedule-appointments" class="mr-3">
                                        <span>Schedule Appointments</span>
                                    </label>
                                    <label class="flex items-center p-3 bg-slate-600 rounded-lg cursor-pointer">
                                        <input type="checkbox" name="permissions" value="view-reports" class="mr-3">
                                        <span>View Reports</span>
                                    </label>
                                </div>
                            </div>
                        </div>

                        <!-- Emergency Contact Section -->
                        <div class="bg-slate-700 rounded-lg p-6">
                            <h3 class="text-xl font-semibold mb-6 flex items-center text-secondary">
                                <i class="fas fa-phone-alt mr-3"></i>Emergency Contact
                            </h3>
                            
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-medium mb-2 text-white">Emergency Contact Name</label>
                                    <input type="text" id="physioEmergencyName" placeholder="Full name of emergency contact" 
                                           class="w-full px-4 py-3 bg-slate-600 border border-slate-500 rounded-lg text-white text-base placeholder-gray-400 focus:ring-2 focus:ring-secondary focus:border-secondary">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium mb-2 text-white">Relationship</label>
                                    <input type="text" id="physioEmergencyRelation" placeholder="e.g., Spouse, Parent, Sibling" 
                                           class="w-full px-4 py-3 bg-slate-600 border border-slate-500 rounded-lg text-white text-base placeholder-gray-400 focus:ring-2 focus:ring-secondary focus:border-secondary">
                                </div>
                            </div>
                            
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-4">
                                <div>
                                    <label class="block text-sm font-medium mb-2 text-white">Emergency Contact Phone</label>
                                    <input type="tel" id="physioEmergencyPhone" placeholder="97123456" 
                                           class="w-full px-4 py-3 bg-slate-600 border border-slate-500 rounded-lg text-white text-base placeholder-gray-400 focus:ring-2 focus:ring-secondary focus:border-secondary">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium mb-2 text-white">Emergency Contact Email</label>
                                    <input type="email" id="physioEmergencyEmail" placeholder="emergency@email.com" 
                                           class="w-full px-4 py-3 bg-slate-600 border border-slate-500 rounded-lg text-white text-base placeholder-gray-400 focus:ring-2 focus:ring-secondary focus:border-secondary">
                                </div>
                            </div>
                        </div>

                        <!-- Notes & Additional Information Section -->
                        <div class="bg-slate-700 rounded-lg p-6">
                            <h3 class="text-xl font-semibold mb-6 flex items-center text-secondary">
                                <i class="fas fa-sticky-note mr-3"></i>Notes & Additional Information
                            </h3>
                            
                            <div class="space-y-4">
                                <div>
                                    <label class="block text-sm font-medium mb-2 text-white">Clinical Notes</label>
                                    <textarea id="physioClinicalNotes" placeholder="Any special clinical considerations, previous experience, or notable achievements..." rows="3"
                                              class="w-full px-4 py-3 bg-slate-600 border border-slate-500 rounded-lg text-white text-base placeholder-gray-400 focus:ring-2 focus:ring-secondary focus:border-secondary"></textarea>
                                </div>
                                
                                <div>
                                    <label class="block text-sm font-medium mb-2 text-white">Administrative Notes</label>
                                    <textarea id="physioAdminNotes" placeholder="Internal notes for HR and management purposes..." rows="3"
                                              class="w-full px-4 py-3 bg-slate-600 border border-slate-500 rounded-lg text-white text-base placeholder-gray-400 focus:ring-2 focus:ring-secondary focus:border-secondary"></textarea>
                                </div>
                            </div>
                        </div>

                        <!-- Form Actions -->
                        <div class="flex justify-end space-x-4 pt-6 border-t border-slate-600">
                            <button type="button" onclick="this.closest('.fixed').remove()" 
                                    class="px-8 py-3 text-gray-400 hover:text-white hover:bg-slate-600 rounded-lg transition-colors font-semibold">
                                Cancel
                            </button>
                            <button type="button" onclick="saveDraft()" 
                                    class="px-8 py-3 bg-yellow-600 text-white hover:bg-yellow-700 rounded-lg font-semibold transition-colors">
                                <i class="fas fa-save mr-2"></i>Save as Draft
                            </button>
                            <button type="submit" 
                                    class="px-8 py-3 bg-gradient-to-r from-secondary to-sage text-white hover:from-sage hover:to-secondary rounded-lg font-semibold transition-all duration-200 shadow-lg">
                                <i class="fas fa-user-plus mr-2"></i>Add Physiotherapist
                            </button>
                        </div>
                    </form>
                </div>
            `;
            
            // Handle file uploads
            const profilePhotoInput = modal.querySelector('#physioProfilePhoto');
            const documentsInput = modal.querySelector('#physioDocuments');
            
            if (profilePhotoInput) {
                profilePhotoInput.addEventListener('change', (e) => {
                    const file = e.target.files[0];
                    if (file) {
                        showNotification('‚úÖ Profile photo selected: ' + file.name, 'success');
                    }
                });
            }
            
            if (documentsInput) {
                documentsInput.addEventListener('change', (e) => {
                    const files = Array.from(e.target.files);
                    if (files.length > 0) {
                        showNotification(`üìÑ ${files.length} document(s) selected for upload`, 'success');
                    }
                });
            }
            
            // Handle form submission
            modal.querySelector('#comprehensivePhysioForm').addEventListener('submit', (e) => {
                e.preventDefault();
                
                const firstName = modal.querySelector('#physioFirstName').value;
                const lastName = modal.querySelector('#physioLastName').value;
                const email = modal.querySelector('#physioEmail').value;
                
                if (!firstName || !lastName || !email) {
                    showNotification('‚ùå Please fill in all required fields', 'error');
                    return;
                }
                
                // Collect specializations
                const specializations = Array.from(modal.querySelectorAll('input[name="specializations"]:checked'))
                    .map(cb => cb.value);
                
                if (specializations.length === 0) {
                    showNotification('‚ùå Please select at least one specialization', 'error');
                    return;
                }
                
                // Collect permissions
                const permissions = Array.from(modal.querySelectorAll('input[name="permissions"]:checked'))
                    .map(cb => cb.value);
                
                // Collect working days
                const workingDays = Array.from(modal.querySelectorAll('input[name="workingDays"]:checked'))
                    .map(cb => cb.value);
                
                // Collect all form data
                const physioData = {
                    id: 'physio-' + Date.now(), // Unique ID
                    personal: {
                        title: modal.querySelector('#physioTitle').value,
                        firstName: firstName,
                        lastName: lastName,
                        fullName: `${firstName} ${lastName}`,
                        birthDate: modal.querySelector('#physioBirthDate').value,
                        gender: modal.querySelector('#physioGender').value,
                        nationality: modal.querySelector('#physioNationality').value,
                        cpr: modal.querySelector('#physioCpr').value
                    },
                    contact: {
                        primaryEmail: email,
                        secondaryEmail: modal.querySelector('#physioSecondaryEmail').value,
                        primaryPhone: modal.querySelector('#physioPhone').value,
                        whatsapp: modal.querySelector('#physioWhatsapp').value,
                        address: modal.querySelector('#physioAddress').value
                    },
                    professional: {
                        licenseNumber: modal.querySelector('#physioLicense').value,
                        licenseExpiry: modal.querySelector('#physioLicenseExpiry').value,
                        experience: parseInt(modal.querySelector('#physioExperience').value) || 0,
                        registrationBody: modal.querySelector('#physioRegistrationBody').value,
                        degree: modal.querySelector('#physioDegree').value,
                        university: modal.querySelector('#physioUniversity').value,
                        specializations: specializations,
                        languages: modal.querySelector('#physioLanguages').value,
                        additionalCerts: modal.querySelector('#physioAdditionalCerts').value
                    },
                    employment: {
                        type: modal.querySelector('#physioEmploymentType').value,
                        startDate: modal.querySelector('#physioStartDate').value,
                        department: modal.querySelector('#physioDepartment').value,
                        manager: modal.querySelector('#physioManager').value,
                        employeeId: modal.querySelector('#physioEmployeeId').value
                    },
                    systemAccess: {
                        username: modal.querySelector('#physioUsername').value,
                        loginEmail: modal.querySelector('#physioLoginEmail').value,
                        permissions: permissions
                    },
                    emergency: {
                        name: modal.querySelector('#physioEmergencyName').value,
                        relationship: modal.querySelector('#physioEmergencyRelation').value,
                        phone: modal.querySelector('#physioEmergencyPhone').value,
                        email: modal.querySelector('#physioEmergencyEmail').value
                    },
                    schedule: {
                        workingDays: workingDays
                    },
                    notes: {
                        clinical: modal.querySelector('#physioClinicalNotes').value,
                        administrative: modal.querySelector('#physioAdminNotes').value
                    },
                    status: 'active',
                    isActive: true,
                    createdAt: new Date().toISOString(),
                    createdBy: currentUser?.email || 'admin'
                };
                
                // SAVE THE PHYSIOTHERAPIST TO STORAGE
                const saved = savePhysiotherapistToSystem(physioData);
                
                if (saved) {
                    console.log('üíæ New physiotherapist data saved:', physioData);
                    showNotification(`üéâ Dr. ${firstName} ${lastName} added successfully to the system!`, 'success');
                    
                    // Auto-generate credentials notification
                    setTimeout(() => {
                        showNotification(`üìß Login credentials sent to ${email}`, 'success');
                    }, 1000);
                } else {
                    showNotification(`‚ö†Ô∏è Dr. ${firstName} ${lastName} saved to session storage (storage limitations)`, 'success');
                }
                
                modal.remove();
            });
            
            // Save Draft Functionality
            window.saveDraft = function() {
                showNotification('üíæ Draft saved successfully! You can continue later.', 'success');
                console.log('Draft saved for later completion');
            };
            
            document.body.appendChild(modal);
        }

        // Generate Treatment Template Function - FIXED with proper global scope
        window.generateTreatmentTemplate = function() {
            const button = event?.target;
            if (!button) {
                console.error('Button reference not found');
                return;
            }
            
            const originalContent = button.innerHTML;
            
            try {
                button.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Generating...';
                button.disabled = true;
                
                showNotification('üîÑ Generating professional treatment template...', 'success');
                
                if (typeof window !== 'undefined' && window.Poe && window.Poe.sendUserMessage) {
                    window.Poe.sendUserMessage(
                        `@Claude-Sonnet-4 Create a comprehensive physiotherapy treatment form template for Bahrain Mobility International. Include sections for patient information, assessment findings, treatment plan, exercises prescribed, progress notes, and next appointment recommendations. Format it as a professional medical document that can be printed and used during treatment sessions. Make it specific to physiotherapy practice.`,
                        {
                            handler: 'treatment-template-handler',
                            stream: false,
                            openChat: false,
                            handlerContext: { 
                                timestamp: Date.now(),
                                clinic: 'Bahrain Mobility International'
                            }
                        }
                    );
                } else {
                    createBasicTreatmentTemplate();
                }
                
            } catch (error) {
                console.error('Treatment template generation error:', error);
                showNotification('‚ùå Failed to generate treatment template', 'error');
            } finally {
                setTimeout(() => {
                    button.innerHTML = originalContent;
                    button.disabled = false;
                }, 2000);
            }
        }

        // Treatment Template Handler
        if (typeof window !== 'undefined' && window.Poe && window.Poe.registerHandler) {
            window.Poe.registerHandler('treatment-template-handler', (result, context) => {
                console.log('üìã Treatment template handler called with status:', result.status);
                
                try {
                    if (result.status === 'complete') {
                        const message = result.responses[0];
                        console.log('üìã Treatment template generated!', message);
                        
                        const templateContent = message.content;
                        const blob = new Blob([templateContent], { type: 'text/plain' });
                        const url = window.URL.createObjectURL(blob);
                        
                        const downloadLink = document.createElement('a');
                        downloadLink.href = url;
                        downloadLink.download = `Treatment_Template_${new Date().toISOString().split('T')[0]}.txt`;
                        document.body.appendChild(downloadLink);
                        downloadLink.click();
                        document.body.removeChild(downloadLink);
                        window.URL.revokeObjectURL(url);
                        
                        showNotification('üìã Treatment template generated and downloaded!', 'success');
                        
                    } else if (result.status === 'error') {
                        const message = result.responses[0];
                        const errorText = message?.statusText || 'Unknown error';
                        console.error('Treatment template generation error:', errorText);
                        showNotification(`‚ùå Template generation failed: ${errorText}`, 'error');
                    }
                    
                } catch (handlerError) {
                    console.error('Treatment template handler error:', handlerError);
                    showNotification('‚ö†Ô∏è Template processing error occurred', 'error');
                }
            });
        }

        // Basic Treatment Template Fallback
        function createBasicTreatmentTemplate() {
            const templateContent = `
BAHRAIN MOBILITY INTERNATIONAL
PHYSIOTHERAPY TREATMENT FORM

Patient Information:
- Name: _________________________
- CPR Number: ___________________
- Date: _________________________
- Physiotherapist: _______________

Assessment Findings:
- Chief Complaint: _______________
- Physical Examination: __________
- Range of Motion: _______________
- Pain Level (1-10): _____________

Treatment Plan:
- Treatment Goals: _______________
- Interventions: _________________
- Exercise Prescription: __________

Progress Notes:
- Patient Response: ______________
- Functional Improvements: _______
- Challenges: ____________________

Next Appointment:
- Date: _________________________
- Focus: ________________________
- Recommendations: _______________

Physiotherapist Signature: _______
Date: ___________________________
            `;
            
            const blob = new Blob([templateContent], { type: 'text/plain' });
            const url = window.URL.createObjectURL(blob);
            
            const downloadLink = document.createElement('a');
            downloadLink.href = url;
            downloadLink.download = `Treatment_Template_${new Date().toISOString().split('T')[0]}.txt`;
            document.body.appendChild(downloadLink);
            downloadLink.click();
            document.body.removeChild(downloadLink);
            window.URL.revokeObjectURL(url);
            
            showNotification('üìã Basic treatment template downloaded!', 'success');
        }

        // Test Supabase Connection Function 
        async function testSupabaseConnection() {
            try {
                if (!supabase) {
                    console.warn('‚ö†Ô∏è Supabase client not initialized');
                    return false;
                }
                
                console.log('üîÑ Testing Supabase connection...');
                
                // Try a simple query to test connection
                const { data, error } = await supabase
                    .from('patients')
                    .select('*')
                    .limit(1);
                
                if (error) {
                    console.error('‚ùå Supabase connection test failed:', error);
                    return false;
                }
                
                console.log('‚úÖ Supabase connection test successful');
                return true;
                
            } catch (error) {
                console.error('‚ùå Supabase connection test error:', error);
                return false;
            }
        }

        // Load Database Data Function
        async function loadDatabaseData() {
            try {
                if (!supabase) {
                    console.log('‚ÑπÔ∏è No database connection - using local storage');
                    return;
                }
                
                console.log('üîÑ Loading data from Supabase...');
                showNotification('üìä Loading data from database...', 'success');
                
                // Load patients and appointments
                await Promise.all([
                    loa// Load patients and appointments
                await Promise.all([
                    loadPatientsFromDatabase(),
                    loadAppointmentsFromDatabase()
                ]);
                
            } catch (error) {
                console.error('‚ùå Database loading error:', error);
                showNotification('‚ö†Ô∏è Database loading failed - using local storage', 'error');
            }
        }

        // Load Patients from Database
        async function loadPatientsFromDatabase() {
            try {
                if (!supabase) return;
                
                const { data: patients, error } = await supabase
                    .from('patients')
                    .select('*');
                
                if (error) {
                    console.error('Failed to load patients:', error);
                    return;
                }
                
                console.log('üìã Loaded patients from database:', patients.length);
                // Process patients data here
                
            } catch (error) {
                console.error('Patient loading error:', error);
            }
        }

        // Load Appointments from Database
        async function loadAppointmentsFromDatabase() {
            try {
                if (!supabase) return;
                
                const { data: appointments, error } = await supabase
                    .from('appointments')
                    .select('*');
                
                if (error) {
                    console.error('Failed to load appointments:', error);
                    return;
                }
                
                console.log('üìÖ Loaded appointments from database:', appointments.length);
                // Process appointments data here
                
            } catch (error) {
                console.error('Appointment loading error:', error);
            }
        }

        // Load Assigned Appointments for Physiotherapist
        function loadAssignedAppointments() {
            try {
                const allAppointments = loadAllAppointments();
                const mariamAppointments = allAppointments.filter(appt => 
                    appt.physioId === 'mariam-physio-001'
                );
                
                window.assignedAppointments = mariamAppointments;
                console.log('üë©‚Äç‚öïÔ∏è Loaded assigned appointments:', mariamAppointments.length);
                
                // Update appointment count in UI
                const countElement = document.getElementById('todayAppointmentsCount');
                if (countElement) {
                    countElement.textContent = mariamAppointments.length;
                }
                
                return mariamAppointments;
            } catch (error) {
                console.error('Failed to load assigned appointments:', error);
                return [];
            }
        }

        // Load Assigned Patients for Physiotherapist
        function loadAssignedPatients() {
            try {
                // For now, show empty state since no patients are assigned yet
                const noPatientFiles = document.getElementById('noPatientFiles');
                const patientFilesGrid = document.getElementById('patientFilesGrid');
                const patientFilesLoading = document.getElementById('patientFilesLoading');
                
                if (noPatientFiles) noPatientFiles.classList.remove('hidden');
                if (patientFilesGrid) patientFilesGrid.classList.add('hidden');
                if (patientFilesLoading) patientFilesLoading.classList.add('hidden');
                
                console.log('üë• No patients assigned yet - showing empty state');
            } catch (error) {
                console.error('Failed to load assigned patients:', error);
            }
        }

        // Show Users View Function
        function showUsersView() {
            const usersContainer = document.getElementById('users');
            if (!usersContainer) {
                console.error('Users container not found');
                return;
            }
            
            usersContainer.innerHTML = `
                <h1 class="text-3xl font-bold mb-6">Users & Admins Management</h1>
                
                <!-- Stats Cards -->
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                    <div class="bg-gradient-to-r from-blue-500 to-blue-600 text-white p-6 rounded-lg shadow-lg">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-blue-100">Total Users</p>
                                <p class="text-3xl font-bold">2</p>
                            </div>
                            <i class="fas fa-users text-4xl text-blue-200"></i>
                        </div>
                    </div>
                    <div class="bg-gradient-to-r from-purple-500 to-purple-600 text-white p-6 rounded-lg shadow-lg">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-purple-100">Administrators</p>
                                <p class="text-3xl font-bold">1</p>
                            </div>
                            <i class="fas fa-user-shield text-4xl text-purple-200"></i>
                        </div>
                    </div>
                    <div class="bg-gradient-to-r from-green-500 to-green-600 text-white p-6 rounded-lg shadow-lg">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-green-100">Physiotherapists</p>
                                <p class="text-3xl font-bold">1</p>
                            </div>
                            <i class="fas fa-user-md text-4xl text-green-200"></i>
                        </div>
                    </div>
                </div>
                
                <!-- Action Bar -->
                <div class="bg-white dark:bg-gray-800 rounded-lg shadow-lg p-6 mb-6">
                    <div class="flex justify-between items-center">
                        <h3 class="text-xl font-semibold">System Users</h3>
                        <button onclick="showAddUserModal()" class="bg-primary text-white px-4 py-3 rounded-lg hover:bg-secondary transition-colors">
                            <i class="fas fa-user-plus mr-2"></i>Add New User
                        </button>
                    </div>
                </div>
                
                <!-- Users List -->
                <div class="bg-white dark:bg-gray-800 rounded-lg shadow-lg p-6">
                    <div class="space-y-4">
                        <!-- Admin User -->
                        <div class="flex items-center justify-between p-4 border border-gray-200 dark:border-gray-700 rounded-lg">
                            <div class="flex items-center space-x-4">
                                <div class="w-12 h-12 bg-blue-500 rounded-full flex items-center justify-center text-white font-bold">
                                    AD
                                </div>
                                <div>
                                    <h4 class="font-semibold text-lg">Admin User</h4>
                                    <p class="text-gray-600 dark:text-gray-400">DhariBmi@gmail.com</p>
                                    <p class="text-sm text-blue-600">Administrator</p>
                                </div>
                            </div>
                            <div class="flex items-center space-x-3">
                                <span class="px-3 py-1 bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-200 rounded-full text-sm">Active</span>
                                <button class="p-2 text-blue-600 hover:text-blue-800 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700">
                                    <i class="fas fa-edit"></i>
                                </button>
                            </div>
                        </div>
                        
                        <!-- Physiotherapist User -->
                        <div class="flex items-center justify-between p-4 border border-gray-200 dark:border-gray-700 rounded-lg">
                            <div class="flex items-center space-x-4">
                                <div class="w-12 h-12 bg-secondary rounded-full flex items-center justify-center text-white font-bold">
                                    MA
                                </div>
                                <div>
                                    <h4 class="font-semibold text-lg">Dr. Mariam Abdulatheem Ali</h4>
                                    <p class="text-gray-600 dark:text-gray-400">Mariambmi@gmail.com</p>
                                    <p class="text-sm text-green-600">Physiotherapist</p>
                                </div>
                            </div>
                            <div class="flex items-center space-x-3">
                                <span class="px-3 py-1 bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-200 rounded-full text-sm">Active</span>
                                <button class="p-2 text-blue-600 hover:text-blue-800 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700">
                                    <i class="fas fa-edit"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            console.log('‚úÖ Users view populated successfully');
        }

        // Appointment Management Functions
        function editAppointment(appointmentId) {
            console.log('Editing appointment:', appointmentId);
            showNotification('üìù Edit appointment functionality - Coming soon!', 'success');
        }

        function completeAppointment(appointmentId) {
            console.log('Completing appointment:', appointmentId);
            showNotification('‚úÖ Appointment marked as completed!', 'success');
        }

        function cancelAppointment(appointmentId) {
            console.log('Cancelling appointment:', appointmentId);
            showNotification('‚ùå Appointment cancelled successfully!', 'success');
        }

        function deleteAppointment(appointmentId) {
            console.log('Deleting appointment:', appointmentId);
            showNotification('üóëÔ∏è Appointment deleted successfully!', 'success');
        }

        function viewAppointmentDetails(appointmentId) {
            console.log('Viewing appointment details:', appointmentId);
            showNotification('üëÅÔ∏è Loading appointment details...', 'success');
        }

        function duplicateAppointment(appointmentId) {
            console.log('Duplicating appointment:', appointmentId);
            showNotification('üìã Appointment duplicated successfully!', 'success');
        }

        // Physiotherapist Assignment Functions
        function sendAppointmentToPhysiotherapist(appointmentId, physioId, patientName) {
            console.log('Sending appointment to physiotherapist:', { appointmentId, physioId, patientName });
            showNotification(`üìß Appointment for ${patientName} sent to physiotherapist!`, 'success');
        }

        function sendTodaysAppointmentsToPhysiotherapist(physioId, physioName) {
            console.log('Sending today\'s appointments to:', physioName);
            showNotification(`üìÖ Today's appointments sent to ${physioName}!`, 'success');
        }

        function createBulkAppointments() {
            console.log('Creating bulk appointments');
            showNotification('üìÖ Bulk appointment creation - Feature coming soon!', 'success');
        }

        // Exercise Management Functions
        function viewExercise(exerciseId) {
            console.log('Viewing exercise:', exerciseId);
            showNotification('üîç Loading exercise details...', 'success');
        }

        // Physiotherapist Management Functions
        function editPhysiotherapist(physioId) {
            console.log('Editing physiotherapist:', physioId);
            showNotification('üìù Edit physiotherapist functionality - Coming soon!', 'success');
        }

        function viewPhysiotherapistDetails(physioId) {
            console.log('Viewing physiotherapist details:', physioId);
            showNotification('üëÅÔ∏è Loading physiotherapist details...', 'success');
        }

        // Physiotherapist Dashboard Functions
        function startTreatmentSession(appointmentId) {
            console.log('Starting treatment session:', appointmentId);
            showNotification('üè• Treatment session started!', 'success');
        }

        function viewPatientHistory(patientId) {
            console.log('Viewing patient history:', patientId);
            showNotification('üìã Loading patient history...', 'success');
        }

        function addTreatmentNotes(appointmentId) {
            console.log('Adding treatment notes:', appointmentId);
            showNotification('üìù Treatment notes editor opened!', 'success');
        }

        function prepareInitialAssessment(appointmentId) {
            console.log('Preparing initial assessment:', appointmentId);
            showNotification('üìä Initial assessment form opened!', 'success');
        }

        function createTreatmentPlan(patientId) {
            console.log('Creating treatment plan:', patientId);
            showNotification('üìã Treatment plan creator opened!', 'success');
        }

        function prescribeExercises(patientId) {
            console.log('Prescribing exercises:', patientId);
            showNotification('üí™ Exercise prescription tool opened!', 'success');
        }

        function viewTreatmentSummary(appointmentId) {
            console.log('Viewing treatment summary:', appointmentId);
            showNotification('üìä Loading treatment summary...', 'success');
        }

        function scheduleFollowUp(patientId) {
            console.log('Scheduling follow-up:', patientId);
            showNotification('üìÖ Follow-up scheduling opened!', 'success');
        }

        function openExerciseLibrary() {
            console.log('Opening exercise library');
            showNotification('üí™ Exercise library opened!', 'success');
        }

        function createProgressReport() {
            console.log('Creating progress report');
            showNotification('üìä Progress report generator opened!', 'success');
        }

        function openTreatmentProtocols() {
            console.log('Opening treatment protocols');
            showNotification('üìã Treatment protocols opened!', 'success');
        }

        // Reports Functions
        function generateProgressReport() {
            console.log('Generating progress report');
            showNotification('üìä Generating patient progress report...', 'success');
        }

        function generateFinancialReport() {
            console.log('Generating financial report');
            showNotification('üí∞ Generating financial summary report...', 'success');
        }

        function generateStaffReport() {
            console.log('Generating staff report');
            showNotification('üë• Generating staff performance report...', 'success');
        }

        // Settings Functions
        function saveGeneralSettings() {
            console.log('Saving general settings');
            showNotification('‚öôÔ∏è General settings saved successfully', 'success');
        }

        function saveDatabaseSettings() {
            console.log('Saving database settings');
            showNotification('üíæ Database settings saved successfully', 'success');
        }

        function exportAllData() {
            console.log('Exporting all data');
            showNotification('üì§ Data export initiated...', 'success');
        }

        function importData() {
            console.log('Importing data');
            showNotification('üì• Data import functionality - Coming soon!', 'success');
        }

        function systemBackup() {
            console.log('Creating system backup');
            showNotification('üõ°Ô∏è System backup initiated...', 'success');
        }

        // Add User Modal Function
        function showAddUserModal() {
            console.log('Showing add user modal');
            showNotification('üë§ Add user functionality - Coming soon!', 'success');
        }

        console.log('üöÄ PhysioTech System loaded successfully with ALL functionalities!');
    </script>
</body>
</html>
