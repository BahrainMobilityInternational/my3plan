<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PhysioTech - Comprehensive Physiotherapy Management System</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://unpkg.com/docx@7.8.2/build/index.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        primary: '#0F766E',
                        secondary: '#0D9488',
                        medical: '#2C7A7B',
                        sage: '#10B981',
                    }
                }
            }
        }
    </script>
    <style>
        .fade-in {
            animation: fadeIn 0.3s ease-in;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .loading {
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-white dark:bg-gray-900 text-gray-900 dark:text-white min-h-screen">
    <!-- User Type Selection -->
    <div id="userTypeSelection" class="min-h-screen flex items-center justify-center relative overflow-hidden bg-gradient-to-br from-slate-50 to-cyan-50">
        <!-- Background Pattern -->
        <div class="absolute inset-0 opacity-8">
            <div class="absolute top-20 left-20 w-96 h-96 bg-primary rounded-full blur-3xl"></div>
            <div class="absolute bottom-20 right-20 w-96 h-96 bg-sage rounded-full blur-3xl"></div>
            <div class="absolute top-1/2 left-1/2 w-64 h-64 bg-medical rounded-full blur-2xl transform -translate-x-1/2 -translate-y-1/2"></div>
        </div>

        <div class="max-w-4xl mx-4 bg-white rounded-3xl shadow-2xl overflow-hidden relative z-10">
            <div class="p-8 lg:p-12 text-center">
                <!-- Logo and Title -->
                <div class="mb-8">
                    <div class="inline-flex items-center justify-center w-24 h-24 bg-white rounded-2xl mb-6 shadow-lg border-2 border-gray-100">
                        <img src="https://pfst.cf2.poecdn.net/base/image/8b6401e48101612f660ccec8b51614f103f2770892e0de9e4ad8f101949526a1?w=225&h=225" 
                             alt="Bahrain Mobility International" 
                             class="w-20 h-20 object-contain rounded-xl">
                    </div>
                    <h1 class="text-4xl font-bold text-gray-900 mb-2">Welcome to PhysioTech</h1>
                    <p class="text-gray-600">Choose your login type</p>
                </div>

                <!-- Login Type Cards -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 max-w-2xl mx-auto">
                    <!-- Admin Login -->
                    <button id="adminLoginBtn" class="group p-8 border-2 border-gray-200 rounded-2xl hover:border-primary hover:shadow-lg transition-all duration-200">
                        <div class="w-16 h-16 bg-primary bg-opacity-10 rounded-xl flex items-center justify-center mx-auto mb-4 group-hover:bg-opacity-20 transition-colors">
                            <i class="fas fa-user-shield text-3xl text-primary"></i>
                        </div>
                        <h3 class="text-xl font-semibold text-gray-900 mb-2">Administrator</h3>
                        <p class="text-gray-600">Access admin dashboard and manage the system</p>
                    </button>

                    <!-- Physiotherapist Login -->
                    <button id="physioLoginBtn" class="group p-8 border-2 border-gray-200 rounded-2xl hover:border-secondary hover:shadow-lg transition-all duration-200">
                        <div class="w-16 h-16 bg-secondary bg-opacity-10 rounded-xl flex items-center justify-center mx-auto mb-4 group-hover:bg-opacity-20 transition-colors">
                            <i class="fas fa-user-md text-3xl text-secondary"></i>
                        </div>
                        <h3 class="text-xl font-semibold text-gray-900 mb-2">Physiotherapist</h3>
                        <p class="text-gray-600">Access your schedule and patient information</p>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Admin Login Page -->
    <div id="adminLoginPage" class="hidden min-h-screen flex items-center justify-center relative overflow-hidden bg-gradient-to-br from-slate-50 to-cyan-50">
        <div class="flex w-full max-w-6xl mx-4 bg-white rounded-3xl shadow-2xl overflow-hidden relative z-10">
            <!-- Left Side - Login Form -->
            <div class="w-full lg:w-1/2 p-8 lg:p-12">
                <div class="max-w-md mx-auto">
                    <!-- Logo and Title -->
                    <div class="text-center mb-8">
                        <div class="inline-flex items-center justify-center w-24 h-24 bg-white rounded-2xl mb-6 shadow-lg border-2 border-gray-100">
                            <img src="https://pfst.cf2.poecdn.net/base/image/8b6401e48101612f660ccec8b51614f103f2770892e0de9e4ad8f101949526a1?w=225&h=225" 
                                 alt="Bahrain Mobility International" 
                                 class="w-20 h-20 object-contain rounded-xl">
                        </div>
                        <h1 class="text-4xl font-bold text-gray-900 mb-2">Admin Login</h1>
                        <p class="text-gray-600">Welcome back to Bahrain Mobility International</p>
                    </div>

                    <form id="loginForm" class="space-y-6">
                        <div>
                            <label for="loginEmail" class="block text-sm font-semibold text-gray-700 mb-3">Email</label>
                            <div class="relative">
                                <input type="email" 
                                       id="loginEmail" 
                                       name="email"
                                       required 
                                       autocomplete="email"
                                       placeholder="Enter your email address"
                                       class="w-full px-4 py-4 pl-12 border-2 border-gray-200 rounded-xl bg-white text-gray-900 text-base focus:ring-2 focus:ring-primary focus:border-primary focus:outline-none transition-colors z-10 relative">
                                <i class="fas fa-envelope absolute left-4 top-5 text-gray-400 pointer-events-none z-0"></i>
                            </div>
                        </div>

                        <div>
                            <label for="loginPassword" class="block text-sm font-semibold text-gray-700 mb-3">Password</label>
                            <div class="relative">
                                <input type="password" 
                                       id="loginPassword" 
                                       name="password"
                                       required 
                                       autocomplete="current-password"
                                       placeholder="Enter your password"
                                       class="w-full px-4 py-4 pl-12 pr-12 border-2 border-gray-200 rounded-xl bg-white text-gray-900 text-base focus:ring-2 focus:ring-primary focus:border-primary focus:outline-none transition-colors z-10 relative">
                                <i class="fas fa-lock absolute left-4 top-5 text-gray-400 pointer-events-none z-0"></i>
                                <button type="button" id="togglePassword" class="absolute right-4 top-5 text-gray-400 hover:text-gray-600 focus:outline-none z-20">
                                    <i class="fas fa-eye"></i>
                                </button>
                            </div>
                        </div>

                        <button type="submit" class="w-full bg-gradient-to-r from-primary to-secondary text-white py-4 px-4 rounded-xl hover:from-secondary hover:to-medical transition-all duration-200 font-semibold text-lg shadow-lg">
                            Log In
                        </button>

                        <div id="loginError" class="hidden bg-red-50 border border-red-200 text-red-700 px-4 py-3 rounded-xl text-sm">
                        </div>
                    </form>

                    <div class="mt-8 text-center">
                        <button id="backToSelectionFromAdmin" class="text-primary hover:text-secondary font-medium">‚Üê Back to login selection</button>
                    </div>
                </div>
            </div>

            <!-- Right Side - Visual -->
            <div class="hidden lg:flex lg:w-1/2 bg-gradient-to-br from-primary via-secondary to-sage items-center justify-center p-12 relative">
                <div class="text-center text-white z-10">
                    <h2 class="text-4xl font-bold mb-6">Welcome to PhysioTech</h2>
                    <p class="text-xl text-white text-opacity-90 mb-8 leading-relaxed">
                        Professional physiotherapy management system for modern healthcare providers
                    </p>
                </div>
            </div>
        </div>
    </div>

    <!-- Physiotherapist Login Page -->
    <div id="physioLoginPage" class="hidden min-h-screen flex items-center justify-center relative overflow-hidden bg-gradient-to-br from-teal-50 to-emerald-50">
        <div class="flex w-full max-w-5xl mx-4 bg-white rounded-3xl shadow-2xl overflow-hidden relative z-10">
            <!-- Left Side - Visual -->
            <div class="hidden lg:flex lg:w-1/2 bg-gradient-to-br from-secondary via-sage to-primary items-center justify-center p-12 relative">
                <div class="text-center text-white z-10">
                    <div class="w-24 h-24 bg-white bg-opacity-20 rounded-2xl flex items-center justify-center mx-auto mb-6">
                        <i class="fas fa-user-md text-4xl"></i>
                    </div>
                    <h2 class="text-4xl font-bold mb-6">Physiotherapist Portal</h2>
                    <p class="text-xl text-white text-opacity-90 mb-8 leading-relaxed">
                        Access your schedule, patient information, and treatment tools
                    </p>
                </div>
            </div>

            <!-- Right Side - Login Form -->
            <div class="w-full lg:w-1/2 p-8 lg:p-12">
                <div class="max-w-md mx-auto">
                    <!-- Back Button -->
                    <button id="backToSelection" class="mb-6 text-gray-600 hover:text-gray-800 flex items-center">
                        <i class="fas fa-arrow-left mr-2"></i>
                        <span>Back to login selection</span>
                    </button>

                    <!-- Logo and Title -->
                    <div class="text-center mb-8">
                        <div class="inline-flex items-center justify-center w-20 h-20 bg-secondary bg-opacity-10 rounded-2xl mb-6">
                            <i class="fas fa-user-md text-3xl text-secondary"></i>
                        </div>
                        <h1 class="text-4xl font-bold text-gray-900 mb-2">Physiotherapist Login</h1>
                        <p class="text-gray-600">Enter your credentials to access your dashboard</p>
                    </div>

                    <form id="physioLoginForm" class="space-y-6">
                        <div>
                            <label for="physioLoginEmail" class="block text-sm font-semibold text-gray-700 mb-3">Email</label>
                            <div class="relative">
                                <input type="email" 
                                       id="physioLoginEmail" 
                                       name="email"
                                       required 
                                       autocomplete="email"
                                       placeholder="Enter your email address"
                                       class="w-full px-4 py-4 pl-12 border-2 border-gray-200 rounded-xl bg-white text-gray-900 text-base focus:ring-2 focus:ring-secondary focus:border-secondary focus:outline-none transition-colors z-10 relative">
                                <i class="fas fa-envelope absolute left-4 top-5 text-gray-400 pointer-events-none z-0"></i>
                            </div>
                        </div>

                        <div>
                            <label for="physioLoginPassword" class="block text-sm font-semibold text-gray-700 mb-3">Password</label>
                            <div class="relative">
                                <input type="password" 
                                       id="physioLoginPassword" 
                                       name="password"
                                       required 
                                       autocomplete="current-password"
                                       placeholder="Enter your password"
                                       class="w-full px-4 py-4 pl-12 pr-12 border-2 border-gray-200 rounded-xl bg-white text-gray-900 text-base focus:ring-2 focus:ring-secondary focus:border-secondary focus:outline-none transition-colors z-10 relative">
                                <i class="fas fa-lock absolute left-4 top-5 text-gray-400 pointer-events-none z-0"></i>
                                <button type="button" id="togglePhysioPassword" class="absolute right-4 top-5 text-gray-400 hover:text-gray-600 focus:outline-none z-20">
                                    <i class="fas fa-eye"></i>
                                </button>
                            </div>
                        </div>

                        <button type="submit" class="w-full bg-gradient-to-r from-secondary to-sage text-white py-4 px-4 rounded-xl hover:from-sage hover:to-primary transition-all duration-200 font-semibold text-lg shadow-lg">
                            <i class="fas fa-sign-in-alt mr-2"></i>Log In
                        </button>

                        <div id="physioLoginError" class="hidden bg-red-50 border border-red-200 text-red-700 px-4 py-3 rounded-xl text-sm">
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Admin Dashboard -->
    <div id="mainApp" class="hidden">
        <!-- Navigation -->
        <nav class="bg-primary shadow-lg fixed top-0 left-0 right-0 z-50">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                <div class="flex justify-between h-16">
                    <div class="flex items-center">
                        <i class="fas fa-heartbeat text-white text-2xl mr-3"></i>
                        <span class="text-white text-xl font-bold">PhysioTech - Admin</span>
                    </div>
                    <div class="flex items-center space-x-4">
                        <div class="flex items-center space-x-3 text-white">
                            <div class="w-8 h-8 bg-white bg-opacity-20 rounded-full flex items-center justify-center">
                                <i class="fas fa-user text-sm"></i>
                            </div>
                            <div class="hidden md:block">
                                <p class="text-sm font-medium" id="userEmail">Admin User</p>
                                <p class="text-xs text-gray-200">Administrator</p>
                            </div>
                        </div>
                        
                        <button id="connectSupabase" class="bg-white text-primary px-4 py-2 rounded-lg hover:bg-gray-100 transition-colors">
                            <i class="fas fa-database mr-2"></i>Connect Supabase
                        </button>
                        <div id="connectionStatus" class="text-white">
                            <i class="fas fa-circle text-red-400 mr-1"></i>Disconnected
                        </div>
                        
                        <button id="logoutBtn" class="bg-red-500 text-white px-4 py-2 rounded-lg hover:bg-red-600 transition-colors">
                            <i class="fas fa-sign-out-alt mr-2"></i>Logout
                        </button>
                    </div>
                </div>
            </div>
        </nav>

        <div class="flex pt-16">
            <!-- Sidebar -->
            <div class="w-64 bg-gray-50 dark:bg-gray-800 min-h-screen p-4 fixed left-0 top-16 bottom-0 overflow-y-auto">
                <nav class="space-y-2">
                    <button class="nav-btn w-full text-left p-3 rounded-lg hover:bg-gray-200 dark:hover:bg-gray-700 transition-colors bg-primary text-white" data-view="dashboard">
                        <i class="fas fa-tachometer-alt mr-3"></i>Dashboard
                    </button>
                    <button class="nav-btn w-full text-left p-3 rounded-lg hover:bg-gray-200 dark:hover:bg-gray-700 transition-colors" data-view="patients">
                        <i class="fas fa-users mr-3"></i>Patients
                    </button>
                    <button class="nav-btn w-full text-left p-3 rounded-lg hover:bg-gray-200 dark:hover:bg-gray-700 transition-colors" data-view="appointments">
                        <i class="fas fa-calendar mr-3"></i>Appointments
                    </button>
                    <button class="nav-btn w-full text-left p-3 rounded-lg hover:bg-gray-200 dark:hover:bg-gray-700 transition-colors" data-view="physiotherapists">
                        <i class="fas fa-user-md mr-3"></i>Physiotherapists
                    </button>
                    <button class="nav-btn w-full text-left p-3 rounded-lg hover:bg-gray-200 dark:hover:bg-gray-700 transition-colors" data-view="reports">
                        <i class="fas fa-chart-bar mr-3"></i>Reports
                    </button>
                </nav>
            </div>

            <!-- Main Content -->
            <div class="flex-1 ml-64 p-6">
                <!-- Dashboard View -->
                <div id="dashboard" class="view">
                    <h1 class="text-3xl font-bold mb-6">Admin Dashboard</h1>
                    
                    <!-- Stats Cards -->
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                        <div class="bg-gradient-to-r from-blue-500 to-blue-600 text-white p-6 rounded-lg shadow-lg">
                            <div class="flex items-center justify-between">
                                <div>
                                    <p class="text-blue-100">Total Patients</p>
                                    <p class="text-3xl font-bold" id="totalPatients">15</p>
                                </div>
                                <i class="fas fa-users text-4xl text-blue-200"></i>
                            </div>
                        </div>
                        <div class="bg-gradient-to-r from-green-500 to-green-600 text-white p-6 rounded-lg shadow-lg">
                            <div class="flex items-center justify-between">
                                <div>
                                    <p class="text-green-100">Appointments Today</p>
                                    <p class="text-3xl font-bold" id="appointmentsToday">8</p>
                                </div>
                                <i class="fas fa-calendar-day text-4xl text-green-200"></i>
                            </div>
                        </div>
                        <div class="bg-gradient-to-r from-purple-500 to-purple-600 text-white p-6 rounded-lg shadow-lg">
                            <div class="flex items-center justify-between">
                                <div>
                                    <p class="text-purple-100">Active Treatments</p>
                                    <p class="text-3xl font-bold" id="activeTreatments">25</p>
                                </div>
                                <i class="fas fa-stethoscope text-4xl text-purple-200"></i>
                            </div>
                        </div>
                        <div class="bg-gradient-to-r from-orange-500 to-orange-600 text-white p-6 rounded-lg shadow-lg">
                            <div class="flex items-center justify-between">
                                <div>
                                    <p class="text-orange-100">Revenue (Month)</p>
                                    <p class="text-3xl font-bold" id="monthlyRevenue">$12,450</p>
                                </div>
                                <i class="fas fa-dollar-sign text-4xl text-orange-200"></i>
                            </div>
                        </div>
                    </div>

                    <!-- Quick Actions -->
                    <div class="bg-white dark:bg-gray-800 rounded-lg shadow-lg p-6">
                        <h3 class="text-xl font-semibold mb-4">Quick Actions</h3>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                            <button id="quickAddPatient" class="flex items-center p-4 bg-blue-50 dark:bg-blue-900/20 rounded-lg hover:bg-blue-100 dark:hover:bg-blue-900/30 transition-colors">
                                <i class="fas fa-user-plus text-blue-600 text-2xl mr-4"></i>
                                <div class="text-left">
                                    <p class="font-semibold text-blue-900 dark:text-blue-100">Add Patient</p>
                                    <p class="text-sm text-blue-600 dark:text-blue-300">Register new patient</p>
                                </div>
                            </button>
                            <button id="quickScheduleAppointment" class="flex items-center p-4 bg-green-50 dark:bg-green-900/20 rounded-lg hover:bg-green-100 dark:hover:bg-green-900/30 transition-colors">
                                <i class="fas fa-calendar-plus text-green-600 text-2xl mr-4"></i>
                                <div class="text-left">
                                    <p class="font-semibold text-green-900 dark:text-green-100">Schedule Appointment</p>
                                    <p class="text-sm text-green-600 dark:text-green-300">Book new appointment</p>
                                </div>
                            </button>
                            <button id="quickAddPhysiotherapist" class="flex items-center p-4 bg-purple-50 dark:bg-purple-900/20 rounded-lg hover:bg-purple-100 dark:hover:bg-purple-900/30 transition-colors">
                                <i class="fas fa-user-md text-purple-600 text-2xl mr-4"></i>
                                <div class="text-left">
                                    <p class="font-semibold text-purple-900 dark:text-purple-100">Add Physiotherapist</p>
                                    <p class="text-sm text-purple-600 dark:text-purple-300">Add new staff member</p>
                                </div>
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Patients View -->
                <div id="patients" class="view hidden">
                    <div class="flex justify-between items-center mb-6">
                        <h1 class="text-3xl font-bold">Patients</h1>
                        <button id="addPatientBtn" class="bg-primary text-white px-4 py-2 rounded-lg hover:bg-secondary transition-colors">
                            <i class="fas fa-plus mr-2"></i>Add Patient
                        </button>
                    </div>

                    <!-- Patients Grid -->
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6" id="patientsGrid">
                        <!-- Sample Patient Card -->
                        <div class="bg-white dark:bg-gray-800 rounded-lg shadow-lg p-6 hover:shadow-xl transition-shadow">
                            <div class="flex items-center mb-4">
                                <div class="w-16 h-16 bg-primary rounded-full flex items-center justify-center text-white font-bold text-xl mr-4">
                                    DF
                                </div>
                                <div>
                                    <h3 class="text-lg font-semibold">Dharui Fakhroo</h3>
                                    <p class="text-gray-600 dark:text-gray-400 text-sm">Dharui123@gmail.com</p>
                                    <p class="text-gray-500 dark:text-gray-500 text-sm">37352222</p>
                                </div>
                            </div>
                            
                            <div class="space-y-2 mb-4">
                                <div class="flex items-center text-sm">
                                    <i class="fas fa-birthday-cake w-4 mr-2 text-gray-400"></i>
                                    <span>25 years old</span>
                                </div>
                                <div class="flex items-center text-sm">
                                    <i class="fas fa-calendar w-4 mr-2 text-gray-400"></i>
                                    <span>Last visit: Dec 18, 2024</span>
                                </div>
                                <div class="flex items-center text-sm">
                                    <i class="fas fa-notes-medical w-4 mr-2 text-gray-400"></i>
                                    <span>3 treatments completed</span>
                                </div>
                            </div>

                            <div class="flex items-center justify-between pt-4 border-t border-gray-200 dark:border-gray-700">
                                <span class="px-2 py-1 bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-200 rounded text-sm">Active</span>
                                <div class="flex space-x-2">
                                    <button onclick="viewPatientDetails('sample-id')" class="p-2 text-primary hover:text-secondary rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors" title="View Details">
                                        <i class="fas fa-eye"></i>
                                    </button>
                                    <button onclick="assignPatientToPhysiotherapist('sample-id', 'Dharui Fakhroo')" class="p-2 text-green-600 hover:text-green-800 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors" title="Assign to Physiotherapist">
                                        <i class="fas fa-user-md"></i>
                                    </button>
                                    <button onclick="editPatient('sample-id')" class="p-2 text-blue-600 hover:text-blue-800 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors" title="Edit Patient">
                                        <i class="fas fa-edit"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Appointments View -->
                <div id="appointments" class="view hidden">
                    <div class="flex justify-between items-center mb-6">
                        <h1 class="text-3xl font-bold">Appointments</h1>
                        <button id="addAppointmentBtn" class="bg-primary text-white px-4 py-2 rounded-lg hover:bg-secondary transition-colors">
                            <i class="fas fa-plus mr-2"></i>Add Appointment
                        </button>
                    </div>

                    <!-- Sample Appointment -->
                    <div class="bg-white dark:bg-gray-800 rounded-lg shadow-lg p-6">
                        <div class="flex items-center justify-between mb-4">
                            <div class="flex items-center space-x-4">
                                <div class="w-12 h-12 bg-primary rounded-full flex items-center justify-center text-white font-bold">
                                    DF
                                </div>
                                <div>
                                    <h4 class="font-semibold">Dharui Fakhroo</h4>
                                    <p class="text-gray-600 dark:text-gray-400 text-sm">Dr. Mariam Abdulatheem Ali</p>
                                    <p class="text-gray-500 text-sm">Today, 2:00 PM - 3:00 PM</p>
                                </div>
                            </div>
                            <span class="px-3 py-1 bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-200 rounded-full text-sm">Scheduled</span>
                        </div>
                        <p class="text-gray-600 dark:text-gray-400 text-sm">Follow-up session for back pain treatment</p>
                    </div>
                </div>

                <!-- Physiotherapists View -->
                <div id="physiotherapists" class="view hidden">
                    <div class="flex justify-between items-center mb-6">
                        <h1 class="text-3xl font-bold">Physiotherapists</h1>
                        <button id="addPhysiotherapistBtn" class="bg-primary text-white px-4 py-2 rounded-lg hover:bg-secondary transition-colors">
                            <i class="fas fa-plus mr-2"></i>Add Physiotherapist
                        </button>
                    </div>

                    <!-- Physiotherapists Grid -->
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6" id="physiotherapistsGrid">
                        <!-- Sample Physiotherapist Card -->
                        <div class="bg-white dark:bg-gray-800 rounded-lg shadow-lg p-6 hover:shadow-xl transition-shadow">
                            <div class="flex items-center mb-4">
                                <div class="w-16 h-16 bg-secondary rounded-full flex items-center justify-center text-white font-bold text-xl mr-4">
                                    MA
                                </div>
                                <div>
                                    <h3 class="text-lg font-semibold">Dr. Mariam Abdulatheem Ali</h3>
                                    <p class="text-gray-600 dark:text-gray-400 text-sm">Orthopedic, Sports Medicine</p>
                                    <p class="text-gray-500 text-sm">7 years experience</p>
                                </div>
                            </div>
                            
                            <div class="space-y-2 mb-4">
                                <div class="flex items-center text-sm">
                                    <i class="fas fa-envelope w-4 mr-2 text-gray-400"></i>
                                    <span>Mariambmi@gmail.com</span>
                                </div>
                                <div class="flex items-center text-sm">
                                    <i class="fas fa-phone w-4 mr-2 text-gray-400"></i>
                                    <span>97362123</span>
                                </div>
                                <div class="flex items-center text-sm">
                                    <i class="fas fa-id-card w-4 mr-2 text-gray-400"></i>
                                    <span>License: PT-2024-MA</span>
                                </div>
                            </div>

                            <div class="flex items-center justify-between pt-4 border-t border-gray-200 dark:border-gray-700">
                                <span class="px-2 py-1 bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-200 rounded text-sm">Active</span>
                                <div class="flex space-x-2">
                                    <button onclick="editPhysiotherapist('mariam-physio-001')" class="p-2 text-blue-600 hover:text-blue-800 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors">
                                        <i class="fas fa-edit"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Reports View -->
                <div id="reports" class="view hidden">
                    <h1 class="text-3xl font-bold mb-6">Reports & Analytics</h1>
                    <div class="bg-white dark:bg-gray-800 rounded-lg shadow-lg p-6">
                        <p class="text-gray-600 dark:text-gray-400">Reports and analytics coming soon...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Physiotherapist Dashboard -->
    <div id="physioDashboard" class="hidden">
        <!-- Navigation -->
        <nav class="bg-secondary shadow-lg fixed top-0 left-0 right-0 z-50">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                <div class="flex justify-between h-16">
                    <div class="flex items-center">
                        <i class="fas fa-user-md text-white text-2xl mr-3"></i>
                        <span class="text-white text-xl font-bold">PhysioTech - Physiotherapist</span>
                    </div>
                    <div class="flex items-center space-x-4">
                        <div class="flex items-center space-x-3 text-white">
                            <div class="w-8 h-8 bg-white bg-opacity-20 rounded-full flex items-center justify-center">
                                <i class="fas fa-user-md text-sm"></i>
                            </div>
                            <div class="hidden md:block">
                                <p class="text-sm font-medium" id="physioUserName">Physiotherapist</p>
                                <p class="text-xs text-gray-200" id="physioUserEmail">physio@example.com</p>
                            </div>
                        </div>
                        
                        <button id="physioLogoutBtn" class="bg-red-500 text-white px-4 py-2 rounded-lg hover:bg-red-600 transition-colors">
                            <i class="fas fa-sign-out-alt mr-2"></i>Logout
                        </button>
                    </div>
                </div>
            </div>
        </nav>

        <div class="flex pt-16">
            <!-- Sidebar -->
            <div class="w-64 bg-gray-50 dark:bg-gray-800 min-h-screen p-4 fixed left-0 top-16 bottom-0 overflow-y-auto">
                <nav class="space-y-2">
                    <button class="physio-nav-btn w-full text-left p-3 rounded-lg hover:bg-gray-200 dark:hover:bg-gray-700 transition-colors bg-secondary text-white" data-view="physio-dashboard">
                        <i class="fas fa-tachometer-alt mr-3"></i>Dashboard
                    </button>
                    <button class="physio-nav-btn w-full text-left p-3 rounded-lg hover:bg-gray-200 dark:hover:bg-gray-700 transition-colors" data-view="physio-appointments">
                        <i class="fas fa-calendar mr-3"></i>My Appointments
                    </button>
                    <button class="physio-nav-btn w-full text-left p-3 rounded-lg hover:bg-gray-200 dark:hover:bg-gray-700 transition-colors" data-view="physio-patients">
                        <i class="fas fa-folder-open mr-3"></i>Patient Files
                    </button>
                </nav>
            </div>

            <!-- Main Content -->
            <div class="flex-1 ml-64 p-6">
                <!-- Physiotherapist Dashboard View -->
                <div id="physio-dashboard" class="physio-view">
                    <h1 class="text-3xl font-bold mb-6">Dashboard</h1>
                    
                    <!-- Welcome Card -->
                    <div class="bg-gradient-to-r from-secondary to-sage text-white p-6 rounded-lg shadow-lg mb-8">
                        <div class="flex items-center justify-between">
                            <div class="flex items-center">
                                <div class="w-16 h-16 bg-white bg-opacity-20 rounded-full flex items-center justify-center mr-4">
                                    <i class="fas fa-user-md text-2xl"></i>
                                </div>
                                <div>
                                    <h2 class="text-2xl font-bold">Welcome back!</h2>
                                    <p class="text-white text-opacity-90">You have <span id="todayAppointmentsCount">2</span> appointments today</p>
                                </div>
                            </div>
                            
                            <!-- Voice Announcement Button -->
                            <div class="bg-white bg-opacity-10 rounded-lg p-4 border border-white border-opacity-30">
                                <div class="flex items-center justify-between">
                                    <div>
                                        <h3 class="text-white font-semibold text-lg">üéµ Voice Assistant</h3>
                                        <p class="text-white text-opacity-90 text-sm">Personal appointment announcements</p>
                                    </div>
                                    <button id="playVoiceAnnouncementBtn" class="bg-gradient-to-r from-blue-500 to-purple-600 hover:from-blue-600 hover:to-purple-700 text-white px-6 py-3 rounded-lg transition-all duration-200 flex items-center space-x-2 shadow-lg transform hover:scale-105">
                                        <i class="fas fa-volume-up text-xl"></i>
                                        <span class="font-medium">Play Voice Announcements</span>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Stats Cards -->
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                        <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-lg">
                            <div class="flex items-center">
                                <div class="w-12 h-12 bg-blue-100 rounded-lg flex items-center justify-center mr-4">
                                    <i class="fas fa-calendar-day text-blue-600 text-xl"></i>
                                </div>
                                <div>
                                    <p class="text-gray-600 dark:text-gray-400 text-sm">Today's Appointments</p>
                                    <p class="text-2xl font-bold" id="physioTodayAppointments">2</p>
                                </div>
                            </div>
                        </div>
                        <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-lg">
                            <div class="flex items-center">
                                <div class="w-12 h-12 bg-green-100 rounded-lg flex items-center justify-center mr-4">
                                    <i class="fas fa-users text-green-600 text-xl"></i>
                                </div>
                                <div>
                                    <p class="text-gray-600 dark:text-gray-400 text-sm">Active Patients</p>
                                    <p class="text-2xl font-bold" id="physioActivePatients">12</p>
                                </div>
                            </div>
                        </div>
                        <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-lg">
                            <div class="flex items-center">
                                <div class="w-12 h-12 bg-purple-100 rounded-lg flex items-center justify-center mr-4">
                                    <i class="fas fa-clipboard-check text-purple-600 text-xl"></i>
                                </div>
                                <div>
                                    <p class="text-gray-600 dark:text-gray-400 text-sm">Treatments This Week</p>
                                    <p class="text-2xl font-bold" id="physioWeeklyTreatments">8</p>
                                </div>
                            </div>
                        </div>
                        <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-lg">
                            <div class="flex items-center">
                                <div class="w-12 h-12 bg-orange-100 rounded-lg flex items-center justify-center mr-4">
                                    <i class="fas fa-star text-orange-600 text-xl"></i>
                                </div>
                                <div>
                                    <p class="text-gray-600 dark:text-gray-400 text-sm">Patient Rating</p>
                                    <p class="text-2xl font-bold" id="physioRating">4.9</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Today's Schedule -->
                    <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-lg">
                        <h3 class="text-xl font-semibold mb-4">Today's Schedule</h3>
                        <div id="todaySchedule" class="space-y-3">
                            <div class="flex items-center justify-between p-3 bg-blue-50 dark:bg-blue-900/20 rounded-lg">
                                <div class="flex items-center">
                                    <div class="w-12 h-12 bg-secondary rounded-full flex items-center justify-center text-white font-bold mr-3">
                                        AK
                                    </div>
                                    <div>
                                        <p class="font-medium">10:00 AM - Ahmed Al-Khalifa</p>
                                        <p class="text-sm text-gray-600 dark:text-gray-400">60 minutes ‚Ä¢ Follow-up for back pain treatment</p>
                                    </div>
                                </div>
                                <span class="px-2 py-1 bg-blue-100 text-blue-800 dark:bg-blue-900 dark:text-blue-200 rounded text-xs">scheduled</span>
                            </div>
                            <div class="flex items-center justify-between p-3 bg-blue-50 dark:bg-blue-900/20 rounded-lg">
                                <div class="flex items-center">
                                    <div class="w-12 h-12 bg-secondary rounded-full flex items-center justify-center text-white font-bold mr-3">
                                        FZ
                                    </div>
                                    <div>
                                        <p class="font-medium">2:00 PM - Fatima Al-Zahra</p>
                                        <p class="text-sm text-gray-600 dark:text-gray-400">45 minutes ‚Ä¢ Initial assessment for knee injury</p>
                                    </div>
                                </div>
                                <span class="px-2 py-1 bg-blue-100 text-blue-800 dark:bg-blue-900 dark:text-blue-200 rounded text-xs">scheduled</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Physiotherapist Appointments View -->
                <div id="physio-appointments" class="physio-view hidden">
                    <h1 class="text-3xl font-bold mb-6">My Appointments</h1>
                    <div class="bg-white dark:bg-gray-800 rounded-lg shadow-lg p-6">
                        <h3 class="text-lg font-semibold mb-4">Your Appointments</h3>
                        <div class="space-y-4">
                            <div class="p-4 border border-gray-200 dark:border-gray-700 rounded-lg">
                                <div class="flex items-center justify-between">
                                    <div class="flex items-center space-x-4">
                                        <div class="w-12 h-12 bg-secondary rounded-full flex items-center justify-center text-white font-bold">
                                            AK
                                        </div>
                                        <div>
                                            <h4 class="font-semibold text-lg">Ahmed Al-Khalifa</h4>
                                            <p class="text-gray-600 dark:text-gray-400">ahmed@email.com ‚Ä¢ 97123456</p>
                                            <p class="text-sm text-gray-500">Today, 10:00 AM (60 min)</p>
                                        </div>
                                    </div>
                                    <span class="px-3 py-1 bg-blue-100 text-blue-800 dark:bg-blue-900 dark:text-blue-200 rounded-full text-xs font-medium">Scheduled</span>
                                </div>
                                <div class="mt-4 p-3 bg-gray-50 dark:bg-gray-700 rounded-lg">
                                    <p class="text-sm text-gray-700 dark:text-gray-300">
                                        <i class="fas fa-sticky-note mr-2"></i><strong>Notes:</strong> Follow-up for back pain treatment
                                    </p>
                                </div>
                            </div>
                            <div class="p-4 border border-gray-200 dark:border-gray-700 rounded-lg">
                                <div class="flex items-center justify-between">
                                    <div class="flex items-center space-x-4">
                                        <div class="w-12 h-12 bg-secondary rounded-full flex items-center justify-center text-white font-bold">
                                            FZ
                                        </div>
                                        <div>
                                            <h4 class="font-semibold text-lg">Fatima Al-Zahra</h4>
                                            <p class="text-gray-600 dark:text-gray-400">fatima@email.com ‚Ä¢ 97654321</p>
                                            <p class="text-sm text-gray-500">Today, 2:00 PM (45 min)</p>
                                        </div>
                                    </div>
                                    <span class="px-3 py-1 bg-blue-100 text-blue-800 dark:bg-blue-900 dark:text-blue-200 rounded-full text-xs font-medium">Scheduled</span>
                                </div>
                                <div class="mt-4 p-3 bg-gray-50 dark:bg-gray-700 rounded-lg">
                                    <p class="text-sm text-gray-700 dark:text-gray-300">
                                        <i class="fas fa-sticky-note mr-2"></i><strong>Notes:</strong> Initial assessment for knee injury
                                    </p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div id="physio-patients" class="physio-view hidden">
                    <h1 class="text-3xl font-bold mb-6">Patient Files</h1>
                    <div class="bg-white dark:bg-gray-800 rounded-lg shadow-lg p-6">
                        <p class="text-gray-600 dark:text-gray-400">Patient file management for physiotherapists coming soon...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Loading Spinner -->
    <div id="loadingSpinner" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-white dark:bg-gray-800 p-8 rounded-lg shadow-xl">
            <div class="flex items-center space-x-4">
                <i class="fas fa-spinner loading text-primary text-2xl"></i>
                <span class="text-lg">Loading...</span>
            </div>
        </div>
    </div>

    <script>
        // Dark mode setup
        if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
            document.documentElement.classList.add('dark');
        }
        window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', event => {
            if (event.matches) {
                document.documentElement.classList.add('dark');
            } else {
                document.documentElement.classList.remove('dark');
            }
        });

        // Global variables
        let supabase = null;
        let currentView = 'dashboard';
        let currentPatientId = null;
        let connectionDetails = null;
        let currentUser = null;
        let isLoggedIn = false;

        // Predefined users
        const adminUser = {
            email: 'DhariBmi@gmail.com',
            password: 'Dharui1979',
            role: 'admin',
            name: 'Admin User'
        };

        const mariamUser = {
            email: 'Mariambmi@gmail.com',
            password: 'Mariam1979!',
            role: 'physiotherapist',
            name: 'Mariam Abdulatheem Ali',
            physioData: {
                id: 'mariam-physio-001',
                first_name: 'Mariam',
                last_name: 'Abdulatheem Ali',
                email: 'Mariambmi@gmail.com',
                phone: '97362123',
                license_number: 'PT-2024-MA',
                years_experience: 7,
                specializations: ['Orthopedic', 'Sports Medicine', 'Manual Therapy'],
                employment_status: 'full-time',
                is_active: true
            }
        };

        // Utility functions
        function showLoading() {
            document.getElementById('loadingSpinner').classList.remove('hidden');
        }

        function hideLoading() {
            document.getElementById('loadingSpinner').classList.add('hidden');
        }

        function showNotification(message, type = 'success') {
            const notification = document.createElement('div');
            notification.className = `fixed top-4 right-4 p-4 rounded-lg shadow-lg z-50 ${
                type === 'success' ? 'bg-green-500' : 'bg-red-500'
            } text-white`;
            notification.textContent = message;
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.remove();
            }, 3000);
        }

        function showLoginError(message) {
            const errorDiv = document.getElementById('loginError');
            if (errorDiv) {
                errorDiv.textContent = message;
                errorDiv.classList.remove('hidden');
                
                setTimeout(() => {
                    errorDiv.classList.add('hidden');
                }, 5000);
            }
        }

        function showPhysioLoginError(message) {
            const errorDiv = document.getElementById('physioLoginError');
            if (errorDiv) {
                errorDiv.textContent = message;
                errorDiv.classList.remove('hidden');
                
                setTimeout(() => {
                    errorDiv.classList.add('hidden');
                }, 5000);
            }
        }

        // Navigation functions
        function setupNavigation() {
            const navButtons = document.querySelectorAll('.nav-btn');
            navButtons.forEach(btn => {
                btn.addEventListener('click', () => {
                    const view = btn.dataset.view;
                    showView(view);
                    
                    // Update active state
                    document.querySelectorAll('.nav-btn').forEach(b => {
                        b.classList.remove('bg-primary', 'text-white');
                    });
                    btn.classList.add('bg-primary', 'text-white');
                });
            });
        }

        function showView(viewName) {
            try {
                console.log('Switching to view:', viewName);
                
                // Hide all views
                document.querySelectorAll('.view').forEach(view => {
                    view.classList.add('hidden');
                });
                
                // Show target view
                const targetView = document.getElementById(viewName);
                if (targetView) {
                    targetView.classList.remove('hidden');
                    currentView = viewName;
                    console.log('Successfully switched to view:', viewName);
                } else {
                    console.error('Target view not found:', viewName);
                    // Fallback to dashboard if view not found
                    const dashboardView = document.getElementById('dashboard');
                    if (dashboardView) {
                        dashboardView.classList.remove('hidden');
                        currentView = 'dashboard';
                    }
                }
            } catch (error) {
                console.error('Error switching views:', error);
                // Ensure dashboard is visible as fallback
                const dashboardView = document.getElementById('dashboard');
                if (dashboardView) {
                    dashboardView.classList.remove('hidden');
                    currentView = 'dashboard';
                }
            }
        }

        function setupPhysioNavigation() {
            const physioNavButtons = document.querySelectorAll('.physio-nav-btn');
            physioNavButtons.forEach(btn => {
                btn.addEventListener('click', () => {
                    const view = btn.dataset.view;
                    showPhysioView(view);
                    
                    // Update active state
                    physioNavButtons.forEach(b => {
                        b.classList.remove('bg-secondary', 'text-white');
                    });
                    btn.classList.add('bg-secondary', 'text-white');
                });
            });
        }

        function showPhysioView(viewName) {
            // Hide all physio views
            document.querySelectorAll('.physio-view').forEach(view => {
                view.classList.add('hidden');
            });
            
            // Show target view
            const targetView = document.getElementById(viewName);
            if (targetView) {
                targetView.classList.remove('hidden');
            }
        }

        function logout() {
            currentUser = null;
            isLoggedIn = false;
            
            // Hide all app views
            document.getElementById('mainApp').classList.add('hidden');
            document.getElementById('physioDashboard').classList.add('hidden');
            document.getElementById('adminLoginPage').classList.add('hidden');
            document.getElementById('physioLoginPage').classList.add('hidden');
            
            // Show user selection
            document.getElementById('userTypeSelection').classList.remove('hidden');
            
            // Clear forms
            document.getElementById('loginForm').reset();
            document.getElementById('physioLoginForm').reset();
            
            showNotification('You have been logged out successfully.');
        }

        // Initialize when DOM is ready - SAFE VERSION
        function safeInitialize() {
            try {
                initializeApp();
            } catch (error) {
                console.error('Initialization error:', error);
                setTimeout(safeInitialize, 100); // Retry after 100ms
            }
        }

        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', safeInitialize);
        } else {
            safeInitialize();
        }

        function initializeApp() {
            console.log('Initializing PhysioTech Application...');
            
            setupNavigation();
            setupPhysioNavigation();

            // Login type selection functionality
            document.getElementById('adminLoginBtn').addEventListener('click', () => {
                document.getElementById('userTypeSelection').classList.add('hidden');
                document.getElementById('adminLoginPage').classList.remove('hidden');
            });

            document.getElementById('physioLoginBtn').addEventListener('click', () => {
                document.getElementById('userTypeSelection').classList.add('hidden');
                document.getElementById('physioLoginPage').classList.remove('hidden');
            });

            // Back buttons
            document.getElementById('backToSelection').addEventListener('click', () => {
                document.getElementById('physioLoginPage').classList.add('hidden');
                document.getElementById('userTypeSelection').classList.remove('hidden');
            });

            const backFromAdmin = document.getElementById('backToSelectionFromAdmin');
            if (backFromAdmin) {
                backFromAdmin.addEventListener('click', () => {
                    document.getElementById('adminLoginPage').classList.add('hidden');
                    document.getElementById('userTypeSelection').classList.remove('hidden');
                });
            }

            // Password toggles
            document.getElementById('togglePassword').addEventListener('click', () => {
                const passwordInput = document.getElementById('loginPassword');
                const toggleIcon = document.querySelector('#togglePassword i');
                
                if (passwordInput.type === 'password') {
                    passwordInput.type = 'text';
                    toggleIcon.classList.remove('fa-eye');
                    toggleIcon.classList.add('fa-eye-slash');
                } else {
                    passwordInput.type = 'password';
                    toggleIcon.classList.remove('fa-eye-slash');
                    toggleIcon.classList.add('fa-eye');
                }
            });

            document.getElementById('togglePhysioPassword').addEventListener('click', () => {
                const passwordInput = document.getElementById('physioLoginPassword');
                const toggleIcon = document.querySelector('#togglePhysioPassword i');
                
                if (passwordInput.type === 'password') {
                    passwordInput.type = 'text';
                    toggleIcon.classList.remove('fa-eye');
                    toggleIcon.classList.add('fa-eye-slash');
                } else {
                    passwordInput.type = 'password';
                    toggleIcon.classList.remove('fa-eye-slash');
                    toggleIcon.classList.add('fa-eye');
                }
            });

            // Admin login form
            document.getElementById('loginForm').addEventListener('submit', async (e) => {
                e.preventDefault();
                
                const email = document.getElementById('loginEmail').value.trim();
                const password = document.getElementById('loginPassword').value;
                
                if (!email || !password) {
                    showLoginError('Please fill in all fields');
                    return;
                }

                try {
                    showLoading();
                    
                    if (email === adminUser.email && password === adminUser.password) {
                        currentUser = adminUser;
                        isLoggedIn = true;
                        
                        document.getElementById('adminLoginPage').classList.add('hidden');
                        document.getElementById('mainApp').classList.remove('hidden');
                        
                        document.getElementById('userEmail').textContent = currentUser.email;
                        showNotification('Welcome to PhysioTech! You are logged in as Administrator.');
                    } else {
                        showLoginError('Invalid email or password. Use: DhariBmi@gmail.com / Dharui1979');
                    }
                    
                } catch (error) {
                    console.error('Login error:', error);
                    showLoginError('Login failed. Please try again.');
                } finally {
                    hideLoading();
                }
            });

            // Physiotherapist login form
            document.getElementById('physioLoginForm').addEventListener('submit', async (e) => {
                e.preventDefault();
                
                const email = document.getElementById('physioLoginEmail').value.trim();
                const password = document.getElementById('physioLoginPassword').value;
                
                if (!email || !password) {
                    showPhysioLoginError('Please fill in all fields');
                    return;
                }

                try {
                    showLoading();
                    
                    if (email === mariamUser.email && password === mariamUser.password) {
                        currentUser = mariamUser;
                        isLoggedIn = true;
                        
                        document.getElementById('physioLoginPage').classList.add('hidden');
                        document.getElementById('physioDashboard').classList.remove('hidden');
                        
                        document.getElementById('physioUserName').textContent = mariamUser.name;
                        document.getElementById('physioUserEmail').textContent = mariamUser.email;
                        
                        // Load assigned appointments when physiotherapist logs in
                        loadAssignedAppointments();
                        
                        showNotification('Welcome back, ' + mariamUser.name + '! üéµ Voice announcements are ready for you.');
                    } else {
                        showPhysioLoginError('Invalid email or password. Use: Mariambmi@gmail.com / Mariam1979!');
                    }
                    
                } catch (error) {
                    console.error('Physiotherapist login error:', error);
                    showPhysioLoginError('Login failed. Please try again.');
                } finally {
                    hideLoading();
                }
            });

            // Logout buttons
            document.getElementById('logoutBtn').addEventListener('click', logout);
            document.getElementById('physioLogoutBtn').addEventListener('click', logout);

            // Voice announcement functionality
            document.getElementById('playVoiceAnnouncementBtn').addEventListener('click', async () => {
                const button = document.getElementById('playVoiceAnnouncementBtn');
                const originalContent = button.innerHTML;
                
                try {
                    button.innerHTML = '<i class="fas fa-spinner fa-spin text-xl"></i><span class="font-medium">Generating...</span>';
                    button.disabled = true;
                    
                    const announcement = `Hello Dr. Mariam Abdulatheem Ali. Welcome back to your PhysioTech dashboard. You have 2 appointments scheduled for today. Have a wonderful day at Bahrain Mobility International!`;
                    
                    // Use Poe's voice bot for the announcement
                    if (window.Poe && window.Poe.sendUserMessage) {
                        await window.Poe.sendUserMessage(
                            `@ElevenLabs-v2.5-Turbo ${announcement} --voice Sarah`,
                            {
                                handler: 'voice-handler',
                                stream: false,
                                openChat: false
                            }
                        );
                    } else {
                        showNotification('üéµ Voice announcement would play here! (Poe API not available in this environment)');
                    }
                    
                } catch (error) {
                    console.error('Voice announcement error:', error);
                    showNotification('üéµ Voice announcement feature activated! (Demo mode)', 'success');
                } finally {
                    button.innerHTML = originalContent;
                    button.disabled = false;
                }
            });

            // Register voice handler if Poe API is available
            if (window.Poe && window.Poe.registerHandler) {
                window.Poe.registerHandler('voice-handler', (result) => {
                    if (result.status === 'complete') {
                        showNotification('üéµ Voice announcement played successfully!');
                    } else if (result.status === 'error') {
                        showNotification('Voice announcement failed', 'error');
                    }
                });
            }

            // Connect Supabase button
            document.getElementById('connectSupabase').addEventListener('click', () => {
                showSupabaseConnectionModal();
            });

            // Quick action buttons
            const quickAddPatient = document.getElementById('quickAddPatient');
            if (quickAddPatient) {
                quickAddPatient.addEventListener('click', () => {
                    showView('patients');
                    showNotification('Navigate to Patients section');
                });
            }

            const quickScheduleAppointment = document.getElementById('quickScheduleAppointment');
            if (quickScheduleAppointment) {
                quickScheduleAppointment.addEventListener('click', () => {
                    showView('appointments');
                    showNotification('Navigate to Appointments section');
                });
            }

            const quickAddPhysiotherapist = document.getElementById('quickAddPhysiotherapist');
            if (quickAddPhysiotherapist) {
                quickAddPhysiotherapist.addEventListener('click', () => {
                    showView('physiotherapists');
                    showNotification('Navigate to Physiotherapists section');
                });
            }

            // Add buttons
            const addPatientBtn = document.getElementById('addPatientBtn');
            if (addPatientBtn) {
                addPatientBtn.addEventListener('click', () => {
                    showAddPatientModal();
                });
            }

            const addAppointmentBtn = document.getElementById('addAppointmentBtn');
            if (addAppointmentBtn) {
                addAppointmentBtn.addEventListener('click', () => {
                    showAddAppointmentModal();
                });
            }

            const addPhysiotherapistBtn = document.getElementById('addPhysiotherapistBtn');
            if (addPhysiotherapistBtn) {
                addPhysiotherapistBtn.addEventListener('click', () => {
                    showAddPhysiotherapistModal();
                });
            }

            console.log('PhysioTech Application initialized successfully!');
        }

        // Global functions for button clicks
        function viewPatientDetails(id) {
            showNotification('View patient details feature available in full version!');
        }

        function editPatient(id) {
            showNotification('Edit patient feature available in full version!');
        }

        function editPhysiotherapist(id) {
            showNotification('Edit physiotherapist feature available in full version!');
        }

        // Enhanced Patient Assignment System
        function assignPatientToPhysiotherapist(patientId, patientName = '') {
            console.log('Assigning patient:', patientId, patientName);
            
            // Create assignment modal
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
            modal.innerHTML = `
                <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-xl max-w-md w-full mx-4">
                    <div class="flex items-center mb-4">
                        <i class="fas fa-user-md text-primary text-2xl mr-3"></i>
                        <h3 class="text-lg font-semibold">Assign Patient to Physiotherapist</h3>
                    </div>
                    
                    <div class="bg-blue-50 dark:bg-blue-900/20 border border-blue-200 dark:border-blue-800 rounded-lg p-4 mb-4">
                        <h4 class="font-medium text-blue-900 dark:text-blue-100 mb-2">Patient: ${patientName || 'Dharui Fakhro'}</h4>
                        <p class="text-sm text-blue-800 dark:text-blue-200">This patient will be assigned exclusively to the selected physiotherapist. Only that physiotherapist will see appointments for this patient.</p>
                    </div>
                    
                    <div class="mb-4">
                        <label class="block text-sm font-medium mb-2">Select Physiotherapist</label>
                        <select id="selectPhysiotherapist" class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-800 text-base">
                            <option value="">Choose a physiotherapist...</option>
                            <option value="mariam-physio-001" selected>Dr. Mariam Abdulatheem Ali (Orthopedic, Sports Medicine)</option>
                            <option value="dhari-physio-001">Dr. Dhari Fakhroo (Orthopedic, Neurological)</option>
                        </select>
                    </div>
                    <div class="mb-4">
                        <label class="block text-sm font-medium mb-2">Assignment Notes (Optional)</label>
                        <textarea id="assignmentNotes" rows="3" class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-800 text-base" placeholder="Special instructions or notes for this assignment..."></textarea>
                    </div>
                    <div class="flex justify-end space-x-3">
                        <button onclick="this.closest('.fixed').remove()" class="px-4 py-2 text-gray-600 dark:text-gray-400 hover:bg-gray-100 dark:hover:bg-gray-700 rounded">Cancel</button>
                        <button onclick="confirmAssignment('${patientId}', '${patientName || 'Dharui Fakhro'}')" class="px-4 py-2 bg-primary text-white hover:bg-secondary rounded">
                            <i class="fas fa-user-md mr-2"></i>Assign Patient
                        </button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }

        // Confirm Assignment Function
        function confirmAssignment(patientId, patientName) {
            const physiotherapistId = document.getElementById('selectPhysiotherapist').value;
            const assignmentNotes = document.getElementById('assignmentNotes').value;
            const selectedOption = document.getElementById('selectPhysiotherapist').selectedOptions[0];
            const physiotherapistName = selectedOption ? selectedOption.textContent : '';

            if (!physiotherapistId) {
                showNotification('Please select a physiotherapist', 'error');
                return;
            }

            try {
                showLoading();

                // Create assignment record in our demo system
                const assignment = {
                    id: `assignment-${Date.now()}`,
                    patientId: patientId,
                    patientName: patientName,
                    physiotherapistId: physiotherapistId,
                    physiotherapistName: physiotherapistName,
                    assignmentNotes: assignmentNotes,
                    assignedDate: new Date().toISOString(),
                    assignedBy: currentUser?.name || 'Administrator'
                };

                // Store assignment for physiotherapist to see
                if (!window.patientAssignments) {
                    window.patientAssignments = [];
                }
                window.patientAssignments.push(assignment);

                // Create appointment for tomorrow at 10:00 AM
                const appointmentDate = new Date();
                appointmentDate.setDate(appointmentDate.getDate() + 1);
                appointmentDate.setHours(10, 0, 0, 0);

                const appointment = {
                    id: `appointment-${Date.now()}`,
                    patientId: patientId,
                    patientName: patientName,
                    physiotherapistId: physiotherapistId,
                    physiotherapistName: physiotherapistName,
                    appointmentDate: appointmentDate.toISOString(),
                    duration: 60,
                    status: 'scheduled',
                    notes: `üéØ ASSIGNED: ${assignmentNotes || 'This patient has been assigned to you by the administrator.'}`,
                    patients: {
                        first_name: patientName.split(' ')[0] || 'Dharui',
                        last_name: patientName.split(' ').slice(1).join(' ') || 'Fakhro',
                        email: 'dharui123@gmail.com',
                        phone: '37352222',
                        cpr_number: '001000853'
                    },
                    physiotherapists: {
                        first_name: 'Mariam',
                        last_name: 'Abdulatheem Ali',
                        email: 'Mariambmi@gmail.com'
                    }
                };

                // Store appointment for physiotherapist dashboard
                if (!window.assignedAppointments) {
                    window.assignedAppointments = [];
                }
                window.assignedAppointments.push(appointment);

                // Close modal
                document.querySelector('.fixed').remove();
                
                hideLoading();
                
                // Show success notification with details
                const doctorName = physiotherapistName.replace(' (Orthopedic, Sports Medicine)', '').replace(' (Orthopedic, Neurological)', '');
                showNotification(`‚úÖ SUCCESS! ${patientName} has been assigned to ${doctorName}. The physiotherapist will see this patient in their dashboard with an appointment scheduled for tomorrow at 10:00 AM!`, 'success');

                console.log('Assignment created:', assignment);
                console.log('Appointment created:', appointment);

            } catch (error) {
                console.error('Error creating assignment:', error);
                showNotification('Error creating assignment: ' + error.message, 'error');
                hideLoading();
            }
        }

        // Load Assigned Appointments for Physiotherapist
        function loadAssignedAppointments() {
            console.log('Loading assigned appointments for physiotherapist...');
            
            // Get today's schedule element
            const scheduleContainer = document.getElementById('todaySchedule');
            if (!scheduleContainer) {
                console.error('Schedule container not found');
                return;
            }

            // Check if there are any assigned appointments
            if (window.assignedAppointments && window.assignedAppointments.length > 0) {
                console.log('Found assigned appointments:', window.assignedAppointments.length);
                
                // Clear existing schedule and add assigned appointments
                scheduleContainer.innerHTML = '';
                
                // Filter appointments for today and this physiotherapist
                const today = new Date().toDateString();
                const todayAppointments = window.assignedAppointments.filter(appointment => {
                    const appointmentDate = new Date(appointment.appointmentDate);
                    return appointmentDate.toDateString() === today && 
                           appointment.physiotherapistId === 'mariam-physio-001';
                });

                if (todayAppointments.length > 0) {
                    todayAppointments.forEach(appointment => {
                        const appointmentTime = new Date(appointment.appointmentDate).toLocaleTimeString('en-US', {
                            hour: '2-digit',
                            minute: '2-digit'
                        });

                        const appointmentCard = document.createElement('div');
                        appointmentCard.className = 'flex items-center justify-between p-3 bg-green-50 dark:bg-green-900/20 rounded-lg border-l-4 border-green-500';
                        appointmentCard.innerHTML = `
                            <div class="flex items-center">
                                <div class="w-12 h-12 bg-green-600 rounded-full flex items-center justify-center text-white font-bold mr-3">
                                    ${appointment.patients.first_name.charAt(0)}${appointment.patients.last_name.charAt(0)}
                                </div>
                                <div>
                                    <p class="font-medium">${appointmentTime} - ${appointment.patients.first_name} ${appointment.patients.last_name}</p>
                                    <p class="text-sm text-gray-600 dark:text-gray-400">${appointment.duration} minutes ‚Ä¢ üéØ NEW ASSIGNMENT</p>
                                    <p class="text-xs text-green-700 dark:text-green-300">${appointment.notes}</p>
                                </div>
                            </div>
                            <span class="px-2 py-1 bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-200 rounded text-xs">‚ú® Assigned</span>
                        `;
                        scheduleContainer.appendChild(appointmentCard);
                    });

                    // Update appointment count
                    const countElements = document.querySelectorAll('#todayAppointmentsCount, #physioTodayAppointments');
                    countElements.forEach(el => {
                        if (el) el.textContent = todayAppointments.length + 2; // +2 for existing demo appointments
                    });

                    // Show success message
                    showNotification(`üìÖ Found ${todayAppointments.length} new assigned appointment(s) for today!`, 'success');
                } else {
                    // Add tomorrow's appointments to the view
                    const tomorrow = new Date();
                    tomorrow.setDate(tomorrow.getDate() + 1);
                    const tomorrowAppointments = window.assignedAppointments.filter(appointment => {
                        const appointmentDate = new Date(appointment.appointmentDate);
                        return appointmentDate.toDateString() === tomorrow.toDateString() && 
                               appointment.physiotherapistId === 'mariam-physio-001';
                    });

                    if (tomorrowAppointments.length > 0) {
                        // Add a separator for tomorrow's appointments
                        const separator = document.createElement('div');
                        separator.className = 'mt-4 mb-2 border-t border-gray-200 dark:border-gray-600 pt-4';
                        separator.innerHTML = '<h4 class="font-semibold text-gray-700 dark:text-gray-300">Tomorrow\'s Assignments</h4>';
                        scheduleContainer.appendChild(separator);

                        tomorrowAppointments.forEach(appointment => {
                            const appointmentTime = new Date(appointment.appointmentDate).toLocaleTimeString('en-US', {
                                hour: '2-digit',
                                minute: '2-digit'
                            });

                            const appointmentCard = document.createElement('div');
                            appointmentCard.className = 'flex items-center justify-between p-3 bg-blue-50 dark:bg-blue-900/20 rounded-lg border-l-4 border-blue-500';
                            appointmentCard.innerHTML = `
                                <div class="flex items-center">
                                    <div class="w-12 h-12 bg-blue-600 rounded-full flex items-center justify-center text-white font-bold mr-3">
                                        ${appointment.patients.first_name.charAt(0)}${appointment.patients.last_name.charAt(0)}
                                    </div>
                                    <div>
                                        <p class="font-medium">Tomorrow ${appointmentTime} - ${appointment.patients.first_name} ${appointment.patients.last_name}</p>
                                        <p class="text-sm text-gray-600 dark:text-gray-400">${appointment.duration} minutes ‚Ä¢ üéØ NEWLY ASSIGNED</p>
                                        <p class="text-xs text-blue-700 dark:text-blue-300">${appointment.notes}</p>
                                    </div>
                                </div>
                                <span class="px-2 py-1 bg-blue-100 text-blue-800 dark:bg-blue-900 dark:text-blue-200 rounded text-xs">‚ú® Scheduled</span>
                            `;
                            scheduleContainer.appendChild(appointmentCard);
                        });

                        showNotification(`üìÖ Found ${tomorrowAppointments.length} new assigned appointment(s) for tomorrow!`, 'success');
                    }
                }
            } else {
                console.log('No assigned appointments found');
                showNotification('üìã No new patient assignments yet. Your regular schedule is displayed.', 'success');
            }
        }

        // Add Patient Modal Function
        function showAddPatientModal() {
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4';
            modal.innerHTML = `
                <div class="bg-white dark:bg-gray-800 rounded-lg shadow-xl max-w-2xl w-full max-h-screen overflow-y-auto">
                    <div class="sticky top-0 bg-white dark:bg-gray-800 border-b border-gray-200 dark:border-gray-700 px-6 py-4">
                        <div class="flex items-center justify-between">
                            <div class="flex items-center">
                                <i class="fas fa-user-plus text-primary text-2xl mr-3"></i>
                                <h2 class="text-2xl font-bold">Add New Patient</h2>
                            </div>
                            <button onclick="this.closest('.fixed').remove()" class="text-gray-400 hover:text-gray-600 text-2xl">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                    </div>
                    
                    <form id="addPatientForm" class="p-6">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <!-- Personal Information -->
                            <div class="col-span-full">
                                <h3 class="text-lg font-semibold mb-4 flex items-center">
                                    <i class="fas fa-user text-primary mr-2"></i>
                                    Personal Information
                                </h3>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium mb-2">First Name *</label>
                                <input type="text" id="newFirstName" required 
                                       class="w-full px-4 py-3 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-base focus:ring-2 focus:ring-primary focus:border-primary" 
                                       placeholder="Enter first name">
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium mb-2">Last Name *</label>
                                <input type="text" id="newLastName" required 
                                       class="w-full px-4 py-3 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-base focus:ring-2 focus:ring-primary focus:border-primary" 
                                       placeholder="Enter last name">
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium mb-2">Email</label>
                                <input type="email" id="newEmail" 
                                       class="w-full px-4 py-3 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-base focus:ring-2 focus:ring-primary focus:border-primary" 
                                       placeholder="patient@email.com">
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium mb-2">Phone Number</label>
                                <input type="tel" id="newPhone" 
                                       class="w-full px-4 py-3 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-base focus:ring-2 focus:ring-primary focus:border-primary" 
                                       placeholder="97123456">
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium mb-2">C.P.R Number</label>
                                <input type="text" id="newCprNumber" 
                                       class="w-full px-4 py-3 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-base focus:ring-2 focus:ring-primary focus:border-primary" 
                                       placeholder="001000853">
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium mb-2">Date of Birth</label>
                                <input type="date" id="newDateOfBirth" 
                                       class="w-full px-4 py-3 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-base focus:ring-2 focus:ring-primary focus:border-primary">
                            </div>
                            
                            <div class="col-span-full">
                                <label class="block text-sm font-medium mb-2">Address</label>
                                <input type="text" id="newAddress" 
                                       class="w-full px-4 py-3 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-base focus:ring-2 focus:ring-primary focus:border-primary" 
                                       placeholder="Patient address">
                            </div>
                            
                            <!-- Medical Information -->
                            <div class="col-span-full">
                                <h3 class="text-lg font-semibold mb-4 flex items-center mt-4">
                                    <i class="fas fa-notes-medical text-primary mr-2"></i>
                                    Medical Information
                                </h3>
                            </div>
                            
                            <div class="col-span-full">
                                <label class="block text-sm font-medium mb-2">Medical History</label>
                                <textarea id="newMedicalHistory" rows="4" 
                                          class="w-full px-4 py-3 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-base focus:ring-2 focus:ring-primary focus:border-primary" 
                                          placeholder="Enter any relevant medical history, conditions, allergies, or previous treatments..."></textarea>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium mb-2">Emergency Contact Name</label>
                                <input type="text" id="newEmergencyContactName" 
                                       class="w-full px-4 py-3 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-base focus:ring-2 focus:ring-primary focus:border-primary" 
                                       placeholder="Emergency contact name">
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium mb-2">Emergency Contact Phone</label>
                                <input type="tel" id="newEmergencyContactPhone" 
                                       class="w-full px-4 py-3 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-base focus:ring-2 focus:ring-primary focus:border-primary" 
                                       placeholder="97123456">
                            </div>
                        </div>
                        
                        <div class="flex justify-end space-x-4 mt-8 pt-6 border-t border-gray-200 dark:border-gray-700">
                            <button type="button" onclick="this.closest('.fixed').remove()" 
                                    class="px-6 py-3 text-gray-600 dark:text-gray-400 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-lg transition-colors">
                                Cancel
                            </button>
                            <button type="submit" 
                                    class="px-6 py-3 bg-primary text-white hover:bg-secondary rounded-lg transition-colors font-medium">
                                <i class="fas fa-plus mr-2"></i>Add Patient
                            </button>
                        </div>
                    </form>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            // Handle form submission
            document.getElementById('addPatientForm').addEventListener('submit', handleAddPatient);
        }

        // Handle Add Patient Form Submission
        async function handleAddPatient(e) {
            e.preventDefault();
            
            const firstName = document.getElementById('newFirstName').value.trim();
            const lastName = document.getElementById('newLastName').value.trim();
            
            if (!firstName || !lastName) {
                showNotification('Please fill in the required fields (First Name and Last Name)', 'error');
                return;
            }
            
            try {
                showLoading();
                
                // Create patient object
                const newPatient = {
                    id: `patient-${Date.now()}`,
                    first_name: firstName,
                    last_name: lastName,
                    email: document.getElementById('newEmail').value.trim(),
                    phone: document.getElementById('newPhone').value.trim(),
                    cpr_number: document.getElementById('newCprNumber').value.trim(),
                    date_of_birth: document.getElementById('newDateOfBirth').value,
                    address: document.getElementById('newAddress').value.trim(),
                    medical_history: document.getElementById('newMedicalHistory').value.trim(),
                    emergency_contact_name: document.getElementById('newEmergencyContactName').value.trim(),
                    emergency_contact_phone: document.getElementById('newEmergencyContactPhone').value.trim(),
                    created_at: new Date().toISOString(),
                    status: 'active'
                };
                
                // Store patient in local array for demo
                if (!window.patients) {
                    window.patients = [];
                }
                window.patients.push(newPatient);
                
                // Add patient card to the grid
                addPatientToGrid(newPatient);
                
                // Close modal
                document.querySelector('.fixed').remove();
                
                hideLoading();
                
                showNotification(`‚úÖ Patient "${firstName} ${lastName}" has been added successfully!`, 'success');
                
                // Update patient count in dashboard
                const totalPatientsElement = document.getElementById('totalPatients');
                if (totalPatientsElement) {
                    const currentCount = parseInt(totalPatientsElement.textContent) || 15;
                    totalPatientsElement.textContent = currentCount + 1;
                }
                
                console.log('New patient added:', newPatient);
                
            } catch (error) {
                console.error('Error adding patient:', error);
                showNotification('Error adding patient: ' + error.message, 'error');
                hideLoading();
            }
        }

        // Add Patient Card to Grid
        function addPatientToGrid(patient) {
            const patientsGrid = document.getElementById('patientsGrid');
            if (!patientsGrid) return;
            
            // Calculate age from date of birth
            let age = 'Unknown';
            if (patient.date_of_birth) {
                const birthDate = new Date(patient.date_of_birth);
                const today = new Date();
                age = today.getFullYear() - birthDate.getFullYear();
                if (today.getMonth() < birthDate.getMonth() || 
                    (today.getMonth() === birthDate.getMonth() && today.getDate() < birthDate.getDate())) {
                    age--;
                }
                age += ' years old';
            }
            
            // Create initials
            const initials = (patient.first_name.charAt(0) + patient.last_name.charAt(0)).toUpperCase();
            
            // Create patient card
            const patientCard = document.createElement('div');
            patientCard.className = 'bg-white dark:bg-gray-800 rounded-lg shadow-lg p-6 hover:shadow-xl transition-shadow border-l-4 border-green-500';
            patientCard.innerHTML = `
                <div class="flex items-center mb-4">
                    <div class="w-16 h-16 bg-green-500 rounded-full flex items-center justify-center text-white font-bold text-xl mr-4">
                        ${initials}
                    </div>
                    <div>
                        <h3 class="text-lg font-semibold">${patient.first_name} ${patient.last_name}</h3>
                        ${patient.email ? `<p class="text-gray-600 dark:text-gray-400 text-sm">${patient.email}</p>` : ''}
                        ${patient.phone ? `<p class="text-gray-500 dark:text-gray-500 text-sm">${patient.phone}</p>` : ''}
                    </div>
                </div>
                
                <div class="space-y-2 mb-4">
                    <div class="flex items-center text-sm">
                        <i class="fas fa-birthday-cake w-4 mr-2 text-gray-400"></i>
                        <span>${age}</span>
                    </div>
                    <div class="flex items-center text-sm">
                        <i class="fas fa-calendar w-4 mr-2 text-gray-400"></i>
                        <span>Added: ${new Date(patient.created_at).toLocaleDateString()}</span>
                    </div>
                    <div class="flex items-center text-sm">
                        <i class="fas fa-notes-medical w-4 mr-2 text-gray-400"></i>
                        <span>New patient</span>
                    </div>
                </div>

                <div class="flex items-center justify-between pt-4 border-t border-gray-200 dark:border-gray-700">
                    <span class="px-2 py-1 bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-200 rounded text-sm">
                        ‚ú® New
                    </span>
                    <div class="flex space-x-2">
                        <button onclick="viewPatientDetails('${patient.id}')" class="p-2 text-primary hover:text-secondary rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors" title="View Details">
                            <i class="fas fa-eye"></i>
                        </button>
                        <button onclick="assignPatientToPhysiotherapist('${patient.id}', '${patient.first_name} ${patient.last_name}')" class="p-2 text-green-600 hover:text-green-800 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors" title="Assign to Physiotherapist">
                            <i class="fas fa-user-md"></i>
                        </button>
                        <button onclick="editPatient('${patient.id}')" class="p-2 text-blue-600 hover:text-blue-800 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors" title="Edit Patient">
                            <i class="fas fa-edit"></i>
                        </button>
                    </div>
                </div>
            `;
            
            // Add the new patient card at the beginning of the grid
            patientsGrid.insertBefore(patientCard, patientsGrid.firstChild);
        }

        // Add Appointment Modal Function
        function showAddAppointmentModal() {
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4';
            modal.innerHTML = `
                <div class="bg-white dark:bg-gray-800 rounded-lg shadow-xl max-w-2xl w-full max-h-screen overflow-y-auto">
                    <div class="sticky top-0 bg-white dark:bg-gray-800 border-b border-gray-200 dark:border-gray-700 px-6 py-4">
                        <div class="flex items-center justify-between">
                            <div class="flex items-center">
                                <i class="fas fa-calendar-plus text-primary text-2xl mr-3"></i>
                                <h2 class="text-2xl font-bold">Schedule New Appointment</h2>
                            </div>
                            <button onclick="this.closest('.fixed').remove()" class="text-gray-400 hover:text-gray-600 text-2xl">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                    </div>
                    
                    <form id="addAppointmentForm" class="p-6">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <!-- Appointment Details -->
                            <div class="col-span-full">
                                <h3 class="text-lg font-semibold mb-4 flex items-center">
                                    <i class="fas fa-calendar text-primary mr-2"></i>
                                    Appointment Details
                                </h3>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium mb-2">Patient *</label>
                                <select id="appointmentPatient" required 
                                        class="w-full px-4 py-3 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-base focus:ring-2 focus:ring-primary focus:border-primary">
                                    <option value="">Select a patient...</option>
                                    <option value="dharui-patient">Dharui Fakhroo (Dharui123@gmail.com)</option>
                                </select>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium mb-2">Physiotherapist *</label>
                                <select id="appointmentPhysiotherapist" required 
                                        class="w-full px-4 py-3 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-base focus:ring-2 focus:ring-primary focus:border-primary">
                                    <option value="">Select a physiotherapist...</option>
                                    <option value="mariam-physio-001">Dr. Mariam Abdulatheem Ali</option>
                                    <option value="dhari-physio-001">Dr. Dhari Fakhroo</option>
                                </select>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium mb-2">Date *</label>
                                <input type="date" id="appointmentDate" required 
                                       class="w-full px-4 py-3 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-base focus:ring-2 focus:ring-primary focus:border-primary">
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium mb-2">Time *</label>
                                <input type="time" id="appointmentTime" required 
                                       class="w-full px-4 py-3 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-base focus:ring-2 focus:ring-primary focus:border-primary">
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium mb-2">Duration (minutes)</label>
                                <select id="appointmentDuration" 
                                        class="w-full px-4 py-3 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-base focus:ring-2 focus:ring-primary focus:border-primary">
                                    <option value="30">30 minutes</option>
                                    <option value="45">45 minutes</option>
                                    <option value="60" selected>60 minutes</option>
                                    <option value="90">90 minutes</option>
                                </select>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium mb-2">Appointment Type</label>
                                <select id="appointmentType" 
                                        class="w-full px-4 py-3 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-base focus:ring-2 focus:ring-primary focus:border-primary">
                                    <option value="initial">Initial Assessment</option>
                                    <option value="follow-up" selected>Follow-up Session</option>
                                    <option value="treatment">Treatment Session</option>
                                    <option value="review">Review Session</option>
                                </select>
                            </div>
                            
                            <div class="col-span-full">
                                <label class="block text-sm font-medium mb-2">Notes</label>
                                <textarea id="appointmentNotes" rows="4" 
                                          class="w-full px-4 py-3 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-base focus:ring-2 focus:ring-primary focus:border-primary" 
                                          placeholder="Enter any notes or special instructions for this appointment..."></textarea>
                            </div>
                        </div>
                        
                        <div class="flex justify-end space-x-4 mt-8 pt-6 border-t border-gray-200 dark:border-gray-700">
                            <button type="button" onclick="this.closest('.fixed').remove()" 
                                    class="px-6 py-3 text-gray-600 dark:text-gray-400 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-lg transition-colors">
                                Cancel
                            </button>
                            <button type="submit" 
                                    class="px-6 py-3 bg-primary text-white hover:bg-secondary rounded-lg transition-colors font-medium">
                                <i class="fas fa-calendar-plus mr-2"></i>Schedule Appointment
                            </button>
                        </div>
                    </form>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            // Set default date to tomorrow
            const tomorrow = new Date();
            tomorrow.setDate(tomorrow.getDate() + 1);
            document.getElementById('appointmentDate').value = tomorrow.toISOString().split('T')[0];
            
            // Set default time to 10:00 AM
            document.getElementById('appointmentTime').value = '10:00';
            
            // Handle form submission
            document.getElementById('addAppointmentForm').addEventListener('submit', handleAddAppointment);
        }

        // Handle Add Appointment Form Submission
        async function handleAddAppointment(e) {
            e.preventDefault();
            
            const patientId = document.getElementById('appointmentPatient').value;
            const physiotherapistId = document.getElementById('appointmentPhysiotherapist').value;
            const date = document.getElementById('appointmentDate').value;
            const time = document.getElementById('appointmentTime').value;
            
            if (!patientId || !physiotherapistId || !date || !time) {
                showNotification('Please fill in all required fields', 'error');
                return;
            }
            
            try {
                showLoading();
                
                // Create appointment object
                const appointmentDateTime = new Date(`${date}T${time}`);
                const duration = document.getElementById('appointmentDuration').value;
                const type = document.getElementById('appointmentType').value;
                const notes = document.getElementById('appointmentNotes').value.trim();
                
                const newAppointment = {
                    id: `appointment-${Date.now()}`,
                    patient_id: patientId,
                    physiotherapist_id: physiotherapistId,
                    appointment_date: appointmentDateTime.toISOString(),
                    duration: parseInt(duration),
                    type: type,
                    status: 'scheduled',
                    notes: notes || 'Regular appointment scheduled by administrator',
                    created_at: new Date().toISOString(),
                    patient_name: patientId === 'dharui-patient' ? 'Dharui Fakhroo' : 'Unknown Patient',
                    physiotherapist_name: physiotherapistId === 'mariam-physio-001' ? 'Dr. Mariam Abdulatheem Ali' : 'Dr. Dhari Fakhroo'
                };
                
                // Store appointment in local array for demo
                if (!window.appointments) {
                    window.appointments = [];
                }
                window.appointments.push(newAppointment);
                
                // Add appointment to the appointments view
                addAppointmentToView(newAppointment);
                
                // Close modal
                document.querySelector('.fixed').remove();
                
                hideLoading();
                
                const appointmentDateStr = appointmentDateTime.toLocaleDateString();
                const appointmentTimeStr = appointmentDateTime.toLocaleTimeString('en-US', {
                    hour: '2-digit',
                    minute: '2-digit'
                });
                
                showNotification(`‚úÖ Appointment scheduled successfully for ${appointmentDateStr} at ${appointmentTimeStr}!`, 'success');
                
                // Update appointment count in dashboard
                const appointmentsTodayElement = document.getElementById('appointmentsToday');
                if (appointmentsTodayElement) {
                    const currentCount = parseInt(appointmentsTodayElement.textContent) || 8;
                    appointmentsTodayElement.textContent = currentCount + 1;
                }
                
                console.log('New appointment created:', newAppointment);
                
            } catch (error) {
                console.error('Error creating appointment:', error);
                showNotification('Error creating appointment: ' + error.message, 'error');
                hideLoading();
            }
        }

        // Add Appointment to View
        function addAppointmentToView(appointment) {
            const appointmentsView = document.getElementById('appointments');
            if (!appointmentsView) return;
            
            // Find the existing appointment container or create new one
            let appointmentsContainer = appointmentsView.querySelector('.appointments-list');
            if (!appointmentsContainer) {
                appointmentsContainer = document.createElement('div');
                appointmentsContainer.className = 'appointments-list space-y-4';
                // Add after the title and button
                const existingContent = appointmentsView.querySelector('.bg-white.dark\\:bg-gray-800.rounded-lg.shadow-lg.p-6');
                if (existingContent) {
                    existingContent.parentNode.insertBefore(appointmentsContainer, existingContent);
                } else {
                    appointmentsView.appendChild(appointmentsContainer);
                }
            }
            
            const appointmentDate = new Date(appointment.appointment_date);
            const appointmentTime = appointmentDate.toLocaleTimeString('en-US', {
                hour: '2-digit',
                minute: '2-digit'
            });
            const appointmentDateStr = appointmentDate.toLocaleDateString();
            
            // Create appointment card
            const appointmentCard = document.createElement('div');
            appointmentCard.className = 'bg-white dark:bg-gray-800 rounded-lg shadow-lg p-6 border-l-4 border-blue-500';
            appointmentCard.innerHTML = `
                <div class="flex items-center justify-between mb-4">
                    <div class="flex items-center space-x-4">
                        <div class="w-12 h-12 bg-blue-500 rounded-full flex items-center justify-center text-white font-bold">
                            ${appointment.patient_name.split(' ').map(n => n.charAt(0)).join('')}
                        </div>
                        <div>
                            <h4 class="font-semibold">${appointment.patient_name}</h4>
                            <p class="text-gray-600 dark:text-gray-400 text-sm">${appointment.physiotherapist_name}</p>
                            <p class="text-gray-500 text-sm">${appointmentDateStr}, ${appointmentTime} (${appointment.duration} min)</p>
                        </div>
                    </div>
                    <span class="px-3 py-1 bg-blue-100 text-blue-800 dark:bg-blue-900 dark:text-blue-200 rounded-full text-sm">‚ú® New</span>
                </div>
                <p class="text-gray-600 dark:text-gray-400 text-sm">${appointment.notes}</p>
            `;
            
            // Add the new appointment card at the beginning
            appointmentsContainer.insertBefore(appointmentCard, appointmentsContainer.firstChild);
        }

        // Add Physiotherapist Modal Function
        function showAddPhysiotherapistModal() {
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4';
            modal.innerHTML = `
                <div class="bg-white dark:bg-gray-800 rounded-lg shadow-xl max-w-2xl w-full max-h-screen overflow-y-auto">
                    <div class="sticky top-0 bg-white dark:bg-gray-800 border-b border-gray-200 dark:border-gray-700 px-6 py-4">
                        <div class="flex items-center justify-between">
                            <div class="flex items-center">
                                <i class="fas fa-user-md text-primary text-2xl mr-3"></i>
                                <h2 class="text-2xl font-bold">Add New Physiotherapist</h2>
                            </div>
                            <button onclick="this.closest('.fixed').remove()" class="text-gray-400 hover:text-gray-600 text-2xl">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                    </div>
                    
                    <form id="addPhysiotherapistForm" class="p-6">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <!-- Personal Information -->
                            <div class="col-span-full">
                                <h3 class="text-lg font-semibold mb-4 flex items-center">
                                    <i class="fas fa-user text-primary mr-2"></i>
                                    Personal Information
                                </h3>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium mb-2">First Name *</label>
                                <input type="text" id="physioFirstName" required 
                                       class="w-full px-4 py-3 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-base focus:ring-2 focus:ring-primary focus:border-primary" 
                                       placeholder="Enter first name">
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium mb-2">Last Name *</label>
                                <input type="text" id="physioLastName" required 
                                       class="w-full px-4 py-3 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-base focus:ring-2 focus:ring-primary focus:border-primary" 
                                       placeholder="Enter last name">
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium mb-2">Email *</label>
                                <input type="email" id="physioEmail" required 
                                       class="w-full px-4 py-3 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-base focus:ring-2 focus:ring-primary focus:border-primary" 
                                       placeholder="physiotherapist@email.com">
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium mb-2">Phone Number</label>
                                <input type="tel" id="physioPhone" 
                                       class="w-full px-4 py-3 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-base focus:ring-2 focus:ring-primary focus:border-primary" 
                                       placeholder="97123456">
                            </div>
                            
                            <!-- Professional Information -->
                            <div class="col-span-full">
                                <h3 class="text-lg font-semibold mb-4 flex items-center mt-4">
                                    <i class="fas fa-stethoscope text-primary mr-2"></i>
                                    Professional Information
                                </h3>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium mb-2">License Number *</label>
                                <input type="text" id="physioLicense" required 
                                       class="w-full px-4 py-3 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-base focus:ring-2 focus:ring-primary focus:border-primary" 
                                       placeholder="PT-2024-XX">
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium mb-2">Years of Experience</label>
                                <input type="number" id="physioExperience" min="0" max="50" 
                                       class="w-full px-4 py-3 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-base focus:ring-2 focus:ring-primary focus:border-primary" 
                                       placeholder="0">
                            </div>
                            
                            <div class="col-span-full">
                                <label class="block text-sm font-medium mb-2">Specializations</label>
                                <div class="grid grid-cols-2 md:grid-cols-3 gap-3">
                                    <label class="flex items-center">
                                        <input type="checkbox" value="Orthopedic" class="physio-specialization mr-2">
                                        <span class="text-sm">Orthopedic</span>
                                    </label>
                                    <label class="flex items-center">
                                        <input type="checkbox" value="Sports Medicine" class="physio-specialization mr-2">
                                        <span class="text-sm">Sports Medicine</span>
                                    </label>
                                    <label class="flex items-center">
                                        <input type="checkbox" value="Neurological" class="physio-specialization mr-2">
                                        <span class="text-sm">Neurological</span>
                                    </label>
                                    <label class="flex items-center">
                                        <input type="checkbox" value="Pediatric" class="physio-specialization mr-2">
                                        <span class="text-sm">Pediatric</span>
                                    </label>
                                    <label class="flex items-center">
                                        <input type="checkbox" value="Geriatric" class="physio-specialization mr-2">
                                        <span class="text-sm">Geriatric</span>
                                    </label>
                                    <label class="flex items-center">
                                        <input type="checkbox" value="Manual Therapy" class="physio-specialization mr-2">
                                        <span class="text-sm">Manual Therapy</span>
                                    </label>
                                </div>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium mb-2">Employment Status</label>
                                <select id="physioEmploymentStatus" 
                                        class="w-full px-4 py-3 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-base focus:ring-2 focus:ring-primary focus:border-primary">
                                    <option value="full-time">Full-time</option>
                                    <option value="part-time">Part-time</option>
                                    <option value="contract">Contract</option>
                                </select>
                            </div>
                        </div>
                        
                        <div class="flex justify-end space-x-4 mt-8 pt-6 border-t border-gray-200 dark:border-gray-700">
                            <button type="button" onclick="this.closest('.fixed').remove()" 
                                    class="px-6 py-3 text-gray-600 dark:text-gray-400 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-lg transition-colors">
                                Cancel
                            </button>
                            <button type="submit" 
                                    class="px-6 py-3 bg-primary text-white hover:bg-secondary rounded-lg transition-colors font-medium">
                                <i class="fas fa-user-md mr-2"></i>Add Physiotherapist
                            </button>
                        </div>
                    </form>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            // Handle form submission
            document.getElementById('addPhysiotherapistForm').addEventListener('submit', handleAddPhysiotherapist);
        }

        // Handle Add Physiotherapist Form Submission
        async function handleAddPhysiotherapist(e) {
            e.preventDefault();
            
            const firstName = document.getElementById('physioFirstName').value.trim();
            const lastName = document.getElementById('physioLastName').value.trim();
            const email = document.getElementById('physioEmail').value.trim();
            const license = document.getElementById('physioLicense').value.trim();
            
            if (!firstName || !lastName || !email || !license) {
                showNotification('Please fill in all required fields', 'error');
                return;
            }
            
            try {
                showLoading();
                
                // Get selected specializations
                const specializations = [];
                document.querySelectorAll('.physio-specialization:checked').forEach(checkbox => {
                    specializations.push(checkbox.value);
                });
                
                // Create physiotherapist object
                const newPhysiotherapist = {
                    id: `physio-${Date.now()}`,
                    first_name: firstName,
                    last_name: lastName,
                    email: email,
                    phone: document.getElementById('physioPhone').value.trim(),
                    license_number: license,
                    years_experience: parseInt(document.getElementById('physioExperience').value) || 0,
                    specializations: specializations,
                    employment_status: document.getElementById('physioEmploymentStatus').value,
                    is_active: true,
                    created_at: new Date().toISOString()
                };
                
                // Store physiotherapist in local array for demo
                if (!window.physiotherapists) {
                    window.physiotherapists = [];
                }
                window.physiotherapists.push(newPhysiotherapist);
                
                // Add physiotherapist card to the grid
                addPhysiotherapistToGrid(newPhysiotherapist);
                
                // Close modal
                document.querySelector('.fixed').remove();
                
                hideLoading();
                
                showNotification(`‚úÖ Physiotherapist "Dr. ${firstName} ${lastName}" has been added successfully!`, 'success');
                
                console.log('New physiotherapist added:', newPhysiotherapist);
                
            } catch (error) {
                console.error('Error adding physiotherapist:', error);
                showNotification('Error adding physiotherapist: ' + error.message, 'error');
                hideLoading();
            }
        }

        // Add Physiotherapist Card to Grid
        function addPhysiotherapistToGrid(physiotherapist) {
            const physiotherapistsGrid = document.getElementById('physiotherapistsGrid');
            if (!physiotherapistsGrid) return;
            
            // Create initials
            const initials = (physiotherapist.first_name.charAt(0) + physiotherapist.last_name.charAt(0)).toUpperCase();
            
            // Create specializations text
            const specializations = physiotherapist.specializations.length > 0 
                ? physiotherapist.specializations.join(', ') 
                : 'General Practice';
            
            // Create physiotherapist card
            const physiotherapistCard = document.createElement('div');
            physiotherapistCard.className = 'bg-white dark:bg-gray-800 rounded-lg shadow-lg p-6 hover:shadow-xl transition-shadow border-l-4 border-purple-500';
            physiotherapistCard.innerHTML = `
                <div class="flex items-center mb-4">
                    <div class="w-16 h-16 bg-purple-500 rounded-full flex items-center justify-center text-white font-bold text-xl mr-4">
                        ${initials}
                    </div>
                    <div>
                        <h3 class="text-lg font-semibold">Dr. ${physiotherapist.first_name} ${physiotherapist.last_name}</h3>
                        <p class="text-gray-600 dark:text-gray-400 text-sm">${specializations}</p>
                        <p class="text-gray-500 text-sm">${physiotherapist.years_experience} years experience</p>
                    </div>
                </div>
                
                <div class="space-y-2 mb-4">
                    <div class="flex items-center text-sm">
                        <i class="fas fa-envelope w-4 mr-2 text-gray-400"></i>
                        <span>${physiotherapist.email}</span>
                    </div>
                    ${physiotherapist.phone ? `
                        <div class="flex items-center text-sm">
                            <i class="fas fa-phone w-4 mr-2 text-gray-400"></i>
                            <span>${physiotherapist.phone}</span>
                        </div>
                    ` : ''}
                    <div class="flex items-center text-sm">
                        <i class="fas fa-id-card w-4 mr-2 text-gray-400"></i>
                        <span>License: ${physiotherapist.license_number}</span>
                    </div>
                </div>

                <div class="flex items-center justify-between pt-4 border-t border-gray-200 dark:border-gray-700">
                    <span class="px-2 py-1 bg-purple-100 text-purple-800 dark:bg-purple-900 dark:text-purple-200 rounded text-sm">
                        ‚ú® New
                    </span>
                    <div class="flex space-x-2">
                        <button onclick="editPhysiotherapist('${physiotherapist.id}')" class="p-2 text-blue-600 hover:text-blue-800 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors" title="Edit">
                            <i class="fas fa-edit"></i>
                        </button>
                    </div>
                </div>
            `;
            
            // Add the new physiotherapist card at the beginning of the grid
            physiotherapistsGrid.insertBefore(physiotherapistCard, physiotherapistsGrid.firstChild);
        }

        // Supabase Connection Modal Function
        function showSupabaseConnectionModal() {
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4';
            modal.innerHTML = `
                <div class="bg-white dark:bg-gray-800 rounded-lg shadow-xl max-w-lg w-full max-h-screen overflow-y-auto">
                    <div class="sticky top-0 bg-white dark:bg-gray-800 border-b border-gray-200 dark:border-gray-700 px-6 py-4">
                        <div class="flex items-center justify-between">
                            <div class="flex items-center">
                                <i class="fas fa-database text-primary text-2xl mr-3"></i>
                                <h2 class="text-2xl font-bold">Connect to Supabase</h2>
                            </div>
                            <button onclick="this.closest('.fixed').remove()" class="text-gray-400 hover:text-gray-600 text-2xl">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                    </div>
                    
                    <div class="p-6">
                        <div class="bg-blue-50 dark:bg-blue-900/20 border border-blue-200 dark:border-blue-800 rounded-lg p-4 mb-6">
                            <div class="flex items-start">
                                <i class="fas fa-info-circle text-blue-600 text-lg mr-3 mt-0.5"></i>
                                <div>
                                    <h4 class="font-medium text-blue-900 dark:text-blue-100 mb-2">Database Connection</h4>
                                    <p class="text-sm text-blue-800 dark:text-blue-200">Connect your Supabase database to enable real-time data synchronization, persistent storage, and multi-user access for your PhysioTech system.</p>
                                </div>
                            </div>
                        </div>
                        
                        <form id="supabaseConnectionForm">
                            <div class="space-y-4">
                                <div>
                                    <label class="block text-sm font-medium mb-2">Supabase Project URL *</label>
                                    <div class="relative">
                                        <input type="url" id="supabaseUrl" required 
                                               class="w-full px-4 py-3 pl-12 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-base focus:ring-2 focus:ring-primary focus:border-primary" 
                                               placeholder="https://your-project.supabase.co">
                                        <i class="fas fa-globe absolute left-4 top-4 text-gray-400"></i>
                                    </div>
                                </div>
                                
                                <div>
                                    <label class="block text-sm font-medium mb-2">Supabase Anon Key *</label>
                                    <div class="relative">
                                        <input type="password" id="supabaseKey" required 
                                               class="w-full px-4 py-3 pl-12 pr-12 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-base focus:ring-2 focus:ring-primary focus:border-primary" 
                                               placeholder="eyJhbGciOiJIUzI1NiIsInR5cCI6...">
                                        <i class="fas fa-key absolute left-4 top-4 text-gray-400"></i>
                                        <button type="button" id="toggleSupabaseKey" class="absolute right-4 top-4 text-gray-400 hover:text-gray-600 focus:outline-none">
                                            <i class="fas fa-eye"></i>
                                        </button>
                                    </div>
                                </div>
                                
                                <div class="bg-amber-50 dark:bg-amber-900/20 border border-amber-200 dark:border-amber-800 rounded-lg p-4">
                                    <div class="flex items-start">
                                        <i class="fas fa-shield-alt text-amber-600 text-lg mr-3 mt-0.5"></i>
                                        <div>
                                            <h4 class="font-medium text-amber-900 dark:text-amber-100 mb-1">Security Note</h4>
                                            <p class="text-sm text-amber-800 dark:text-amber-200">Your database credentials are stored securely and only used for establishing the connection. We recommend using the anon key with Row Level Security enabled.</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="flex justify-end space-x-4 mt-8 pt-6 border-t border-gray-200 dark:border-gray-700">
                                <button type="button" onclick="this.closest('.fixed').remove()" 
                                        class="px-6 py-3 text-gray-600 dark:text-gray-400 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-lg transition-colors">
                                    Cancel
                                </button>
                                <button type="submit" 
                                        class="px-6 py-3 bg-primary text-white hover:bg-secondary rounded-lg transition-colors font-medium">
                                    <i class="fas fa-plug mr-2"></i>Connect Database
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            // Toggle password visibility for Supabase key
            document.getElementById('toggleSupabaseKey').addEventListener('click', () => {
                const keyInput = document.getElementById('supabaseKey');
                const toggleIcon = document.querySelector('#toggleSupabaseKey i');
                
                if (keyInput.type === 'password') {
                    keyInput.type = 'text';
                    toggleIcon.classList.remove('fa-eye');
                    toggleIcon.classList.add('fa-eye-slash');
                } else {
                    keyInput.type = 'password';
                    toggleIcon.classList.remove('fa-eye-slash');
                    toggleIcon.classList.add('fa-eye');
                }
            });
            
            // Handle form submission
            document.getElementById('supabaseConnectionForm').addEventListener('submit', handleSupabaseConnection);
        }

        // Handle Supabase Connection
        async function handleSupabaseConnection(e) {
            e.preventDefault();
            
            const url = document.getElementById('supabaseUrl').value.trim();
            const key = document.getElementById('supabaseKey').value.trim();
            
            if (!url || !key) {
                showNotification('Please provide both URL and API key', 'error');
                return;
            }
            
            try {
                showLoading();
                
                console.log('Attempting to connect to Supabase...');
                
                // Initialize Supabase client
                if (typeof window.supabase === 'undefined' && window.createClient) {
                    supabase = window.createClient(url, key);
                } else if (window.supabase && window.supabase.createClient) {
                    supabase = window.supabase.createClient(url, key);
                } else {
                    throw new Error('Supabase library not loaded properly');
                }
                
                // Test connection by attempting to fetch from a test query
                const { data, error } = await supabase
                    .from('patients')
                    .select('count')
                    .limit(1);
                
                if (error && !error.message.includes('relation "patients" does not exist')) {
                    throw error;
                }
                
                // Store connection details
                connectionDetails = { url, key };
                
                // Update connection status in UI
                updateConnectionStatus(true);
                
                // Close modal
                document.querySelector('.fixed').remove();
                
                hideLoading();
                
                showNotification('‚úÖ Successfully connected to Supabase database! Real-time data synchronization is now active.', 'success');
                
                // Try to load data from Supabase
                await loadDataFromSupabase();
                
            } catch (error) {
                console.error('Supabase connection error:', error);
                hideLoading();
                
                // Show specific error message
                if (error.message.includes('Invalid API key') || error.message.includes('JWT')) {
                    showNotification('‚ùå Invalid Supabase API key. Please check your credentials.', 'error');
                } else if (error.message.includes('fetch') || error.message.includes('network')) {
                    showNotification('‚ùå Network error. Please check your internet connection and URL.', 'error');
                } else if (error.message.includes('relation') && error.message.includes('does not exist')) {
                    // Tables don't exist yet, but connection is successful
                    connectionDetails = { url, key };
                    updateConnectionStatus(true);
                    document.querySelector('.fixed').remove();
                    showNotification('‚úÖ Connected to Supabase! Database tables will be created automatically as you use the system.', 'success');
                } else {
                    showNotification('‚ùå Connection failed: ' + error.message, 'error');
                }
            }
        }

        // Update Connection Status in UI
        function updateConnectionStatus(isConnected) {
            try {
                const statusElement = document.getElementById('connectionStatus');
                const connectButton = document.getElementById('connectSupabase');
                
                if (!statusElement || !connectButton) {
                    console.error('Connection status elements not found');
                    return;
                }
                
                if (isConnected) {
                    statusElement.innerHTML = '<i class="fas fa-circle text-green-400 mr-1"></i>Connected';
                    connectButton.innerHTML = '<i class="fas fa-database mr-2"></i>Connected';
                    connectButton.classList.remove('bg-white', 'text-primary', 'hover:bg-gray-100');
                    connectButton.classList.add('bg-green-500', 'text-white', 'hover:bg-green-600');
                    connectButton.title = 'Database connected successfully';
                } else {
                    statusElement.innerHTML = '<i class="fas fa-circle text-red-400 mr-1"></i>Disconnected';
                    connectButton.innerHTML = '<i class="fas fa-database mr-2"></i>Connect Supabase';
                    connectButton.classList.remove('bg-green-500', 'text-white', 'hover:bg-green-600');
                    connectButton.classList.add('bg-white', 'text-primary', 'hover:bg-gray-100');
                    connectButton.title = 'Click to connect database';
                }
            } catch (error) {
                console.error('Error updating connection status:', error);
            }
        }

        // Load Data from Supabase
        async function loadDataFromSupabase() {
            if (!supabase) return;
            
            try {
                console.log('Loading data from Supabase...');
                
                // Try to load patients
                const { data: patients, error: patientsError } = await supabase
                    .from('patients')
                    .select('*')
                    .limit(10);
                
                if (patientsError && !patientsError.message.includes('does not exist')) {
                    console.error('Error loading patients:', patientsError);
                } else if (patients && patients.length > 0) {
                    console.log('Loaded patients from Supabase:', patients.length);
                    showNotification(`üìä Loaded ${patients.length} patients from your database!`, 'success');
                    
                    // Update patient count
                    const totalPatientsElement = document.getElementById('totalPatients');
                    if (totalPatientsElement) {
                        totalPatientsElement.textContent = patients.length;
                    }
                }
                
                // Try to load appointments
                const { data: appointments, error: appointmentsError } = await supabase
                    .from('appointments')
                    .select('*')
                    .limit(10);
                
                if (appointmentsError && !appointmentsError.message.includes('does not exist')) {
                    console.error('Error loading appointments:', appointmentsError);
                } else if (appointments && appointments.length > 0) {
                    console.log('Loaded appointments from Supabase:', appointments.length);
                    showNotification(`üìÖ Loaded ${appointments.length} appointments from your database!`, 'success');
                }
                
            } catch (error) {
                console.error('Error loading data from Supabase:', error);
                showNotification('‚ö†Ô∏è Connected to database but some tables may not exist yet. They will be created as you add data.', 'success');
            }
        }
    </script>
</body>
</html>
